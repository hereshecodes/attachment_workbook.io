<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script>
        // Initialize CONFIG - will be overridden by config.js if it loads
        var CONFIG = { ANTHROPIC_API_KEY: "YOUR_ANTHROPIC_API_KEY_HERE" };
    </script>
    <script src="config.js" onerror="console.log('Note: config.js not loaded (this is normal when opening file directly). AI features will use embedded config or be disabled.')"></script>
</head>
<body>
    <h1>Relationship Styles</h1>
    <p class="subtitle">A shared space for understanding each other</p>

    <!-- 1. ROOM BAR (Sticky) -->
    <div class="room-bar" id="room-bar">
        <div class="room-bar-top">
            <div class="room-identity">
                <div class="connection-dot" id="connection-dot"></div>
                <div class="room-name-display">
                    <span class="room-name" id="room-name">Our Space</span>
                    <button class="room-name-edit" onclick="editRoomName()">âœï¸</button>
                    <input type="text" class="room-name-input" id="room-name-input" maxlength="20" onblur="saveRoomName()" onkeypress="if(event.key==='Enter')saveRoomName()">
                </div>
                <span class="identity-badge" id="identity-badge" style="display: none;"></span>
            </div>
            <div class="share-actions">
                <button class="share-btn" onclick="openPersonalizationSettings()">âš™ï¸ Settings</button>
                <button class="share-btn" onclick="openShareModal()">ğŸ“¤ Share</button>
                <button class="share-btn" onclick="createNewRoom()">+ New Room</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-title">Share This Space</div>
            <div class="share-modal-subtitle">Send this link to your partner so you can connect</div>
            <div class="qr-code" id="qr-code"></div>
            <div class="share-link-box">
                <input type="text" class="share-link-input" id="share-link" readonly>
                <button class="copy-link-btn" onclick="copyLink()">Copy</button>
            </div>
            <div class="share-options">
                <button class="share-option-btn" onclick="shareViaText()">ğŸ’¬ Text</button>
                <button class="share-option-btn" onclick="shareViaEmail()">ğŸ“§ Email</button>
            </div>
            <button class="close-modal-btn" onclick="closeShareModal()">Done</button>
        </div>
    </div>

    <!-- First-Time User Tutorial -->
    <div class="tutorial-modal" id="tutorial-modal" style="display: none;">
        <div class="tutorial-content">
            <button class="skip-tutorial-btn" onclick="skipTutorial()">Skip</button>

            <div class="tutorial-step" id="tutorial-step-1">
                <div class="tutorial-icon">ğŸ’•</div>
                <div class="tutorial-title">Welcome to Your Shared Space</div>
                <div class="tutorial-text">
                    This is a private space designed to help you and your partner communicate emotional needs in real-timeâ€”especially during difficult moments when finding the right words feels hard.
                </div>
                <div class="tutorial-progress">
                    <span class="dot active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <button class="tutorial-next-btn" onclick="nextTutorialStep()">Next</button>
            </div>

            <div class="tutorial-step" id="tutorial-step-2" style="display: none;">
                <div class="tutorial-icon">ğŸŒŠ</div>
                <div class="tutorial-title">Share How You Feel</div>
                <div class="tutorial-text">
                    Tap a mood button to instantly let your partner know how you're feeling. They'll see your update on their device in real-time, along with guidance on how to support you.
                </div>
                <div class="tutorial-example">
                    <div class="example-mood">ğŸ˜° "Feeling anxious"</div>
                    <div class="example-arrow">â†’</div>
                    <div class="example-result">Partner sees: "She's being vulnerable. A heart emoji or 'I'm here' goes far."</div>
                </div>
                <div class="tutorial-progress">
                    <span class="dot"></span>
                    <span class="dot active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <button class="tutorial-next-btn" onclick="nextTutorialStep()">Next</button>
            </div>

            <div class="tutorial-step" id="tutorial-step-3" style="display: none;">
                <div class="tutorial-icon">ğŸ“…</div>
                <div class="tutorial-title">Track Patterns Together</div>
                <div class="tutorial-text">
                    Your mood history calendar shows patterns over time. The AI can analyze these patterns to give you insights about your relationship dynamics and celebrate your growth.
                </div>
                <div class="tutorial-features">
                    <div class="feature-item">âœ¨ AI-powered insights</div>
                    <div class="feature-item">ğŸ“Š Weekly reflections</div>
                    <div class="feature-item">ğŸ’¬ Message helper</div>
                </div>
                <div class="tutorial-progress">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot active"></span>
                    <span class="dot"></span>
                </div>
                <button class="tutorial-next-btn" onclick="nextTutorialStep()">Next</button>
            </div>

            <div class="tutorial-step" id="tutorial-step-4" style="display: none;">
                <div class="tutorial-icon">ğŸ”—</div>
                <div class="tutorial-title">Share With Your Partner</div>
                <div class="tutorial-text">
                    This room is just for the two of you. Share the link with your partner so you can both check in and see each other's status. Your data stays private to your unique room.
                </div>
                <div class="tutorial-tip">
                    ğŸ’¡ Tip: Bookmark this page so you can easily come back to it!
                </div>
                <div class="tutorial-progress">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot active"></span>
                </div>
                <button class="tutorial-done-btn" onclick="closeTutorial()">Get Started</button>
            </div>
        </div>
    </div>

    <!-- 2. WELCOME / IDENTITY SELECTOR -->
    <div class="welcome-card" id="welcome-card">
        <div class="welcome-title">Welcome</div>
        <div class="welcome-subtitle">Who's checking in?</div>
        <div class="identity-buttons">
            <button class="identity-btn me" onclick="selectIdentity('me')">I'm Her</button>
            <button class="identity-btn you" onclick="selectIdentity('you')">I'm Him</button>
        </div>
        <div class="returning-user-note" id="returning-note">
            âœ“ Welcome back! We remembered your room.
        </div>
    </div>

    <!-- ATTACHMENT STYLE ONBOARDING -->
    <div class="attachment-onboarding" id="attachment-onboarding" style="display: none;">
        <div class="onboarding-content">
            <div class="onboarding-title">Let's personalize your experience</div>
            <div class="onboarding-subtitle">Understanding your attachment style helps us provide better guidance</div>

            <div class="attachment-quiz">
                <div class="quiz-question">
                    <div class="question-number">Question 1 of 3</div>
                    <div class="question-text" id="quiz-question-text">In relationships, I tend to...</div>
                    <div class="quiz-options" id="quiz-options">
                        <!-- Options will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="attachment-results" id="attachment-results" style="display: none;">
                <div class="results-title">Your Attachment Style</div>
                <div class="style-badge" id="style-badge"></div>
                <div class="style-description" id="style-description"></div>
                <div class="style-strengths" id="style-strengths"></div>
                <div class="style-growth" id="style-growth"></div>
                <button class="continue-btn" onclick="completeOnboarding()">Continue to App</button>
            </div>
        </div>
    </div>

    <!-- ATTACHMENT STYLE SETTINGS (accessible later) -->
    <div class="attachment-settings-modal" id="attachment-settings-modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="settings-header">
                <div class="settings-title">Attachment Style Settings</div>
                <button class="close-settings-btn" onclick="closeAttachmentSettings()">âœ•</button>
            </div>

            <div class="settings-body">
                <div class="setting-section">
                    <div class="setting-label">Your Attachment Style</div>
                    <select class="attachment-select" id="my-attachment-select" onchange="updateAttachmentStyle('me', this.value)">
                        <option value="anxious">Anxious (Connection-Seeking)</option>
                        <option value="avoidant">Avoidant (Autonomy-Valuing)</option>
                        <option value="secure">Secure (Balanced)</option>
                        <option value="fearful">Fearful-Avoidant (Mixed)</option>
                    </select>
                    <div class="setting-description" id="my-style-description"></div>
                </div>

                <div class="setting-section">
                    <div class="setting-label">Partner's Attachment Style</div>
                    <select class="attachment-select" id="partner-attachment-select" onchange="updateAttachmentStyle('you', this.value)">
                        <option value="anxious">Anxious (Connection-Seeking)</option>
                        <option value="avoidant">Avoidant (Autonomy-Valuing)</option>
                        <option value="secure">Secure (Balanced)</option>
                        <option value="fearful">Fearful-Avoidant (Mixed)</option>
                    </select>
                    <div class="setting-description" id="partner-style-description"></div>
                </div>

                <div class="setting-section">
                    <div class="setting-label">Display Names</div>
                    <div class="name-inputs">
                        <input type="text" class="name-input" id="my-name-input" placeholder="Your name (e.g., Alex)" maxlength="15">
                        <input type="text" class="name-input" id="partner-name-input" placeholder="Partner's name (e.g., Sam)" maxlength="15">
                    </div>
                </div>

                <div class="setting-section">
                    <div class="setting-label">Your Pronouns</div>
                    <select class="pronoun-select" id="my-pronoun-select">
                        <option value="she/her">she/her</option>
                        <option value="he/him">he/him</option>
                        <option value="they/them">they/them</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" class="custom-pronoun-input" id="my-custom-pronoun" placeholder="Enter custom pronouns" style="display: none;" maxlength="20">
                </div>

                <div class="setting-section">
                    <div class="setting-label">Partner's Pronouns</div>
                    <select class="pronoun-select" id="partner-pronoun-select">
                        <option value="she/her">she/her</option>
                        <option value="he/him">he/him</option>
                        <option value="they/them">they/them</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" class="custom-pronoun-input" id="partner-custom-pronoun" placeholder="Enter custom pronouns" style="display: none;" maxlength="20">
                </div>
            </div>

            <button class="save-settings-btn" onclick="savePersonalizationSettings()">Save Changes</button>
        </div>
    </div>

    <!-- 3. LIVE STATUS CARDS -->
    <div class="status-section">
        <div class="live-status">
            <div class="live-status-card me-card">
                <div class="live-status-name">Her</div>
                <div class="live-status-mood" id="live-mood-me">No status yet</div>
                <div class="live-status-time" id="live-time-me"></div>
            </div>
            <div class="live-status-card you-card">
                <div class="live-status-name">Him</div>
                <div class="live-status-mood" id="live-mood-you">No status yet</div>
                <div class="live-status-time" id="live-time-you"></div>
            </div>
        </div>
    </div>

    <!-- 4. MOOD SELECTOR -->
    <div class="mood-section" id="mood-section">
        <div class="mood-header">How are you feeling right now?</div>
        <div class="mood-buttons" id="mood-buttons"></div>
        
        <div class="note-box" id="note-box">
            <label>Add a personal note (optional)</label>
            <textarea id="note-input" placeholder="Anything else you want to share..."></textarea>
            <div class="note-actions">
                <button class="ai-rephrase-btn" onclick="improveMessage()">âœ¨ Help me say this better</button>
                <button class="send-note-btn" onclick="sendNote()">Send Note</button>
            </div>
            <div class="ai-suggestion" id="ai-suggestion">
                <div class="ai-suggestion-label">ğŸ’­ Suggested rephrasing:</div>
                <div class="ai-suggestion-text" id="ai-suggestion-text"></div>
                <div class="suggestion-actions">
                    <button class="use-btn" onclick="useSuggestion()">Use this</button>
                    <button class="dismiss-btn" onclick="dismissSuggestion()">Keep mine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ALERTS & PARTNER MESSAGE -->
    <div class="alert-section" id="alert-section">
        <div class="combo-alert" id="combo-alert">
            <div class="combo-alert-title">ğŸ’« A Familiar Moment</div>
            <div class="combo-alert-text" id="combo-alert-text"></div>
        </div>
        
        <div class="partner-message" id="partner-message">
            <div class="partner-message-label" id="partner-message-label">Message from your partner</div>
            <div class="partner-message-text" id="partner-message-text"></div>
            <button class="understand-btn" onclick="helpMeUnderstand()">ğŸ¤” Help me understand</button>
            <div class="understand-response" id="understand-response">
                <div class="understand-text" id="understand-text"></div>
            </div>
        </div>
    </div>

    <!-- 6. CONTEXTUAL INSIGHT -->
    <div class="insight-panel" id="insight-panel">
        <div class="insight-header">
            <div class="insight-title" id="insight-title">Understanding This Moment</div>
            <button class="insight-close" onclick="closeInsight()">âœ•</button>
        </div>
        <div class="insight-grid">
            <div class="insight-card for-me">
                <h4 id="insight-label-1">Reminder for Me</h4>
                <p id="insight-text-1"></p>
            </div>
            <div class="insight-card for-you">
                <h4 id="insight-label-2">What They'll See</h4>
                <p id="insight-text-2"></p>
            </div>
        </div>
    </div>

    <!-- 7. AI INSIGHTS & WEEKLY -->
    <div class="ai-section">
        <div class="ai-card">
            <div class="ai-card-header">
                <span class="ai-card-icon">âœ¨</span>
                <span class="ai-card-title">Pattern Insights</span>
                <button class="refresh-btn" onclick="generateInsights()">Refresh</button>
            </div>
            <div class="ai-loading" id="insights-loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
            <div class="ai-card-content" id="ai-insights-text">
                Select your identity to see personalized insights.
            </div>
        </div>
        <div class="ai-card weekly">
            <div class="ai-card-header">
                <span class="ai-card-icon">ğŸ“</span>
                <span class="ai-card-title">This Week</span>
            </div>
            <div class="ai-loading" id="weekly-loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
            <div class="ai-card-content" id="weekly-text">
                Your weekly reflection will appear once you have some mood history.
            </div>
        </div>
    </div>

    <!-- 8. MOOD CALENDAR (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">ğŸ“…</span>
                <span class="collapsible-title">Mood History</span>
            </div>
            <span class="collapsible-toggle">â–¼</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="calendar-legend">
                    <span class="legend-item"><span class="emoji">ğŸŒ¿</span> Space</span>
                    <span class="legend-item"><span class="emoji">ğŸŒŠ</span> Anxious/Overwhelmed</span>
                    <span class="legend-item"><span class="emoji">ğŸŒ«ï¸</span> Disconnected</span>
                    <span class="legend-item"><span class="emoji">ğŸŒ¸</span> Reconnect</span>
                    <span class="legend-item"><span class="emoji">â˜€ï¸</span> All Good</span>
                </div>
                <div class="month-navigation">
                    <button class="month-nav-btn" onclick="previousMonth()">â—€ Previous</button>
                    <span class="current-month" id="current-month">December 2025</span>
                    <button class="month-nav-btn" onclick="nextMonth()">Next â–¶</button>
                    <button class="month-nav-btn" onclick="updateMoodCalendar(moodHistory)" style="margin-left: 12px;">ğŸ”„ Refresh</button>
                </div>
                <div class="calendar-container" id="mood-calendar">
                    <div class="no-history">No mood history yet. Start sharing how you feel!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. VENN DIAGRAM (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">â™¡</span>
                <span class="collapsible-title">About Us</span>
            </div>
            <span class="collapsible-toggle">â–¼</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="venn-container">
                    <div class="circle circle-me"></div>
                    <div class="circle circle-you"></div>

                    <div class="content-card card-me">
                        <div class="card-title">Me</div>
                        <div class="card-subtitle">Connection Seeking Â· Expressive</div>
                        <ul class="traits">
                            <li>Thrives on emotional closeness</li>
                            <li>Processes feelings through conversation</li>
                            <li>Finds security in consistent connection</li>
                            <li>May feel unsettled by silence</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Feels loved through</span>
                            <div class="section-content">Acts of service, words of affirmation</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">Working on</span>
                            <div class="growth-item">Trusting that space â‰  rejection</div>
                        </div>
                    </div>

                    <div class="overlap-card">
                        <div class="overlap-title">Shared Space</div>
                        <span class="overlap-icon">â™¡</span>
                        <ul class="overlap-traits">
                            <li>Physical presence settles us both</li>
                            <li>Walls come down when we're together</li>
                            <li>Same need, different languages</li>
                            <li>Both more invested than we show</li>
                            <li>We thrive in quiet, unplanned moments</li>
                        </ul>
                        <div class="shared-lang">
                            <span class="shared-lang-label">Shared love languages</span>
                            Words of affirmation & acts of service
                        </div>
                    </div>

                    <div class="content-card card-you">
                        <div class="card-title">You</div>
                        <div class="card-subtitle">Autonomy Valuing Â· Reflective</div>
                        <ul class="traits">
                            <li>Feels deeply, processes internally</li>
                            <li>Recharges through solitude</li>
                            <li>Values independence within connection</li>
                            <li>Shows care through presence and actions</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Feels loved through</span>
                            <div class="section-content">Words of affirmation, physical touch</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">What helps</span>
                            <div class="growth-item">Naming the return: "I'll be back"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. SYSTEM OPTIMIZATION PROTOCOLS (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">âš™ï¸</span>
                <span class="collapsible-title">System Optimization Protocols</span>
            </div>
            <span class="collapsible-toggle">â–¼</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div style="background: rgba(138, 106, 154, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: #5a4a6a;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a;">ğŸ“Š Coupled Systems Architecture</div>
                    <pre style="margin: 0; white-space: pre; overflow-x: auto;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node A    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Node B    â”‚
â”‚  (Her/Dev)  â”‚    Bidirectional   â”‚ (Him/Engr)  â”‚
â”‚             â”‚   Feedback Loop    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                  â”‚
       â”œâ”€â–º Signal Processing              â”œâ”€â–º Buffer Space
       â”œâ”€â–º State Validation               â”œâ”€â–º Async Handling
       â””â”€â–º Load Balancing â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                    <div style="margin-top: 12px; font-size: 0.8rem; font-style: italic;">Two autonomous systems optimizing for shared throughput</div>
                </div>

                <div class="helps-grid">
                    <div class="helps-column">
                        <h3>Node A Optimizations</h3>
                        <ul>
                            <li><strong>Allow async processing:</strong> His buffer space prevents system overload</li>
                            <li><strong>Emit status updates:</strong> Broadcast state without expecting ACK</li>
                            <li><strong>Trust the handshake:</strong> Connection persists through idle cycles</li>
                            <li><strong>Parallel processing:</strong> Both nodes need independent compute time</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>System-Wide Protocols</h3>
                        <ul>
                            <li><strong>Use descriptive logging:</strong> "STATUS: feeling X" vs "ERROR: you always Y"</li>
                            <li><strong>Implement graceful degradation:</strong> Temporary disconnects don't crash the system</li>
                            <li><strong>Schedule health checks:</strong> Regular pings maintain connection stability</li>
                            <li><strong>Load balancing:</strong> Distribute processing across both nodes</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>Node B Optimizations</h3>
                        <ul>
                            <li><strong>Send keepalive packets:</strong> Small signals maintain connection health</li>
                            <li><strong>Broadcast intent:</strong> Quick ETA reduces timeout anxiety</li>
                            <li><strong>Share debug logs:</strong> Internal state visibility builds trust</li>
                            <li><strong>Presence > perfection:</strong> Uptime matters more than flawless output</li>
                        </ul>
                    </div>
                </div>

                <div style="background: rgba(138, 106, 154, 0.05); padding: 16px; border-radius: 12px; margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: #5a4a6a;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a;">ğŸ“¡ Network Traffic Flow</div>
                    <pre style="margin: 0; white-space: pre; overflow-x: auto;">
Request Flow:
Node A â”€â”€[SIGNAL: need_space]â”€â”€> Node B
       <â”€[ACK: received]â”€â”€â”€â”€â”€â”€â”€ Node B

Response Latency:
Fast (< 5min)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ 75% uptime
Normal (< 1hr) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 95% uptime
Slow (> 1hr)   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% eventual consistency

Status Codes:
200 OK                    - System stable
202 Accepted              - Processing async
408 Request Timeout       - Need more time
503 Service Unavailable   - Temporary buffer overflow</pre>
                </div>

                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fff5d9 100%); border-radius: 12px; border-left: 4px solid #f0c040;">
                    <div style="font-weight: 600; color: #6a5a4a; margin-bottom: 8px;">ğŸ’¡ Engineering Note:</div>
                    <div style="font-size: 0.9rem; color: #6a5a4a; line-height: 1.6;">
                        This isn't about fixing bugs in each otherâ€”it's about optimizing the interface between two well-functioning systems. When Node A signals high load, Node B doesn't need to debug Node A's internals. Just acknowledge the signal and allow async processing. Both systems remain stable independently.
                    </div>
                </div>

                <div style="background: rgba(138, 106, 154, 0.05); padding: 16px; border-radius: 12px; margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: #5a4a6a;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a;">ğŸ”€ Version Control Metaphor</div>
                    <pre style="margin: 0; white-space: pre; overflow-x: auto;">
git log --oneline relationship.branch

* a3f91c2 (HEAD) Merge: Better async communication
* 8b2e4d1 feat: Implemented keepalive packets
* c7a9f3e fix: Reduced timeout anxiety
* 2d1b8a4 refactor: Optimized buffer handling
* f5e3c2b Initial commit: Two systems connecting

// No force push. No hard reset.
// Just continuous integration.</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyDivrvDQijdlHP6nFOBlQB7eAOf8WFo_GA",
            authDomain: "attachmentstyles-b807c.firebaseapp.com",
            databaseURL: "https://attachmentstyles-b807c-default-rtdb.firebaseio.com",
            projectId: "attachmentstyles-b807c",
            storageBucket: "attachmentstyles-b807c.firebasestorage.app",
            messagingSenderId: "619137221036",
            appId: "1:619137221036:web:905bcdec602659048d7a09"
        };

        const isFirebaseConfigured = !firebaseConfig.apiKey.includes("YOUR_");

        let db = null;
        let roomRef = null;
        let historyRef = null;
        let currentIdentity = null;
        let roomId = null;
        let currentMoodKey = null;
        let previousData = {};
        let moodHistory = [];
        let currentMonthOffset = 0; // 0 = current month, -1 = last month, etc.

        // ============ MOOD DATA ============
        const moodEmojis = {
            space: 'ğŸŒ¿',
            anxious: 'ğŸŒŠ',
            overwhelmed: 'ğŸŒŠ',
            disconnected: 'ğŸŒ«ï¸',
            reconnect: 'ğŸŒ¸',
            good: 'â˜€ï¸'
        };

        const moodData = {
            me: {
                space: {
                    label: "Need space, but okay",
                    message: "I just need a little quiet time to recharge. This isn't about you. I'll be back soon.",
                    insightTitle: "When I Need Space",
                    insightMe: "// STATUS: 200 OK - Processing independently. Take this time to do something that fills your cup.",
                    insightYou: "// ACK received - She's self-regulating. A simple 'take your time' is perfect keepalive packet."
                },
                anxious: {
                    label: "Feeling anxious",
                    message: "I'm feeling a bit anxious right now. I don't need you to fix it. Just knowing you're there helps.",
                    insightTitle: "When I'm Feeling Anxious",
                    insightMe: "// High latency detected - Notice this feeling without acting on it. Try 5 deep breaths first.",
                    insightYou: "// Signal received - She's being vulnerable. A heart emoji or 'I'm here' goes far."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I'm feeling a bit distant from us. I'd love some quality time when you're ready.",
                    insightTitle: "When I Feel Disconnected",
                    insightMe: "// TODO: Debug - Am I seeking connection or seeking reassurance?",
                    insightYou: "// Connection timeout - She's missing you. Low-pressure sync session would help."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to connect. No pressure, just wanted you to know. â™¡",
                    insightTitle: "Ready to Reconnect",
                    insightMe: "// READY state - Stay open without expecting specific response code.",
                    insightYou: "// Port open - This is an invitation, not a requirement. Good time to sync."
                },
                good: {
                    label: "All good â™¡",
                    message: "Feeling good and settled. Just wanted you to know all is well. â™¡",
                    insightTitle: "All Good",
                    insightMe: "// 200 OK - System stable. Note what contributed to this state.",
                    insightYou: "// All systems nominal - She's content. No action needed. Just receive this."
                }
            },
            you: {
                space: {
                    label: "Need space, but okay",
                    message: "I'm taking some time to recharge. This isn't distance, it's how I process. I'll be back.",
                    insightTitle: "When He Needs Space",
                    insightMe: "// His buffer processing != connection issue. Do something nourishing for yourself.",
                    insightYou: "// Broadcasting ETA reduces timeout anxiety - Naming when you'll return helps stabilize system."
                },
                overwhelmed: {
                    label: "Feeling overwhelmed",
                    message: "Feeling a bit overwhelmed right now. I need to step back and recalibrate.",
                    insightTitle: "When He's Overwhelmed",
                    insightMe: "// 503 Service Temporarily Unavailable - His withdrawal is system protection, not punishment. Don't retry immediately.",
                    insightYou: "// High load detected - A small keepalive packet when ready bridges the gap."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I've been in my own world lately. It's not intentional. I want to find our way back.",
                    insightTitle: "When He Feels Disconnected",
                    insightMe: "// git commit -m 'Acknowledge disconnect' - He's naming it, that's huge. Let him initiate merge.",
                    insightYou: "// Sharing internal state visibility builds trust - She'll appreciate you naming this."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to be close. Just wanted you to know I'm here.",
                    insightTitle: "When He's Ready to Reconnect",
                    insightMe: "// Connection restored - Receive this. Don't overload. Match his bandwidth.",
                    insightYou: "// Your uptime presence > perfection - Being available is the gift."
                },
                good: {
                    label: "All good â™¡",
                    message: "I'm good. Feeling settled and close to you. â™¡",
                    insightTitle: "All Good",
                    insightMe: "// 200 OK - Both systems stable. Soak this in. This is what secure feels like.",
                    insightYou: "// Optimal throughput achieved - Enjoy this moment of low-latency connection."
                }
            }
        };

        // ============ INITIALIZATION ============
        function init() {
            // Check for first-time user
            const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
            if (!hasSeenTutorial) {
                // Show tutorial after a brief delay
                setTimeout(() => {
                    document.getElementById('tutorial-modal').style.display = 'flex';
                }, 500);
            }

            // Check for saved room first
            const savedRoom = localStorage.getItem('lastRoom');
            const urlParams = new URLSearchParams(window.location.search);

            // Priority: URL param > saved room > new room
            if (urlParams.get('room')) {
                roomId = urlParams.get('room');
            } else if (savedRoom) {
                roomId = savedRoom;
                document.getElementById('returning-note').classList.add('visible');
            } else {
                roomId = generateRoomId();
            }

            // Update URL and save
            window.history.replaceState({}, '', `?room=${roomId}`);
            localStorage.setItem('lastRoom', roomId);

            // Load room name
            const savedName = localStorage.getItem('roomName_' + roomId);
            document.getElementById('room-name').textContent = savedName || 'Our Space';

            // Load and apply display names
            updateDisplayNames();
            
            // Update share link
            document.getElementById('share-link').value = window.location.href;

            if (isFirebaseConfigured) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                roomRef = db.ref('rooms/' + roomId);
                historyRef = db.ref('history/' + roomId);
                
                roomRef.on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    updateLiveStatus(data);
                    checkForComboAlert(data);

                    // Load settings from Firebase
                    if (data.settings) {
                        localStorage.setItem('myName', data.settings.myName || 'Her');
                        localStorage.setItem('partnerName', data.settings.partnerName || 'Him');
                        localStorage.setItem('myPronouns', data.settings.myPronouns || 'she/her');
                        localStorage.setItem('partnerPronouns', data.settings.partnerPronouns || 'he/him');
                        updateDisplayNames();
                    }
                });

                historyRef.on('value', (snapshot) => {
                    console.log('Firebase snapshot received:', snapshot.exists(), 'Number of children:', snapshot.numChildren());
                    const history = [];
                    snapshot.forEach((child) => {
                        const entry = child.val();
                        console.log('Processing history entry:', entry);
                        history.push(entry);
                    });
                    console.log('Total history entries loaded:', history.length);
                    // Sort by timestamp in JavaScript instead of Firebase query
                    history.sort((a, b) => b.timestamp - a.timestamp);
                    console.log('Sorted history:', history);
                    moodHistory = history;
                    updateMoodCalendar(history);

                    if (currentIdentity && history.length >= 3) {
                        setTimeout(generateInsights, 500);
                        setTimeout(generateWeeklyReflection, 1000);
                    }
                });

                db.ref('.info/connected').on('value', (snap) => {
                    const dot = document.getElementById('connection-dot');
                    dot.classList.toggle('connected', snap.val());
                });
            }

            // Load saved identity
            const savedIdentity = localStorage.getItem('identity_' + roomId);
            if (savedIdentity) {
                selectIdentity(savedIdentity, true);
            }
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // ============ ROOM MANAGEMENT ============
        function editRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
        }

        function saveRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            const name = input.value.trim() || 'Our Space';
            display.textContent = name;
            display.style.display = 'inline';
            input.style.display = 'none';
            localStorage.setItem('roomName_' + roomId, name);
        }

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('visible');

            // Generate QR code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            // Add a small delay to ensure library is loaded
            setTimeout(() => {
                try {
                    if (typeof QRCode !== 'undefined') {
                        // Create canvas element
                        const canvas = document.createElement('canvas');
                        QRCode.toCanvas(canvas, window.location.href, {
                            width: 160,
                            margin: 2,
                            color: {
                                dark: '#4a4a5a',
                                light: '#ffffff'
                            }
                        }, (error) => {
                            if (error) {
                                console.error('QR generation error:', error);
                                qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">QR Code generation failed<br><span style="font-size: 0.7rem;">(Copy link below instead)</span></div>';
                            } else {
                                qrContainer.appendChild(canvas);
                            }
                        });
                    } else {
                        // Library not loaded - show fallback
                        qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">QR Code library loading...<br><span style="font-size: 0.7rem;">(Use link below)</span></div>';
                        console.warn('QRCode library not loaded. Check internet connection.');
                    }
                } catch (e) {
                    console.error('QR Code error:', e);
                    qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">Error generating QR code<br><span style="font-size: 0.7rem;">(Copy link below)</span></div>';
                }
            }, 100);
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('visible');
        }

        function copyLink() {
            const link = document.getElementById('share-link').value;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.querySelector('.copy-link-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }

        function shareViaText() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`sms:?body=Join our relationship space "${name}": ${link}`);
        }

        function shareViaEmail() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`mailto:?subject=Join our space&body=Here's our relationship check-in space "${name}": ${link}`);
        }

        function createNewRoom() {
            if (confirm('Create a new room? You can always come back to this one using the link.')) {
                localStorage.removeItem('lastRoom');
                localStorage.removeItem('identity_' + roomId);
                window.location.href = window.location.pathname;
            }
        }

        // ============ IDENTITY ============
        function selectIdentity(identity, silent = false) {
            currentIdentity = identity;
            localStorage.setItem('identity_' + roomId, identity);

            // Update UI
            document.querySelectorAll('.identity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.identity-btn.${identity}`).classList.add('active');
            
            // Show badge
            const badge = document.getElementById('identity-badge');
            badge.textContent = identity === 'me' ? 'Her' : 'Him';
            badge.className = `identity-badge ${identity}`;
            badge.style.display = 'inline-block';

            // Hide welcome after selection
            if (!silent) {
                document.getElementById('welcome-card').style.display = 'none';
            }

            // Show mood section
            document.getElementById('mood-section').classList.add('visible');
            populateMoodButtons();

            if (!silent) {
                document.getElementById('mood-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function populateMoodButtons() {
            const container = document.getElementById('mood-buttons');
            const moods = moodData[currentIdentity];
            container.innerHTML = '';
            
            // Check for existing mood today
            let todayMood = null;
            if (previousData && previousData[currentIdentity]) {
                const ts = previousData[currentIdentity].timestamp;
                if (new Date(ts).toDateString() === new Date().toDateString()) {
                    todayMood = previousData[currentIdentity].mood;
                    currentMoodKey = todayMood;
                    document.getElementById('note-box').classList.add('visible');
                }
            }

            Object.keys(moods).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'mood-btn';
                btn.textContent = moods[key].label;
                btn.onclick = function() { selectMood(key, this); };
                if (key === todayMood) {
                    btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');
                }
                container.appendChild(btn);
            });
        }

        // ============ MOOD SELECTION ============
        function selectMood(moodKey, btn) {
            currentMoodKey = moodKey;
            const mood = moodData[currentIdentity][moodKey];

            // Update buttons
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active-me', 'active-you'));
            btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');

            // Show note box
            document.getElementById('note-box').classList.add('visible');
            document.getElementById('note-input').value = '';

            // Floating hearts for "good"
            if (moodKey === 'good') createFloatingHearts(btn);

            // Save
            const timestamp = Date.now();
            const update = {
                mood: moodKey,
                label: mood.label,
                message: mood.message,
                customNote: '',
                timestamp: timestamp
            };

            if (roomRef && historyRef) {
                // Update current mood status
                roomRef.child(currentIdentity).set(update);

                // Save to history - always save so history reflects mood changes
                const historyEntry = {
                    person: currentIdentity,
                    mood: moodKey,
                    label: mood.label,
                    emoji: moodEmojis[moodKey],
                    timestamp: timestamp
                };
                historyRef.push(historyEntry).then(() => {
                    console.log('Mood saved to history:', historyEntry);
                }).catch(err => {
                    console.error('Failed to save mood to history:', err);
                });
            } else {
                console.warn('Firebase not initialized - mood not saved');
            }

            showInsight(currentIdentity, moodKey, false);
        }

        function sendNote() {
            const note = document.getElementById('note-input').value.trim();
            if (!currentMoodKey) return;

            const mood = moodData[currentIdentity][currentMoodKey];
            const update = {
                mood: currentMoodKey,
                label: mood.label,
                message: mood.message,
                customNote: note,
                timestamp: Date.now()
            };

            if (roomRef) {
                roomRef.child(currentIdentity).set(update).then(() => {
                    document.getElementById('note-input').value = '';
                    document.getElementById('note-input').placeholder = 'Sent! â™¡';
                    setTimeout(() => {
                        document.getElementById('note-input').placeholder = 'Anything else you want to share...';
                    }, 2000);
                });
                // Don't save to history here - it was already saved in selectMood()
            }
        }

        function createFloatingHearts(el) {
            const rect = el.getBoundingClientRect();
            const container = document.createElement('div');
            container.className = 'floating-hearts';
            container.style.left = rect.left + rect.width / 2 + 'px';
            container.style.top = rect.top + 'px';
            document.body.appendChild(container);

            const hearts = ['â™¡', 'ğŸ’•', 'âœ¨', 'ğŸ’—'];
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const heart = document.createElement('span');
                    heart.className = 'floating-heart';
                    heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                    heart.style.left = (Math.random() - 0.5) * 50 + 'px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 2000);
                }, i * 80);
            }
            setTimeout(() => container.remove(), 2500);
        }

        // ============ LIVE STATUS ============
        function updateLiveStatus(data) {
            ['me', 'you'].forEach(person => {
                const moodEl = document.getElementById(`live-mood-${person}`);
                const timeEl = document.getElementById(`live-time-${person}`);
                const card = moodEl.closest('.live-status-card');

                if (data && data[person]) {
                    const isNew = !previousData[person] || previousData[person].timestamp !== data[person].timestamp;
                    
                    moodEl.textContent = data[person].label;
                    moodEl.classList.add('active');
                    card.classList.add('has-mood');
                    
                    if (isNew) {
                        card.classList.remove('just-updated');
                        void card.offsetWidth;
                        card.classList.add('just-updated');
                    }

                    timeEl.textContent = formatTime(new Date(data[person].timestamp));

                    if (currentIdentity && person !== currentIdentity) {
                        showPartnerMessage(data[person]);
                    }
                } else {
                    moodEl.textContent = 'No status yet';
                    moodEl.classList.remove('active');
                    card.classList.remove('has-mood');
                    timeEl.textContent = '';
                }
            });
            previousData = JSON.parse(JSON.stringify(data || {}));
        }

        function formatTime(date) {
            const diff = Date.now() - date;
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function showPartnerMessage(data) {
            const container = document.getElementById('partner-message');
            const label = document.getElementById('partner-message-label');
            const text = document.getElementById('partner-message-text');
            const partnerIs = currentIdentity === 'me' ? 'Him' : 'Her';

            label.textContent = `Message from ${partnerIs}`;
            let html = data.message;
            if (data.customNote) {
                html += `<div class="custom-note"><span class="custom-note-label">Added:</span>${data.customNote}</div>`;
            }
            text.innerHTML = html;
            container.classList.add('visible');
            
            // Show insight for partner's mood
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';
            showInsight(partnerIdentity, data.mood, true);
        }

        // ============ INSIGHTS ============
        function showInsight(person, moodKey, isPartner = false) {
            const mood = moodData[person] && moodData[person][moodKey];
            if (!mood) return;

            document.getElementById('insight-title').textContent = mood.insightTitle;
            
            const label1 = document.getElementById('insight-label-1');
            const label2 = document.getElementById('insight-label-2');
            const text1 = document.getElementById('insight-text-1');
            const text2 = document.getElementById('insight-text-2');

            if (isPartner) {
                const who = person === 'me' ? 'She' : 'He';
                label1.textContent = `What ${who}'s Saying`;
                label2.textContent = 'How I Can Help';
                text1.textContent = mood.message;
                // Show the insight for the CURRENT user (partner of the person who set the mood)
                text2.textContent = currentIdentity === 'me' ? mood.insightMe : mood.insightYou;
            } else {
                label1.textContent = 'Reminder for Me';
                label2.textContent = 'What They\'ll See';
                text1.textContent = person === 'me' ? mood.insightMe : mood.insightYou;
                text2.textContent = mood.message;
            }

            document.getElementById('insight-panel').classList.add('visible');
        }

        function closeInsight() {
            document.getElementById('insight-panel').classList.remove('visible');
        }

        // ============ COMBO ALERTS ============
        function checkForComboAlert(data) {
            if (!data.me || !data.you) return;

            const alert = document.getElementById('combo-alert');
            const text = document.getElementById('combo-alert-text');
            const tension = ['anxious', 'overwhelmed', 'disconnected'];

            if (tension.includes(data.me.mood) && tension.includes(data.you.mood)) {
                alert.classList.add('visible');
                text.textContent = "âš ï¸ High latency detected on both nodes. Recommendation: Implement circuit breaker pattern (20 min cooldown), then retry with curiosity. Previous deployments successful.";
            } else if (data.me.mood === 'anxious' && (data.you.mood === 'space' || data.you.mood === 'overwhelmed')) {
                alert.classList.add('visible');
                text.textContent = "ğŸ”„ Classic retry loop: Node A pinging, Node B buffering. Neither is ERROR state. Expected behavior. Auto-resolve in ~1h.";
            } else if (data.me.mood === 'good' && data.you.mood === 'good') {
                alert.classList.add('visible');
                text.textContent = "âœ… 200 OK - Both systems operating at optimal throughput. Low-latency connection achieved. This is your target state.";
                setTimeout(() => alert.classList.remove('visible'), 5000);
            } else {
                alert.classList.remove('visible');
            }
        }

        // ============ AI FEATURES ============
        const AI_CONTEXT = `You are a warm relationship coach helping an anxious-avoidant couple. 
        She is anxious-leaning (needs reassurance). He is avoidant-leaning (needs space).
        Keep responses brief (2-3 sentences), warm, and actionable.`;

        async function callAI(prompt) {
            // Check if API key is configured
            if (!CONFIG || !CONFIG.ANTHROPIC_API_KEY || CONFIG.ANTHROPIC_API_KEY === "YOUR_ANTHROPIC_API_KEY_HERE") {
                console.warn('AI features disabled: No API key configured');
                return null;
            }

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": CONFIG.ANTHROPIC_API_KEY,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 250,
                        system: AI_CONTEXT,
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                return data.content?.[0]?.text || null;
            } catch (e) {
                console.error('AI error:', e);
                return null;
            }
        }

        let currentSuggestion = '';

        async function improveMessage() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (!text) {
                input.placeholder = 'Write something first';
                setTimeout(() => input.placeholder = 'Anything else you want to share...', 2000);
                return;
            }

            const box = document.getElementById('ai-suggestion');
            const suggestionText = document.getElementById('ai-suggestion-text');
            box.classList.add('visible');
            suggestionText.textContent = 'Thinking...';

            const target = currentIdentity === 'me' ? 'an avoidant partner' : 'an anxious partner';
            const result = await callAI(`Rephrase this to land better with ${target}: "${text}". Just the rephrased message.`);
            
            if (result) {
                currentSuggestion = result;
                suggestionText.textContent = result;
            } else {
                box.classList.remove('visible');
            }
        }

        function useSuggestion() {
            if (currentSuggestion) document.getElementById('note-input').value = currentSuggestion;
            dismissSuggestion();
        }

        function dismissSuggestion() {
            document.getElementById('ai-suggestion').classList.remove('visible');
            currentSuggestion = '';
        }

        async function helpMeUnderstand() {
            const response = document.getElementById('understand-response');
            const text = document.getElementById('understand-text');
            response.classList.add('visible');
            text.textContent = 'Thinking...';

            const partner = currentIdentity === 'me' ? 'you' : 'me';
            const data = previousData[partner];
            if (!data) {
                text.textContent = "Your partner hasn't shared yet.";
                return;
            }

            const type = partner === 'me' ? 'anxious-leaning (she)' : 'avoidant-leaning (he)';
            const result = await callAI(`My ${type} partner shared: "${data.label}". Message: "${data.message}". ${data.customNote ? `Note: "${data.customNote}"` : ''} What do they need and what's one thing I can do?`);
            text.textContent = result || "Try responding to what they asked for directly.";
        }

        async function generateInsights() {
            if (!currentIdentity || moodHistory.length < 3) {
                document.getElementById('ai-insights-text').textContent = 'Keep logging moods to see patterns!';
                return;
            }

            document.getElementById('insights-loading').classList.add('visible');
            document.getElementById('ai-insights-text').style.display = 'none';

            const summary = moodHistory.slice(-15).map(h => `${h.person === 'me' ? 'Her' : 'Him'}: ${h.label}`).join(', ');
            const who = currentIdentity === 'me' ? 'Her (anxious)' : 'Him (avoidant)';
            
            const result = await callAI(`Mood history: ${summary}. I'm ${who}. One encouraging pattern insight. Start with emoji.`);
            
            document.getElementById('insights-loading').classList.remove('visible');
            const textEl = document.getElementById('ai-insights-text');
            textEl.style.display = 'block';
            textEl.textContent = result || "âœ¨ You're both showing up. That's the foundation.";
        }

        async function generateWeeklyReflection() {
            const week = moodHistory.filter(h => h.timestamp > Date.now() - 7 * 24 * 60 * 60 * 1000);
            if (week.length < 3) {
                document.getElementById('weekly-text').textContent = 'Keep checking in to see your weekly reflection!';
                return;
            }

            document.getElementById('weekly-loading').classList.add('visible');
            document.getElementById('weekly-text').style.display = 'none';

            const good = week.filter(h => h.mood === 'good' || h.mood === 'reconnect').length;
            const hard = week.filter(h => ['anxious', 'overwhelmed', 'disconnected'].includes(h.mood)).length;
            
            const result = await callAI(`This week: ${good} good moments, ${hard} harder ones. Write a warm 2 sentence reflection. Start with emoji.`);
            
            document.getElementById('weekly-loading').classList.remove('visible');
            const textEl = document.getElementById('weekly-text');
            textEl.style.display = 'block';
            textEl.textContent = result || `ğŸ“ ${good} good moments this week. You're showing up for each other.`;
        }

        // ============ MOOD CALENDAR ============
        function updateMoodCalendar(history) {
            const container = document.getElementById('mood-calendar');
            console.log('updateMoodCalendar called with', history?.length, 'entries:', history);

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="no-history">No mood history yet. Start sharing how you feel!</div>';
                return;
            }

            // Auto-expand the Mood History section if it has data and is collapsed
            const historySection = container.closest('.collapsible-section');
            if (historySection && !historySection.querySelector('.collapsible-header').classList.contains('open')) {
                historySection.querySelector('.collapsible-header').classList.add('open');
                historySection.querySelector('.collapsible-content').classList.add('open');
            }

            // Calculate the target month
            const now = new Date();
            const targetDate = new Date(now.getFullYear(), now.getMonth() + currentMonthOffset, 1);
            const targetYear = targetDate.getFullYear();
            const targetMonth = targetDate.getMonth();

            // Update month display
            document.getElementById('current-month').textContent =
                targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Filter history for the target month
            const monthHistory = history.filter(h => {
                const d = new Date(h.timestamp);
                return d.getFullYear() === targetYear && d.getMonth() === targetMonth;
            });

            if (monthHistory.length === 0) {
                container.innerHTML = `<div class="no-history">No mood history for ${targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>`;
                return;
            }

            // Group by day
            const grouped = {};
            monthHistory.forEach(h => {
                const key = new Date(h.timestamp).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(h);
            });

            console.log('Grouped calendar data:', grouped);

            // Sort days in descending order (newest first)
            const sorted = Object.keys(grouped).sort((a, b) =>
                new Date(grouped[b][0].timestamp) - new Date(grouped[a][0].timestamp)
            );

            // Display all days in the month
            let html = '';
            sorted.forEach((day, i) => {
                const entries = grouped[day].sort((a, b) => b.timestamp - a.timestamp);
                html += `<div class="calendar-day" style="animation-delay: ${i * 0.05}s">
                    <div class="calendar-date">${day}</div>
                    <div class="calendar-moods">`;
                entries.forEach(e => {
                    const time = new Date(e.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    html += `<div class="calendar-mood-entry ${e.person}">
                        <span class="entry-emoji">${e.emoji || moodEmojis[e.mood]}</span>
                        <span>${e.person === 'me' ? 'Her' : 'Him'}</span>
                        <span class="entry-time">${time}</span>
                    </div>`;
                });
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        function previousMonth() {
            currentMonthOffset--;
            updateMoodCalendar(moodHistory);
        }

        function nextMonth() {
            if (currentMonthOffset < 0) {
                currentMonthOffset++;
                updateMoodCalendar(moodHistory);
            }
        }

        // ============ COLLAPSIBLE SECTIONS ============
        function toggleSection(header) {
            header.classList.toggle('open');
            header.nextElementSibling.classList.toggle('open');
        }

        // ============ TUTORIAL FUNCTIONS ============
        let currentTutorialStep = 1;

        function nextTutorialStep() {
            document.getElementById(`tutorial-step-${currentTutorialStep}`).style.display = 'none';
            currentTutorialStep++;
            document.getElementById(`tutorial-step-${currentTutorialStep}`).style.display = 'block';
        }

        function skipTutorial() {
            localStorage.setItem('hasSeenTutorial', 'true');
            document.getElementById('tutorial-modal').style.display = 'none';
            currentTutorialStep = 1;
        }

        function closeTutorial() {
            localStorage.setItem('hasSeenTutorial', 'true');
            document.getElementById('tutorial-modal').style.display = 'none';
            currentTutorialStep = 1;
        }

        function showTutorialAgain() {
            currentTutorialStep = 1;
            document.getElementById('tutorial-step-1').style.display = 'block';
            document.getElementById('tutorial-step-2').style.display = 'none';
            document.getElementById('tutorial-step-3').style.display = 'none';
            document.getElementById('tutorial-step-4').style.display = 'none';
            document.getElementById('tutorial-modal').style.display = 'flex';
        }

        // ============ PERSONALIZATION SETTINGS ============
        function openPersonalizationSettings() {
            const modal = document.getElementById('attachment-settings-modal');
            modal.style.display = 'flex';

            // Load saved settings
            const myName = localStorage.getItem('myName') || '';
            const partnerName = localStorage.getItem('partnerName') || '';
            const myPronouns = localStorage.getItem('myPronouns') || 'she/her';
            const partnerPronouns = localStorage.getItem('partnerPronouns') || 'he/him';

            document.getElementById('my-name-input').value = myName;
            document.getElementById('partner-name-input').value = partnerName;
            document.getElementById('my-pronoun-select').value = myPronouns;
            document.getElementById('partner-pronoun-select').value = partnerPronouns;

            // Handle custom pronouns
            if (myPronouns === 'custom' || !['she/her', 'he/him', 'they/them'].includes(myPronouns)) {
                document.getElementById('my-pronoun-select').value = 'custom';
                document.getElementById('my-custom-pronoun').style.display = 'block';
                document.getElementById('my-custom-pronoun').value = myPronouns;
            }
            if (partnerPronouns === 'custom' || !['she/her', 'he/him', 'they/them'].includes(partnerPronouns)) {
                document.getElementById('partner-pronoun-select').value = 'custom';
                document.getElementById('partner-custom-pronoun').style.display = 'block';
                document.getElementById('partner-custom-pronoun').value = partnerPronouns;
            }
        }

        function closeAttachmentSettings() {
            document.getElementById('attachment-settings-modal').style.display = 'none';
        }

        function savePersonalizationSettings() {
            const myName = document.getElementById('my-name-input').value.trim() || 'Partner 1';
            const partnerName = document.getElementById('partner-name-input').value.trim() || 'Partner 2';

            let myPronouns = document.getElementById('my-pronoun-select').value;
            let partnerPronouns = document.getElementById('partner-pronoun-select').value;

            if (myPronouns === 'custom') {
                myPronouns = document.getElementById('my-custom-pronoun').value.trim() || 'they/them';
            }
            if (partnerPronouns === 'custom') {
                partnerPronouns = document.getElementById('partner-custom-pronoun').value.trim() || 'they/them';
            }

            const settings = {
                myName,
                partnerName,
                myPronouns,
                partnerPronouns
            };

            // Save to Firebase
            if (roomRef) {
                roomRef.child('settings').set(settings).then(() => {
                    console.log('Settings saved to Firebase');
                }).catch(err => {
                    console.error('Failed to save settings:', err);
                });
            }

            // Also save to localStorage as backup
            localStorage.setItem('myName', myName);
            localStorage.setItem('partnerName', partnerName);
            localStorage.setItem('myPronouns', myPronouns);
            localStorage.setItem('partnerPronouns', partnerPronouns);

            // Update display names throughout the app
            updateDisplayNames();

            closeAttachmentSettings();
        }

        function updateDisplayNames() {
            const myName = localStorage.getItem('myName') || 'Her';
            const partnerName = localStorage.getItem('partnerName') || 'Him';

            // Update live status cards
            document.querySelectorAll('.live-status-name').forEach((el, index) => {
                el.textContent = index === 0 ? myName : partnerName;
            });

            // Update identity buttons
            document.querySelectorAll('.identity-btn').forEach((btn, index) => {
                if (index === 0) btn.textContent = `I'm ${myName}`;
                else btn.textContent = `I'm ${partnerName}`;
            });
        }

        // Add pronoun select change handlers
        document.addEventListener('DOMContentLoaded', () => {
            const myPronounSelect = document.getElementById('my-pronoun-select');
            const partnerPronounSelect = document.getElementById('partner-pronoun-select');

            if (myPronounSelect) {
                myPronounSelect.addEventListener('change', (e) => {
                    const customInput = document.getElementById('my-custom-pronoun');
                    customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
            }

            if (partnerPronounSelect) {
                partnerPronounSelect.addEventListener('change', (e) => {
                    const customInput = document.getElementById('partner-custom-pronoun');
                    customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
            }
        });

        // Initialize
        init();
    </script>

    <!-- Footer -->
    <footer style="width: 100%; max-width: 920px; text-align: center; padding: 40px 20px 20px; margin-top: 40px; border-top: 1px solid rgba(0,0,0,0.06);">
        <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">
            Made with ğŸ’• for better understanding between partners
        </p>
        <a href="https://github.com/hereshecodes/attachment_workbook.io" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); text-decoration: none; color: #4a4a5a; font-size: 0.8rem; transition: all 0.2s;">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            View on GitHub
        </a>
    </footer>
</body>
</html>