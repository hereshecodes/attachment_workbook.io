<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(160deg, #fdfbf9 0%, #f8f4f0 30%, #f5ede6 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            color: #3d3d3d;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: -200px;
            right: -200px;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(180, 130, 140, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        body::after {
            content: '';
            position: absolute;
            bottom: -200px;
            left: -200px;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(90, 60, 100, 0.06) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 8px;
            letter-spacing: 0.02em;
            text-align: center;
        }

        .subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ============ ROOM BAR (STICKY) ============ */
        .room-bar {
            width: 100%;
            max-width: 920px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            position: sticky;
            top: 20px;
            z-index: 100;
            animation: slideDown 0.5s ease-out;
        }

        .room-bar-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .room-identity {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .room-name-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: #4a4a5a;
        }

        .room-name-edit {
            background: none;
            border: none;
            font-size: 0.75rem;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
        }

        .room-name-edit:hover {
            color: #666;
        }

        .room-name-input {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: #4a4a5a;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 4px 10px;
            width: 120px;
            display: none;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            animation: pulse 2s infinite;
        }

        .connection-dot.connected { background: #7cb87c; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .identity-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .identity-badge.me {
            background: linear-gradient(135deg, #c4949e, #a07080);
            color: white;
        }

        .identity-badge.you {
            background: linear-gradient(135deg, #8a6a9a, #5a3c6a);
            color: white;
        }

        .share-actions {
            display: flex;
            gap: 8px;
        }

        .share-btn {
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .share-btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }

        .share-btn.primary {
            background: linear-gradient(135deg, #8a7a9a, #6a5a7a);
            color: white;
            border: none;
        }

        .share-btn.primary:hover {
            box-shadow: 0 4px 12px rgba(106, 90, 122, 0.3);
        }

        /* Share Modal */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .share-modal.visible {
            display: flex;
        }

        .share-modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: bounceIn 0.3s ease;
        }

        .share-modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: #4a4a5a;
            margin-bottom: 8px;
        }

        .share-modal-subtitle {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 24px;
        }

        .qr-code {
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
            background: #f5f5f5;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-code canvas {
            border-radius: 8px;
        }

        .share-link-box {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .share-link-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            font-size: 0.8rem;
            color: #666;
            background: #f9f9f9;
        }

        .copy-link-btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #8a7a9a, #6a5a7a);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-options {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .share-option-btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .share-option-btn:hover {
            background: #f5f5f5;
        }

        .close-modal-btn {
            padding: 10px 24px;
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* ============ WELCOME / IDENTITY SELECTOR ============ */
        .welcome-card {
            width: 100%;
            max-width: 920px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(250,248,255,0.9));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            border: 1px solid rgba(140, 120, 160, 0.15);
            animation: slideDown 0.5s ease-out 0.1s both;
        }

        .welcome-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: #4a4a5a;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 20px;
        }

        .identity-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .identity-btn {
            padding: 14px 32px;
            border-radius: 30px;
            border: 2px solid rgba(0,0,0,0.1);
            background: white;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .identity-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .identity-btn.me {
            border-color: #c4949e;
            color: #9a6070;
        }

        .identity-btn.me:hover, .identity-btn.me.active {
            background: linear-gradient(135deg, #c4949e, #a07080);
            color: white;
            border-color: transparent;
        }

        .identity-btn.you {
            border-color: #8a6a9a;
            color: #5a3c6a;
        }

        .identity-btn.you:hover, .identity-btn.you.active {
            background: linear-gradient(135deg, #8a6a9a, #5a3c6a);
            color: white;
            border-color: transparent;
        }

        .returning-user-note {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(140, 200, 140, 0.1);
            border-radius: 12px;
            font-size: 0.8rem;
            color: #5a7a5a;
            display: none;
        }

        .returning-user-note.visible {
            display: block;
        }

        /* ============ LIVE STATUS CARDS ============ */
        .status-section {
            width: 100%;
            max-width: 920px;
            margin-bottom: 24px;
        }

        .live-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .live-status-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.06);
            transition: all 0.4s ease;
            animation: cardEntrance 0.5s ease-out both;
        }

        .live-status-card.me-card {
            border-top: 3px solid #c4949e;
            animation-delay: 0.2s;
        }
        
        .live-status-card.you-card {
            border-top: 3px solid #6a4a7a;
            animation-delay: 0.3s;
        }

        .live-status-card.has-mood {
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        .live-status-card.just-updated {
            animation: pulseGlow 0.8s ease-out;
        }

        .live-status-name {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            margin-bottom: 6px;
        }

        .me-card .live-status-name { color: #9a6070; }
        .you-card .live-status-name { color: #4a2d5f; }

        .live-status-mood {
            font-size: 0.85rem;
            color: #666;
            min-height: 22px;
        }

        .live-status-mood.active {
            font-weight: 600;
            color: #444;
        }

        .live-status-time {
            font-size: 0.65rem;
            color: #999;
            margin-top: 4px;
        }

        /* ============ MOOD SELECTOR ============ */
        .mood-section {
            width: 100%;
            max-width: 920px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.06);
            display: none;
        }

        .mood-section.visible {
            display: block;
            animation: slideDown 0.4s ease;
        }

        .mood-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            text-align: center;
            color: #4a4a5a;
            margin-bottom: 16px;
        }

        .mood-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .mood-btn {
            padding: 12px 20px;
            border-radius: 25px;
            border: 1.5px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.9);
            font-family: 'Quicksand', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
        }

        .mood-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .mood-btn.active-me {
            background: linear-gradient(135deg, #c4949e, #a07080);
            color: white;
            border-color: transparent;
            animation: bounceIn 0.4s ease-out;
        }

        .mood-btn.active-you {
            background: linear-gradient(135deg, #8a6a9a, #5a3c6a);
            color: white;
            border-color: transparent;
            animation: bounceIn 0.4s ease-out;
        }

        /* Note Box */
        .note-box {
            padding: 16px;
            background: rgba(250,248,252,0.8);
            border-radius: 12px;
            margin-top: 16px;
            display: none;
        }

        .note-box.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .note-box label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .note-box textarea {
            width: 100%;
            min-height: 70px;
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        .note-box textarea:focus {
            outline: none;
            border-color: #c4949e;
        }

        .note-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-rephrase-btn {
            padding: 8px 16px;
            border-radius: 16px;
            border: 1px solid rgba(140, 120, 150, 0.3);
            background: rgba(140, 120, 150, 0.1);
            color: #6a5a7a;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-rephrase-btn:hover {
            background: rgba(140, 120, 150, 0.2);
        }

        .send-note-btn {
            padding: 8px 20px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #c4949e, #a07080);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-note-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ai-suggestion {
            margin-top: 12px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(140, 120, 160, 0.1), rgba(200, 180, 210, 0.1));
            border-radius: 10px;
            border: 1px solid rgba(140, 120, 150, 0.2);
            display: none;
        }

        .ai-suggestion.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .ai-suggestion-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6a5a7a;
            margin-bottom: 6px;
        }

        .ai-suggestion-text {
            font-size: 0.82rem;
            line-height: 1.5;
            color: #444;
            font-style: italic;
            margin-bottom: 10px;
        }

        .suggestion-actions {
            display: flex;
            gap: 8px;
        }

        .use-btn, .dismiss-btn {
            padding: 6px 14px;
            border-radius: 14px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .use-btn {
            border: none;
            background: linear-gradient(135deg, #8a7a9a, #6a5a7a);
            color: white;
        }

        .dismiss-btn {
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            color: #666;
        }

        /* ============ ALERTS & MESSAGES ============ */
        .alert-section {
            width: 100%;
            max-width: 920px;
            margin-bottom: 24px;
        }

        .combo-alert {
            background: linear-gradient(135deg, rgba(255, 230, 220, 0.9), rgba(255, 245, 240, 0.9));
            border-radius: 16px;
            padding: 18px 22px;
            border-left: 4px solid #d4a090;
            display: none;
            animation: slideDown 0.4s ease;
        }

        .combo-alert.visible {
            display: block;
        }

        .combo-alert-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.95rem;
            color: #8a6a5a;
            margin-bottom: 6px;
        }

        .combo-alert-text {
            font-size: 0.82rem;
            line-height: 1.6;
            color: #6a5a4a;
        }

        .partner-message {
            background: linear-gradient(135deg, rgba(140, 120, 160, 0.1), rgba(255,255,255,0.9));
            border-radius: 16px;
            padding: 18px 22px;
            border-left: 4px solid #8a6a9a;
            margin-top: 12px;
            display: none;
            animation: slideInLeft 0.4s ease;
        }

        .partner-message.visible {
            display: block;
        }

        .partner-message-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6a4a7a;
            margin-bottom: 6px;
        }

        .partner-message-text {
            font-size: 0.9rem;
            line-height: 1.6;
            font-style: italic;
            color: #444;
        }

        .custom-note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dotted rgba(0,0,0,0.1);
            font-size: 0.82rem;
            color: #555;
        }

        .custom-note-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #888;
            font-style: normal;
            display: block;
            margin-bottom: 4px;
        }

        .understand-btn {
            margin-top: 12px;
            padding: 10px 18px;
            border-radius: 20px;
            border: 1px solid rgba(140, 120, 150, 0.3);
            background: white;
            color: #5a4a6a;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .understand-btn:hover {
            background: rgba(140, 120, 150, 0.1);
        }

        .understand-response {
            margin-top: 12px;
            padding: 16px;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .understand-response.visible {
            display: block;
        }

        .understand-text {
            font-size: 0.82rem;
            line-height: 1.6;
            color: #444;
        }

        /* ============ INSIGHT PANEL ============ */
        .insight-panel {
            width: 100%;
            max-width: 920px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(140, 120, 150, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            display: none;
        }

        .insight-panel.visible {
            display: block;
            animation: slideDown 0.4s ease;
        }

        .insight-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .insight-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: #4a4a5a;
        }

        .insight-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .insight-close:hover { opacity: 0.8; }

        .insight-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .insight-card {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255,255,255,0.7);
        }

        .insight-card h4 {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .insight-card p {
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .insight-card.for-me { border-top: 3px solid #c4949e; }
        .insight-card.for-you { border-top: 3px solid #6a4a7a; }

        /* ============ AI SECTIONS ============ */
        .ai-section {
            width: 100%;
            max-width: 920px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ai-card {
            background: linear-gradient(135deg, rgba(240, 235, 250, 0.8), rgba(255,255,255,0.9));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(140, 120, 160, 0.15);
        }

        .ai-card.weekly {
            background: linear-gradient(135deg, rgba(255, 250, 245, 0.9), rgba(255,255,255,0.9));
            border-color: rgba(200, 180, 160, 0.2);
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .ai-card-icon {
            font-size: 1rem;
        }

        .ai-card-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.95rem;
            color: #4a4a5a;
            flex: 1;
        }

        .refresh-btn {
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(140, 120, 150, 0.3);
            background: white;
            color: #6a5a7a;
            font-size: 0.65rem;
            cursor: pointer;
        }

        .ai-card-content {
            font-size: 0.82rem;
            line-height: 1.6;
            color: #555;
            min-height: 50px;
        }

        .ai-loading {
            display: none;
            justify-content: center;
            gap: 6px;
            padding: 16px;
        }

        .ai-loading.visible {
            display: flex;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background: rgba(140, 120, 160, 0.4);
            border-radius: 50%;
            animation: loadingBounce 1.2s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes loadingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        /* ============ COLLAPSIBLE SECTIONS ============ */
        .collapsible-section {
            width: 100%;
            max-width: 920px;
            margin-bottom: 16px;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(255,255,255,0.7);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .collapsible-header:hover {
            background: rgba(255,255,255,0.9);
        }

        .collapsible-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapsible-icon {
            font-size: 1rem;
        }

        .collapsible-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: #4a4a5a;
        }

        .collapsible-toggle {
            font-size: 1rem;
            color: #888;
            transition: transform 0.3s ease;
        }

        .collapsible-header.open .collapsible-toggle {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .collapsible-content.open {
            max-height: 2000px;
        }

        .collapsible-inner {
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 0 0 16px 16px;
            margin-top: -8px;
        }

        /* ============ VENN DIAGRAM ============ */
        .venn-container {
            position: relative;
            width: 100%;
            height: 480px;
        }

        .circle {
            position: absolute;
            width: 380px;
            height: 380px;
            border-radius: 50%;
            top: 50px;
            transition: all 0.4s ease;
        }

        .circle-me {
            left: 0;
            background: linear-gradient(150deg, rgba(200, 150, 160, 0.35) 0%, rgba(180, 130, 145, 0.2) 100%);
            border: 2px solid rgba(180, 120, 135, 0.4);
            box-shadow: 0 20px 60px rgba(180, 120, 135, 0.15), inset 0 0 80px rgba(255, 255, 255, 0.4);
            animation: gentleBreathe 8s ease-in-out infinite;
        }

        .circle-you {
            right: 0;
            background: linear-gradient(150deg, rgba(75, 45, 95, 0.35) 0%, rgba(60, 35, 80, 0.25) 100%);
            border: 2px solid rgba(75, 45, 95, 0.4);
            box-shadow: 0 20px 60px rgba(75, 45, 95, 0.15), inset 0 0 80px rgba(255, 255, 255, 0.2);
            animation: gentleBreathe 8s ease-in-out infinite 4s;
        }

        @keyframes gentleBreathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .content-card {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 18px 16px;
            width: 200px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        .card-me {
            left: 20px;
            top: 70px;
            border: 1px solid rgba(180, 120, 135, 0.3);
        }

        .card-you {
            right: 20px;
            top: 70px;
            border: 1px solid rgba(75, 45, 95, 0.3);
        }

        .content-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .card-me .card-title { color: #9a6070; }
        .card-you .card-title { color: #4a2d5f; }

        .card-subtitle {
            font-size: 0.5rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .card-me .card-subtitle { color: #b07080; }
        .card-you .card-subtitle { color: #6a4a7a; }

        .traits {
            list-style: none;
            font-size: 0.7rem;
            line-height: 1.7;
        }

        .traits li {
            position: relative;
            padding-left: 12px;
            margin-bottom: 2px;
        }

        .traits li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .card-me .traits li::before { background: linear-gradient(135deg, #c4949e, #a07080); }
        .card-you .traits li::before { background: linear-gradient(135deg, #7a5a8a, #4a2d5f); }

        .section-divider {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.06);
        }

        .section-label {
            font-weight: 600;
            font-size: 0.45rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 3px;
            display: block;
        }

        .card-me .section-label { color: #a07080; }
        .card-you .section-label { color: #6a4a7a; }

        .section-content {
            font-size: 0.65rem;
            line-height: 1.4;
        }

        .growth-item {
            font-size: 0.62rem;
            font-style: italic;
            line-height: 1.5;
            margin-top: 2px;
        }

        .overlap-card {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 170px;
            text-align: center;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 16px 14px;
            border: 1px solid rgba(140, 100, 140, 0.25);
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
        }

        .overlap-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            color: #5a4a5a;
            margin-bottom: 4px;
        }

        .overlap-icon {
            font-size: 0.8rem;
            opacity: 0.35;
            margin-bottom: 8px;
            display: block;
        }

        .overlap-traits {
            list-style: none;
            font-size: 0.62rem;
            line-height: 1.8;
            color: #4a4a5a;
            font-weight: 500;
        }

        .shared-lang {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(100, 80, 100, 0.15);
            font-size: 0.6rem;
            color: #6a5a6a;
            font-weight: 600;
        }

        .shared-lang-label {
            font-size: 0.45rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: block;
            margin-bottom: 2px;
            opacity: 0.7;
        }

        /* ============ HELPS SECTION ============ */
        .helps-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .helps-column h3 {
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .helps-column:nth-child(1) h3 { color: #9a6070; }
        .helps-column:nth-child(2) h3 { color: #5a4a6a; }
        .helps-column:nth-child(3) h3 { color: #4a2d5f; }

        .helps-column ul {
            list-style: none;
            font-size: 0.72rem;
            line-height: 1.8;
        }

        .helps-column li {
            position: relative;
            padding-left: 14px;
            margin-bottom: 3px;
        }

        .helps-column li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            opacity: 0.4;
            font-size: 0.75rem;
        }

        /* ============ MOOD CALENDAR ============ */
        .calendar-container {
            max-height: 280px;
            overflow-y: auto;
        }

        .calendar-container::-webkit-scrollbar {
            width: 5px;
        }

        .calendar-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
        }

        .calendar-container::-webkit-scrollbar-thumb {
            background: rgba(140, 120, 150, 0.3);
            border-radius: 3px;
        }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .legend-item {
            font-size: 0.65rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-item .emoji {
            font-size: 0.9rem;
        }

        .calendar-day {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            background: rgba(255,255,255,0.6);
            border-radius: 10px;
            gap: 10px;
            margin-bottom: 6px;
            animation: slideInEntry 0.4s ease-out both;
        }

        .calendar-date {
            font-size: 0.65rem;
            font-weight: 600;
            color: #888;
            min-width: 70px;
        }

        .calendar-moods {
            display: flex;
            gap: 6px;
            flex: 1;
            flex-wrap: wrap;
        }

        .calendar-mood-entry {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.7rem;
        }

        .calendar-mood-entry.me {
            background: linear-gradient(135deg, rgba(196, 148, 158, 0.2), rgba(160, 112, 128, 0.15));
            color: #9a6070;
        }

        .calendar-mood-entry.you {
            background: linear-gradient(135deg, rgba(138, 106, 154, 0.2), rgba(90, 60, 106, 0.15));
            color: #5a3c6a;
        }

        .calendar-mood-entry .entry-emoji {
            font-size: 0.95rem;
        }

        .calendar-mood-entry .entry-time {
            font-size: 0.55rem;
            opacity: 0.7;
        }

        .no-history {
            text-align: center;
            color: #999;
            font-size: 0.8rem;
            padding: 16px;
            font-style: italic;
        }

        /* ============ ANIMATIONS ============ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInEntry {
            from { opacity: 0; transform: translateX(-12px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
            50% { box-shadow: 0 8px 32px rgba(140, 120, 150, 0.25); }
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(0.5); }
        }

        .floating-hearts {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
        }

        .floating-heart {
            position: absolute;
            font-size: 1.5rem;
            animation: floatUp 2s ease-out forwards;
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 960px) {
            h1 { font-size: 2rem; }

            .room-bar {
                position: relative;
                top: 0;
            }

            .room-bar-top {
                flex-direction: column;
                text-align: center;
            }

            .live-status {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .ai-section {
                grid-template-columns: 1fr;
            }

            .insight-grid {
                grid-template-columns: 1fr;
            }

            .venn-container {
                height: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .circle { display: none; }

            .content-card, .overlap-card {
                position: relative;
                left: auto;
                right: auto;
                top: auto;
                transform: none;
                width: 100%;
                max-width: 350px;
            }

            .card-me { order: 1; }
            .overlap-card { order: 2; }
            .card-you { order: 3; }

            .helps-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            body { padding: 20px 16px; }
            h1 { font-size: 1.6rem; }

            .room-bar { padding: 14px 18px; }

            .identity-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .identity-btn { width: 100%; }

            .share-actions {
                flex-direction: column;
                width: 100%;
            }

            .share-btn { justify-content: center; }

            .mood-btn {
                padding: 10px 16px;
                font-size: 0.75rem;
            }

            .note-actions {
                flex-direction: column;
            }

            .ai-rephrase-btn, .send-note-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <h1>Relationship Styles</h1>
    <p class="subtitle">A shared space for understanding each other</p>

    <!-- 1. ROOM BAR (Sticky) -->
    <div class="room-bar" id="room-bar">
        <div class="room-bar-top">
            <div class="room-identity">
                <div class="connection-dot" id="connection-dot"></div>
                <div class="room-name-display">
                    <span class="room-name" id="room-name">Our Space</span>
                    <button class="room-name-edit" onclick="editRoomName()">‚úèÔ∏è</button>
                    <input type="text" class="room-name-input" id="room-name-input" maxlength="20" onblur="saveRoomName()" onkeypress="if(event.key==='Enter')saveRoomName()">
                </div>
                <span class="identity-badge" id="identity-badge" style="display: none;"></span>
            </div>
            <div class="share-actions">
                <button class="share-btn" onclick="openShareModal()">üì§ Share</button>
                <button class="share-btn" onclick="createNewRoom()">+ New Room</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-title">Share This Space</div>
            <div class="share-modal-subtitle">Send this link to your partner so you can connect</div>
            <div class="qr-code" id="qr-code"></div>
            <div class="share-link-box">
                <input type="text" class="share-link-input" id="share-link" readonly>
                <button class="copy-link-btn" onclick="copyLink()">Copy</button>
            </div>
            <div class="share-options">
                <button class="share-option-btn" onclick="shareViaText()">üí¨ Text</button>
                <button class="share-option-btn" onclick="shareViaEmail()">üìß Email</button>
            </div>
            <button class="close-modal-btn" onclick="closeShareModal()">Done</button>
        </div>
    </div>

    <!-- 2. WELCOME / IDENTITY SELECTOR -->
    <div class="welcome-card" id="welcome-card">
        <div class="welcome-title">Welcome</div>
        <div class="welcome-subtitle">Who's checking in?</div>
        <div class="identity-buttons">
            <button class="identity-btn me" onclick="selectIdentity('me')">I'm Her</button>
            <button class="identity-btn you" onclick="selectIdentity('you')">I'm Him</button>
        </div>
        <div class="returning-user-note" id="returning-note">
            ‚úì Welcome back! We remembered your room.
        </div>
    </div>

    <!-- 3. LIVE STATUS CARDS -->
    <div class="status-section">
        <div class="live-status">
            <div class="live-status-card me-card">
                <div class="live-status-name">Her</div>
                <div class="live-status-mood" id="live-mood-me">No status yet</div>
                <div class="live-status-time" id="live-time-me"></div>
            </div>
            <div class="live-status-card you-card">
                <div class="live-status-name">Him</div>
                <div class="live-status-mood" id="live-mood-you">No status yet</div>
                <div class="live-status-time" id="live-time-you"></div>
            </div>
        </div>
    </div>

    <!-- 4. MOOD SELECTOR -->
    <div class="mood-section" id="mood-section">
        <div class="mood-header">How are you feeling right now?</div>
        <div class="mood-buttons" id="mood-buttons"></div>
        
        <div class="note-box" id="note-box">
            <label>Add a personal note (optional)</label>
            <textarea id="note-input" placeholder="Anything else you want to share..."></textarea>
            <div class="note-actions">
                <button class="ai-rephrase-btn" onclick="improveMessage()">‚ú® Help me say this better</button>
                <button class="send-note-btn" onclick="sendNote()">Send Note</button>
            </div>
            <div class="ai-suggestion" id="ai-suggestion">
                <div class="ai-suggestion-label">üí≠ Suggested rephrasing:</div>
                <div class="ai-suggestion-text" id="ai-suggestion-text"></div>
                <div class="suggestion-actions">
                    <button class="use-btn" onclick="useSuggestion()">Use this</button>
                    <button class="dismiss-btn" onclick="dismissSuggestion()">Keep mine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ALERTS & PARTNER MESSAGE -->
    <div class="alert-section" id="alert-section">
        <div class="combo-alert" id="combo-alert">
            <div class="combo-alert-title">üí´ A Familiar Moment</div>
            <div class="combo-alert-text" id="combo-alert-text"></div>
        </div>
        
        <div class="partner-message" id="partner-message">
            <div class="partner-message-label" id="partner-message-label">Message from your partner</div>
            <div class="partner-message-text" id="partner-message-text"></div>
            <button class="understand-btn" onclick="helpMeUnderstand()">ü§î Help me understand</button>
            <div class="understand-response" id="understand-response">
                <div class="understand-text" id="understand-text"></div>
            </div>
        </div>
    </div>

    <!-- 6. CONTEXTUAL INSIGHT -->
    <div class="insight-panel" id="insight-panel">
        <div class="insight-header">
            <div class="insight-title" id="insight-title">Understanding This Moment</div>
            <button class="insight-close" onclick="closeInsight()">‚úï</button>
        </div>
        <div class="insight-grid">
            <div class="insight-card for-me">
                <h4 id="insight-label-1">Reminder for Me</h4>
                <p id="insight-text-1"></p>
            </div>
            <div class="insight-card for-you">
                <h4 id="insight-label-2">What They'll See</h4>
                <p id="insight-text-2"></p>
            </div>
        </div>
    </div>

    <!-- 7. AI INSIGHTS & WEEKLY -->
    <div class="ai-section">
        <div class="ai-card">
            <div class="ai-card-header">
                <span class="ai-card-icon">‚ú®</span>
                <span class="ai-card-title">Pattern Insights</span>
                <button class="refresh-btn" onclick="generateInsights()">Refresh</button>
            </div>
            <div class="ai-loading" id="insights-loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
            <div class="ai-card-content" id="ai-insights-text">
                Select your identity to see personalized insights.
            </div>
        </div>
        <div class="ai-card weekly">
            <div class="ai-card-header">
                <span class="ai-card-icon">üìù</span>
                <span class="ai-card-title">This Week</span>
            </div>
            <div class="ai-loading" id="weekly-loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
            <div class="ai-card-content" id="weekly-text">
                Your weekly reflection will appear once you have some mood history.
            </div>
        </div>
    </div>

    <!-- 8. MOOD CALENDAR (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üìÖ</span>
                <span class="collapsible-title">Mood History</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="calendar-legend">
                    <span class="legend-item"><span class="emoji">üåø</span> Space</span>
                    <span class="legend-item"><span class="emoji">üåä</span> Anxious/Overwhelmed</span>
                    <span class="legend-item"><span class="emoji">üå´Ô∏è</span> Disconnected</span>
                    <span class="legend-item"><span class="emoji">üå∏</span> Reconnect</span>
                    <span class="legend-item"><span class="emoji">‚òÄÔ∏è</span> All Good</span>
                </div>
                <div class="calendar-container" id="mood-calendar">
                    <div class="no-history">No mood history yet. Start sharing how you feel!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. VENN DIAGRAM (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">‚ô°</span>
                <span class="collapsible-title">About Us</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="venn-container">
                    <div class="circle circle-me"></div>
                    <div class="circle circle-you"></div>

                    <div class="content-card card-me">
                        <div class="card-title">Me</div>
                        <div class="card-subtitle">Connection Seeking ¬∑ Expressive</div>
                        <ul class="traits">
                            <li>Thrives on emotional closeness</li>
                            <li>Processes feelings through conversation</li>
                            <li>Finds security in consistent connection</li>
                            <li>May feel unsettled by silence</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Feels loved through</span>
                            <div class="section-content">Acts of service, words of affirmation</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">Working on</span>
                            <div class="growth-item">Trusting that space ‚â† rejection</div>
                        </div>
                    </div>

                    <div class="overlap-card">
                        <div class="overlap-title">Shared Space</div>
                        <span class="overlap-icon">‚ô°</span>
                        <ul class="overlap-traits">
                            <li>Physical presence settles us both</li>
                            <li>Walls come down when we're together</li>
                            <li>Same need, different languages</li>
                            <li>Both more invested than we show</li>
                            <li>We thrive in quiet, unplanned moments</li>
                        </ul>
                        <div class="shared-lang">
                            <span class="shared-lang-label">Shared love languages</span>
                            Words of affirmation & acts of service
                        </div>
                    </div>

                    <div class="content-card card-you">
                        <div class="card-title">You</div>
                        <div class="card-subtitle">Autonomy Valuing ¬∑ Reflective</div>
                        <ul class="traits">
                            <li>Feels deeply, processes internally</li>
                            <li>Recharges through solitude</li>
                            <li>Values independence within connection</li>
                            <li>Shows care through presence and actions</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Feels loved through</span>
                            <div class="section-content">Words of affirmation, physical touch</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">What helps</span>
                            <div class="growth-item">Naming the return: "I'll be back"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. WHAT HELPS US (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üí°</span>
                <span class="collapsible-title">What Helps Us</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="helps-grid">
                    <div class="helps-column">
                        <h3>For Her</h3>
                        <ul>
                            <li>Trust that he'll come back</li>
                            <li>Self soothe before reaching out</li>
                            <li>Build a rich life outside us</li>
                            <li>His space isn't about me</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>For Us</h3>
                        <ul>
                            <li>"I feel..." instead of "You always..."</li>
                            <li>20 min to cool off, then reconnect</li>
                            <li>Weekly check ins reduce surprises</li>
                            <li>Balance "us time" and "me time"</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>For Him</h3>
                        <ul>
                            <li>Small, consistent gestures matter</li>
                            <li>Name when you're coming back</li>
                            <li>Proactive reassurance builds trust</li>
                            <li>Stay 10% longer in hard moments</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyDivrvDQijdlHP6nFOBlQB7eAOf8WFo_GA",
            authDomain: "attachmentstyles-b807c.firebaseapp.com",
            databaseURL: "https://attachmentstyles-b807c-default-rtdb.firebaseio.com",
            projectId: "attachmentstyles-b807c",
            storageBucket: "attachmentstyles-b807c.firebasestorage.app",
            messagingSenderId: "619137221036",
            appId: "1:619137221036:web:905bcdec602659048d7a09"
        };

        const isFirebaseConfigured = !firebaseConfig.apiKey.includes("YOUR_");

        let db = null;
        let roomRef = null;
        let historyRef = null;
        let currentIdentity = null;
        let roomId = null;
        let currentMoodKey = null;
        let previousData = {};
        let moodHistory = [];

        // ============ MOOD DATA ============
        const moodEmojis = {
            space: 'üåø',
            anxious: 'üåä',
            overwhelmed: 'üåä',
            disconnected: 'üå´Ô∏è',
            reconnect: 'üå∏',
            good: '‚òÄÔ∏è'
        };

        const moodData = {
            me: {
                space: {
                    label: "Need space, but okay",
                    message: "I just need a little quiet time to recharge. This isn't about you. I'll be back soon.",
                    insightTitle: "When I Need Space",
                    insightMe: "This is healthy! Take this time to do something that fills your cup.",
                    insightYou: "She's practicing self regulation. A simple 'take your time' means a lot."
                },
                anxious: {
                    label: "Feeling anxious",
                    message: "I'm feeling a bit anxious right now. I don't need you to fix it. Just knowing you're there helps.",
                    insightTitle: "When I'm Feeling Anxious",
                    insightMe: "Notice this feeling without acting on it. Try 5 deep breaths first.",
                    insightYou: "She's being vulnerable. A heart emoji or 'I'm here' goes far."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I'm feeling a bit distant from us. I'd love some quality time when you're ready.",
                    insightTitle: "When I Feel Disconnected",
                    insightMe: "Ask: am I seeking connection or seeking reassurance?",
                    insightYou: "She's missing you. Low pressure togetherness would help."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to connect. No pressure, just wanted you to know. ‚ô°",
                    insightTitle: "Ready to Reconnect",
                    insightMe: "Stay open without attaching to a specific outcome.",
                    insightYou: "This is an invitation, not a demand. Now's a good moment."
                },
                good: {
                    label: "All good ‚ô°",
                    message: "Feeling good and settled. Just wanted you to know all is well. ‚ô°",
                    insightTitle: "All Good",
                    insightMe: "Notice what contributed to this feeling.",
                    insightYou: "She's content. No action needed. Just receive this."
                }
            },
            you: {
                space: {
                    label: "Need space, but okay",
                    message: "I'm taking some time to recharge. This isn't distance, it's how I process. I'll be back.",
                    insightTitle: "When He Needs Space",
                    insightMe: "His space is not about me. Do something nourishing for yourself.",
                    insightYou: "Naming when you'll return helps her nervous system settle."
                },
                overwhelmed: {
                    label: "Feeling overwhelmed",
                    message: "Feeling a bit overwhelmed right now. I need to step back and recalibrate.",
                    insightTitle: "When He's Overwhelmed",
                    insightMe: "His withdrawal isn't punishment, it's protection. Don't chase.",
                    insightYou: "A small gesture when you're ready bridges the gap."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I've been in my own world lately. It's not intentional. I want to find our way back.",
                    insightTitle: "When He Feels Disconnected",
                    insightMe: "He's naming it, that's huge. Let him lead the reconnection.",
                    insightYou: "She'll appreciate you naming this."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to be close. Just wanted you to know I'm here.",
                    insightTitle: "When He's Ready to Reconnect",
                    insightMe: "Receive this. Don't overwhelm the moment. Match his pace.",
                    insightYou: "Your presence is the gift."
                },
                good: {
                    label: "All good ‚ô°",
                    message: "I'm good. Feeling settled and close to you. ‚ô°",
                    insightTitle: "All Good",
                    insightMe: "Soak this in. This is what secure feels like.",
                    insightYou: "Enjoy this moment of peace together."
                }
            }
        };

        // ============ INITIALIZATION ============
        function init() {
            // Check for saved room first
            const savedRoom = localStorage.getItem('lastRoom');
            const urlParams = new URLSearchParams(window.location.search);
            
            // Priority: URL param > saved room > new room
            if (urlParams.get('room')) {
                roomId = urlParams.get('room');
            } else if (savedRoom) {
                roomId = savedRoom;
                document.getElementById('returning-note').classList.add('visible');
            } else {
                roomId = generateRoomId();
            }
            
            // Update URL and save
            window.history.replaceState({}, '', `?room=${roomId}`);
            localStorage.setItem('lastRoom', roomId);
            
            // Load room name
            const savedName = localStorage.getItem('roomName_' + roomId);
            document.getElementById('room-name').textContent = savedName || 'Our Space';
            
            // Update share link
            document.getElementById('share-link').value = window.location.href;

            if (isFirebaseConfigured) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                roomRef = db.ref('rooms/' + roomId);
                historyRef = db.ref('history/' + roomId);
                
                roomRef.on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    updateLiveStatus(data);
                    checkForComboAlert(data);
                });

                historyRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                    const history = [];
                    snapshot.forEach((child) => history.push(child.val()));
                    moodHistory = history;
                    updateMoodCalendar(history);
                    
                    if (currentIdentity && history.length >= 3) {
                        setTimeout(generateInsights, 500);
                        setTimeout(generateWeeklyReflection, 1000);
                    }
                });

                db.ref('.info/connected').on('value', (snap) => {
                    const dot = document.getElementById('connection-dot');
                    dot.classList.toggle('connected', snap.val());
                });
            }

            // Load saved identity
            const savedIdentity = localStorage.getItem('identity_' + roomId);
            if (savedIdentity) {
                selectIdentity(savedIdentity, true);
            }
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // ============ ROOM MANAGEMENT ============
        function editRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
        }

        function saveRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            const name = input.value.trim() || 'Our Space';
            display.textContent = name;
            display.style.display = 'inline';
            input.style.display = 'none';
            localStorage.setItem('roomName_' + roomId, name);
        }

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('visible');
            
            // Generate QR code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(window.location.href, { width: 160, margin: 2 }, (err, canvas) => {
                    if (!err) qrContainer.appendChild(canvas);
                });
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('visible');
        }

        function copyLink() {
            const link = document.getElementById('share-link').value;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.querySelector('.copy-link-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }

        function shareViaText() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`sms:?body=Join our relationship space "${name}": ${link}`);
        }

        function shareViaEmail() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`mailto:?subject=Join our space&body=Here's our relationship check-in space "${name}": ${link}`);
        }

        function createNewRoom() {
            if (confirm('Create a new room? You can always come back to this one using the link.')) {
                localStorage.removeItem('lastRoom');
                localStorage.removeItem('identity_' + roomId);
                window.location.href = window.location.pathname;
            }
        }

        // ============ IDENTITY ============
        function selectIdentity(identity, silent = false) {
            currentIdentity = identity;
            localStorage.setItem('identity_' + roomId, identity);

            // Update UI
            document.querySelectorAll('.identity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.identity-btn.${identity}`).classList.add('active');
            
            // Show badge
            const badge = document.getElementById('identity-badge');
            badge.textContent = identity === 'me' ? 'Her' : 'Him';
            badge.className = `identity-badge ${identity}`;
            badge.style.display = 'inline-block';

            // Hide welcome after selection
            if (!silent) {
                document.getElementById('welcome-card').style.display = 'none';
            }

            // Show mood section
            document.getElementById('mood-section').classList.add('visible');
            populateMoodButtons();

            if (!silent) {
                document.getElementById('mood-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function populateMoodButtons() {
            const container = document.getElementById('mood-buttons');
            const moods = moodData[currentIdentity];
            container.innerHTML = '';
            
            // Check for existing mood today
            let todayMood = null;
            if (previousData && previousData[currentIdentity]) {
                const ts = previousData[currentIdentity].timestamp;
                if (new Date(ts).toDateString() === new Date().toDateString()) {
                    todayMood = previousData[currentIdentity].mood;
                    currentMoodKey = todayMood;
                    document.getElementById('note-box').classList.add('visible');
                }
            }

            Object.keys(moods).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'mood-btn';
                btn.textContent = moods[key].label;
                btn.onclick = function() { selectMood(key, this); };
                if (key === todayMood) {
                    btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');
                }
                container.appendChild(btn);
            });
        }

        // ============ MOOD SELECTION ============
        function selectMood(moodKey, btn) {
            currentMoodKey = moodKey;
            const mood = moodData[currentIdentity][moodKey];

            // Update buttons
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active-me', 'active-you'));
            btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');

            // Show note box
            document.getElementById('note-box').classList.add('visible');
            document.getElementById('note-input').value = '';

            // Floating hearts for "good"
            if (moodKey === 'good') createFloatingHearts(btn);

            // Save
            const update = {
                mood: moodKey,
                label: mood.label,
                message: mood.message,
                customNote: '',
                timestamp: Date.now()
            };

            if (roomRef) {
                roomRef.child(currentIdentity).set(update);
                historyRef.push({
                    person: currentIdentity,
                    mood: moodKey,
                    label: mood.label,
                    emoji: moodEmojis[moodKey],
                    timestamp: Date.now()
                });
            }

            showInsight(currentIdentity, moodKey, false);
        }

        function sendNote() {
            const note = document.getElementById('note-input').value.trim();
            if (!currentMoodKey) return;

            const mood = moodData[currentIdentity][currentMoodKey];
            const update = {
                mood: currentMoodKey,
                label: mood.label,
                message: mood.message,
                customNote: note,
                timestamp: Date.now()
            };

            if (roomRef) {
                roomRef.child(currentIdentity).set(update).then(() => {
                    document.getElementById('note-input').value = '';
                    document.getElementById('note-input').placeholder = 'Sent! ‚ô°';
                    setTimeout(() => {
                        document.getElementById('note-input').placeholder = 'Anything else you want to share...';
                    }, 2000);
                });
            }
        }

        function createFloatingHearts(el) {
            const rect = el.getBoundingClientRect();
            const container = document.createElement('div');
            container.className = 'floating-hearts';
            container.style.left = rect.left + rect.width / 2 + 'px';
            container.style.top = rect.top + 'px';
            document.body.appendChild(container);

            const hearts = ['‚ô°', 'üíï', '‚ú®', 'üíó'];
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const heart = document.createElement('span');
                    heart.className = 'floating-heart';
                    heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                    heart.style.left = (Math.random() - 0.5) * 50 + 'px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 2000);
                }, i * 80);
            }
            setTimeout(() => container.remove(), 2500);
        }

        // ============ LIVE STATUS ============
        function updateLiveStatus(data) {
            ['me', 'you'].forEach(person => {
                const moodEl = document.getElementById(`live-mood-${person}`);
                const timeEl = document.getElementById(`live-time-${person}`);
                const card = moodEl.closest('.live-status-card');

                if (data && data[person]) {
                    const isNew = !previousData[person] || previousData[person].timestamp !== data[person].timestamp;
                    
                    moodEl.textContent = data[person].label;
                    moodEl.classList.add('active');
                    card.classList.add('has-mood');
                    
                    if (isNew) {
                        card.classList.remove('just-updated');
                        void card.offsetWidth;
                        card.classList.add('just-updated');
                    }

                    timeEl.textContent = formatTime(new Date(data[person].timestamp));

                    if (currentIdentity && person !== currentIdentity) {
                        showPartnerMessage(data[person]);
                    }
                } else {
                    moodEl.textContent = 'No status yet';
                    moodEl.classList.remove('active');
                    card.classList.remove('has-mood');
                    timeEl.textContent = '';
                }
            });
            previousData = JSON.parse(JSON.stringify(data || {}));
        }

        function formatTime(date) {
            const diff = Date.now() - date;
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function showPartnerMessage(data) {
            const container = document.getElementById('partner-message');
            const label = document.getElementById('partner-message-label');
            const text = document.getElementById('partner-message-text');
            const partnerIs = currentIdentity === 'me' ? 'Him' : 'Her';

            label.textContent = `Message from ${partnerIs}`;
            let html = data.message;
            if (data.customNote) {
                html += `<div class="custom-note"><span class="custom-note-label">Added:</span>${data.customNote}</div>`;
            }
            text.innerHTML = html;
            container.classList.add('visible');
            
            // Show insight for partner's mood
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';
            showInsight(partnerIdentity, data.mood, true);
        }

        // ============ INSIGHTS ============
        function showInsight(person, moodKey, isPartner = false) {
            const mood = moodData[person] && moodData[person][moodKey];
            if (!mood) return;

            document.getElementById('insight-title').textContent = mood.insightTitle;
            
            const label1 = document.getElementById('insight-label-1');
            const label2 = document.getElementById('insight-label-2');
            const text1 = document.getElementById('insight-text-1');
            const text2 = document.getElementById('insight-text-2');

            if (isPartner) {
                const who = person === 'me' ? 'She' : 'He';
                label1.textContent = `What ${who}'s Saying`;
                label2.textContent = 'How I Can Help';
                text1.textContent = mood.message;
                text2.textContent = person === 'me' ? mood.insightYou : mood.insightMe;
            } else {
                label1.textContent = 'Reminder for Me';
                label2.textContent = 'What They\'ll See';
                text1.textContent = person === 'me' ? mood.insightMe : mood.insightYou;
                text2.textContent = mood.message;
            }

            document.getElementById('insight-panel').classList.add('visible');
        }

        function closeInsight() {
            document.getElementById('insight-panel').classList.remove('visible');
        }

        // ============ COMBO ALERTS ============
        function checkForComboAlert(data) {
            if (!data.me || !data.you) return;

            const alert = document.getElementById('combo-alert');
            const text = document.getElementById('combo-alert-text');
            const tension = ['anxious', 'overwhelmed', 'disconnected'];

            if (tension.includes(data.me.mood) && tension.includes(data.you.mood)) {
                alert.classList.add('visible');
                text.textContent = "You're both in a tender spot. Try the 20 minute rule: take space, then come back with curiosity. You've navigated this before.";
            } else if (data.me.mood === 'anxious' && (data.you.mood === 'space' || data.you.mood === 'overwhelmed')) {
                alert.classList.add('visible');
                text.textContent = "A familiar dance: she's reaching, he's retreating. His space isn't rejection, her reaching isn't pressure. Give it an hour.";
            } else if (data.me.mood === 'good' && data.you.mood === 'good') {
                alert.classList.add('visible');
                text.textContent = "‚òÄÔ∏è You're both feeling good. Soak it in. This is what you're building toward.";
                setTimeout(() => alert.classList.remove('visible'), 5000);
            } else {
                alert.classList.remove('visible');
            }
        }

        // ============ AI FEATURES ============
        const AI_CONTEXT = `You are a warm relationship coach helping an anxious-avoidant couple. 
        She is anxious-leaning (needs reassurance). He is avoidant-leaning (needs space).
        Keep responses brief (2-3 sentences), warm, and actionable.`;

        async function callAI(prompt) {
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 250,
                        system: AI_CONTEXT,
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                return data.content?.[0]?.text || null;
            } catch (e) {
                console.error('AI error:', e);
                return null;
            }
        }

        let currentSuggestion = '';

        async function improveMessage() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (!text) {
                input.placeholder = 'Write something first';
                setTimeout(() => input.placeholder = 'Anything else you want to share...', 2000);
                return;
            }

            const box = document.getElementById('ai-suggestion');
            const suggestionText = document.getElementById('ai-suggestion-text');
            box.classList.add('visible');
            suggestionText.textContent = 'Thinking...';

            const target = currentIdentity === 'me' ? 'an avoidant partner' : 'an anxious partner';
            const result = await callAI(`Rephrase this to land better with ${target}: "${text}". Just the rephrased message.`);
            
            if (result) {
                currentSuggestion = result;
                suggestionText.textContent = result;
            } else {
                box.classList.remove('visible');
            }
        }

        function useSuggestion() {
            if (currentSuggestion) document.getElementById('note-input').value = currentSuggestion;
            dismissSuggestion();
        }

        function dismissSuggestion() {
            document.getElementById('ai-suggestion').classList.remove('visible');
            currentSuggestion = '';
        }

        async function helpMeUnderstand() {
            const response = document.getElementById('understand-response');
            const text = document.getElementById('understand-text');
            response.classList.add('visible');
            text.textContent = 'Thinking...';

            const partner = currentIdentity === 'me' ? 'you' : 'me';
            const data = previousData[partner];
            if (!data) {
                text.textContent = "Your partner hasn't shared yet.";
                return;
            }

            const type = partner === 'me' ? 'anxious-leaning (she)' : 'avoidant-leaning (he)';
            const result = await callAI(`My ${type} partner shared: "${data.label}". Message: "${data.message}". ${data.customNote ? `Note: "${data.customNote}"` : ''} What do they need and what's one thing I can do?`);
            text.textContent = result || "Try responding to what they asked for directly.";
        }

        async function generateInsights() {
            if (!currentIdentity || moodHistory.length < 3) {
                document.getElementById('ai-insights-text').textContent = 'Keep logging moods to see patterns!';
                return;
            }

            document.getElementById('insights-loading').classList.add('visible');
            document.getElementById('ai-insights-text').style.display = 'none';

            const summary = moodHistory.slice(-15).map(h => `${h.person === 'me' ? 'Her' : 'Him'}: ${h.label}`).join(', ');
            const who = currentIdentity === 'me' ? 'Her (anxious)' : 'Him (avoidant)';
            
            const result = await callAI(`Mood history: ${summary}. I'm ${who}. One encouraging pattern insight. Start with emoji.`);
            
            document.getElementById('insights-loading').classList.remove('visible');
            const textEl = document.getElementById('ai-insights-text');
            textEl.style.display = 'block';
            textEl.textContent = result || "‚ú® You're both showing up. That's the foundation.";
        }

        async function generateWeeklyReflection() {
            const week = moodHistory.filter(h => h.timestamp > Date.now() - 7 * 24 * 60 * 60 * 1000);
            if (week.length < 3) {
                document.getElementById('weekly-text').textContent = 'Keep checking in to see your weekly reflection!';
                return;
            }

            document.getElementById('weekly-loading').classList.add('visible');
            document.getElementById('weekly-text').style.display = 'none';

            const good = week.filter(h => h.mood === 'good' || h.mood === 'reconnect').length;
            const hard = week.filter(h => ['anxious', 'overwhelmed', 'disconnected'].includes(h.mood)).length;
            
            const result = await callAI(`This week: ${good} good moments, ${hard} harder ones. Write a warm 2 sentence reflection. Start with emoji.`);
            
            document.getElementById('weekly-loading').classList.remove('visible');
            const textEl = document.getElementById('weekly-text');
            textEl.style.display = 'block';
            textEl.textContent = result || `üìù ${good} good moments this week. You're showing up for each other.`;
        }

        // ============ MOOD CALENDAR ============
        function updateMoodCalendar(history) {
            const container = document.getElementById('mood-calendar');
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="no-history">No mood history yet.</div>';
                return;
            }

            const grouped = {};
            history.forEach(h => {
                const key = new Date(h.timestamp).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(h);
            });

            const sorted = Object.keys(grouped).sort((a, b) => 
                new Date(grouped[b][0].timestamp) - new Date(grouped[a][0].timestamp)
            );

            let html = '';
            sorted.slice(0, 10).forEach((day, i) => {
                const entries = grouped[day].sort((a, b) => b.timestamp - a.timestamp);
                html += `<div class="calendar-day" style="animation-delay: ${i * 0.05}s">
                    <div class="calendar-date">${day}</div>
                    <div class="calendar-moods">`;
                entries.forEach(e => {
                    const time = new Date(e.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    html += `<div class="calendar-mood-entry ${e.person}">
                        <span class="entry-emoji">${e.emoji || moodEmojis[e.mood]}</span>
                        <span>${e.person === 'me' ? 'Her' : 'Him'}</span>
                        <span class="entry-time">${time}</span>
                    </div>`;
                });
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        // ============ COLLAPSIBLE SECTIONS ============
        function toggleSection(header) {
            header.classList.toggle('open');
            header.nextElementSibling.classList.toggle('open');
        }

        // Initialize
        init();
    </script>
</body>
</html>