<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script>
        // Initialize CONFIG - will be overridden by config.js if it loads
        var CONFIG = { ANTHROPIC_API_KEY: "YOUR_ANTHROPIC_API_KEY_HERE" };
    </script>
    <script src="config.js" onerror="console.log('Note: config.js not loaded (this is normal when opening file directly). AI features will use embedded config or be disabled.')"></script>
</head>
<body>
    <h1>Relationship Styles</h1>
    <p class="subtitle">A shared space for understanding each other</p>

    <!-- 1. ROOM BAR (Sticky) -->
    <div class="room-bar" id="room-bar">
        <div class="room-bar-top">
            <div class="room-identity">
                <div class="connection-dot" id="connection-dot"></div>
                <div class="room-name-display">
                    <span class="room-name" id="room-name">Our Space</span>
                    <button class="room-name-edit" onclick="editRoomName()">‚úèÔ∏è</button>
                    <input type="text" class="room-name-input" id="room-name-input" maxlength="20" onblur="saveRoomName()" onkeypress="if(event.key==='Enter')saveRoomName()">
                </div>
                <span class="identity-badge" id="identity-badge" style="display: none;"></span>
            </div>
            <div class="share-actions">
                <button class="share-btn" onclick="openShareModal()">üì§ Share</button>
                <button class="share-btn" onclick="createNewRoom()">+ New Room</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-title">Share This Space</div>
            <div class="share-modal-subtitle">Send this link to your partner so you can connect</div>
            <div class="qr-code" id="qr-code"></div>
            <div class="share-link-box">
                <input type="text" class="share-link-input" id="share-link" readonly>
                <button class="copy-link-btn" onclick="copyLink()">Copy</button>
            </div>
            <div class="share-options">
                <button class="share-option-btn" onclick="shareViaText()">üí¨ Text</button>
                <button class="share-option-btn" onclick="shareViaEmail()">üìß Email</button>
            </div>
            <button class="close-modal-btn" onclick="closeShareModal()">Done</button>
        </div>
    </div>

    <!-- 2. WELCOME / IDENTITY SELECTOR -->
    <div class="welcome-card" id="welcome-card">
        <div class="welcome-title">Welcome</div>
        <div class="welcome-subtitle">Who's checking in?</div>
        <div class="identity-buttons">
            <button class="identity-btn me" onclick="selectIdentity('me')">I'm Her</button>
            <button class="identity-btn you" onclick="selectIdentity('you')">I'm Him</button>
        </div>
        <div class="returning-user-note" id="returning-note">
            ‚úì Welcome back! We remembered your room.
        </div>
    </div>

    <!-- 3. LIVE STATUS CARDS -->
    <div class="status-section">
        <div class="live-status">
            <div class="live-status-card me-card">
                <div class="live-status-name">Her</div>
                <div class="live-status-mood" id="live-mood-me">No status yet</div>
                <div class="live-status-time" id="live-time-me"></div>
            </div>
            <div class="live-status-card you-card">
                <div class="live-status-name">Him</div>
                <div class="live-status-mood" id="live-mood-you">No status yet</div>
                <div class="live-status-time" id="live-time-you"></div>
            </div>
        </div>
    </div>

    <!-- 4. MOOD SELECTOR -->
    <div class="mood-section" id="mood-section">
        <div class="mood-header">How are you feeling right now?</div>
        <div class="mood-buttons" id="mood-buttons"></div>
        
        <div class="note-box" id="note-box">
            <label>Add a personal note (optional)</label>
            <textarea id="note-input" placeholder="Anything else you want to share..."></textarea>
            <div class="note-actions">
                <button class="ai-rephrase-btn" onclick="improveMessage()">‚ú® Help me say this better</button>
                <button class="send-note-btn" onclick="sendNote()">Send Note</button>
            </div>
            <div class="ai-suggestion" id="ai-suggestion">
                <div class="ai-suggestion-label">üí≠ Suggested rephrasing:</div>
                <div class="ai-suggestion-text" id="ai-suggestion-text"></div>
                <div class="suggestion-actions">
                    <button class="use-btn" onclick="useSuggestion()">Use this</button>
                    <button class="dismiss-btn" onclick="dismissSuggestion()">Keep mine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ALERTS & PARTNER MESSAGE -->
    <div class="alert-section" id="alert-section">
        <div class="combo-alert" id="combo-alert">
            <div class="combo-alert-title">üí´ A Familiar Moment</div>
            <div class="combo-alert-text" id="combo-alert-text"></div>
        </div>
        
        <div class="partner-message" id="partner-message">
            <div class="partner-message-label" id="partner-message-label">Message from your partner</div>
            <div class="partner-message-text" id="partner-message-text"></div>
            <button class="understand-btn" onclick="helpMeUnderstand()">ü§î Help me understand</button>
            <div class="understand-response" id="understand-response">
                <div class="understand-text" id="understand-text"></div>
            </div>
        </div>
    </div>

    <!-- 6. CONTEXTUAL INSIGHT -->
    <div class="insight-panel" id="insight-panel">
        <div class="insight-header">
            <div class="insight-title" id="insight-title">Understanding This Moment</div>
            <button class="insight-close" onclick="closeInsight()">‚úï</button>
        </div>
        <div class="insight-grid">
            <div class="insight-card for-me">
                <h4 id="insight-label-1">Reminder for Me</h4>
                <p id="insight-text-1"></p>
            </div>
            <div class="insight-card for-you">
                <h4 id="insight-label-2">What They'll See</h4>
                <p id="insight-text-2"></p>
            </div>
        </div>
    </div>

    <!-- 7. AI INSIGHTS & WEEKLY -->
    <div class="ai-section">
        <div class="ai-card">
            <div class="ai-card-header">
                <span class="ai-card-icon">‚ú®</span>
                <span class="ai-card-title">Pattern Insights</span>
                <button class="refresh-btn" onclick="generateInsights()">Refresh</button>
            </div>
            <div class="ai-loading" id="insights-loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
            <div class="ai-card-content" id="ai-insights-text">
                Select your identity to see personalized insights.
            </div>
        </div>
        <div class="ai-card weekly">
            <div class="ai-card-header">
                <span class="ai-card-icon">üìù</span>
                <span class="ai-card-title">This Week</span>
            </div>
            <div class="ai-loading" id="weekly-loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
            <div class="ai-card-content" id="weekly-text">
                Your weekly reflection will appear once you have some mood history.
            </div>
        </div>
    </div>

    <!-- 8. MOOD CALENDAR (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üìÖ</span>
                <span class="collapsible-title">Mood History</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="calendar-legend">
                    <span class="legend-item"><span class="emoji">üåø</span> Space</span>
                    <span class="legend-item"><span class="emoji">üåä</span> Anxious/Overwhelmed</span>
                    <span class="legend-item"><span class="emoji">üå´Ô∏è</span> Disconnected</span>
                    <span class="legend-item"><span class="emoji">üå∏</span> Reconnect</span>
                    <span class="legend-item"><span class="emoji">‚òÄÔ∏è</span> All Good</span>
                </div>
                <div class="calendar-container" id="mood-calendar">
                    <div class="no-history">No mood history yet. Start sharing how you feel!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. VENN DIAGRAM (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">‚ô°</span>
                <span class="collapsible-title">About Us</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="venn-container">
                    <div class="circle circle-me"></div>
                    <div class="circle circle-you"></div>

                    <div class="content-card card-me">
                        <div class="card-title">Me</div>
                        <div class="card-subtitle">Connection Seeking ¬∑ Expressive</div>
                        <ul class="traits">
                            <li>Thrives on emotional closeness</li>
                            <li>Processes feelings through conversation</li>
                            <li>Finds security in consistent connection</li>
                            <li>May feel unsettled by silence</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Feels loved through</span>
                            <div class="section-content">Acts of service, words of affirmation</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">Working on</span>
                            <div class="growth-item">Trusting that space ‚â† rejection</div>
                        </div>
                    </div>

                    <div class="overlap-card">
                        <div class="overlap-title">Shared Space</div>
                        <span class="overlap-icon">‚ô°</span>
                        <ul class="overlap-traits">
                            <li>Physical presence settles us both</li>
                            <li>Walls come down when we're together</li>
                            <li>Same need, different languages</li>
                            <li>Both more invested than we show</li>
                            <li>We thrive in quiet, unplanned moments</li>
                        </ul>
                        <div class="shared-lang">
                            <span class="shared-lang-label">Shared love languages</span>
                            Words of affirmation & acts of service
                        </div>
                    </div>

                    <div class="content-card card-you">
                        <div class="card-title">You</div>
                        <div class="card-subtitle">Autonomy Valuing ¬∑ Reflective</div>
                        <ul class="traits">
                            <li>Feels deeply, processes internally</li>
                            <li>Recharges through solitude</li>
                            <li>Values independence within connection</li>
                            <li>Shows care through presence and actions</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Feels loved through</span>
                            <div class="section-content">Words of affirmation, physical touch</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">What helps</span>
                            <div class="growth-item">Naming the return: "I'll be back"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. WHAT HELPS US (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üí°</span>
                <span class="collapsible-title">What Helps Us</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="helps-grid">
                    <div class="helps-column">
                        <h3>For Her</h3>
                        <ul>
                            <li>Trust that he'll come back</li>
                            <li>Self soothe before reaching out</li>
                            <li>Build a rich life outside us</li>
                            <li>His space isn't about me</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>For Us</h3>
                        <ul>
                            <li>"I feel..." instead of "You always..."</li>
                            <li>20 min to cool off, then reconnect</li>
                            <li>Weekly check ins reduce surprises</li>
                            <li>Balance "us time" and "me time"</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>For Him</h3>
                        <ul>
                            <li>Small, consistent gestures matter</li>
                            <li>Name when you're coming back</li>
                            <li>Proactive reassurance builds trust</li>
                            <li>Stay 10% longer in hard moments</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyDivrvDQijdlHP6nFOBlQB7eAOf8WFo_GA",
            authDomain: "attachmentstyles-b807c.firebaseapp.com",
            databaseURL: "https://attachmentstyles-b807c-default-rtdb.firebaseio.com",
            projectId: "attachmentstyles-b807c",
            storageBucket: "attachmentstyles-b807c.firebasestorage.app",
            messagingSenderId: "619137221036",
            appId: "1:619137221036:web:905bcdec602659048d7a09"
        };

        const isFirebaseConfigured = !firebaseConfig.apiKey.includes("YOUR_");

        let db = null;
        let roomRef = null;
        let historyRef = null;
        let currentIdentity = null;
        let roomId = null;
        let currentMoodKey = null;
        let previousData = {};
        let moodHistory = [];

        // ============ MOOD DATA ============
        const moodEmojis = {
            space: 'üåø',
            anxious: 'üåä',
            overwhelmed: 'üåä',
            disconnected: 'üå´Ô∏è',
            reconnect: 'üå∏',
            good: '‚òÄÔ∏è'
        };

        const moodData = {
            me: {
                space: {
                    label: "Need space, but okay",
                    message: "I just need a little quiet time to recharge. This isn't about you. I'll be back soon.",
                    insightTitle: "When I Need Space",
                    insightMe: "This is healthy! Take this time to do something that fills your cup.",
                    insightYou: "She's practicing self regulation. A simple 'take your time' means a lot."
                },
                anxious: {
                    label: "Feeling anxious",
                    message: "I'm feeling a bit anxious right now. I don't need you to fix it. Just knowing you're there helps.",
                    insightTitle: "When I'm Feeling Anxious",
                    insightMe: "Notice this feeling without acting on it. Try 5 deep breaths first.",
                    insightYou: "She's being vulnerable. A heart emoji or 'I'm here' goes far."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I'm feeling a bit distant from us. I'd love some quality time when you're ready.",
                    insightTitle: "When I Feel Disconnected",
                    insightMe: "Ask: am I seeking connection or seeking reassurance?",
                    insightYou: "She's missing you. Low pressure togetherness would help."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to connect. No pressure, just wanted you to know. ‚ô°",
                    insightTitle: "Ready to Reconnect",
                    insightMe: "Stay open without attaching to a specific outcome.",
                    insightYou: "This is an invitation, not a demand. Now's a good moment."
                },
                good: {
                    label: "All good ‚ô°",
                    message: "Feeling good and settled. Just wanted you to know all is well. ‚ô°",
                    insightTitle: "All Good",
                    insightMe: "Notice what contributed to this feeling.",
                    insightYou: "She's content. No action needed. Just receive this."
                }
            },
            you: {
                space: {
                    label: "Need space, but okay",
                    message: "I'm taking some time to recharge. This isn't distance, it's how I process. I'll be back.",
                    insightTitle: "When He Needs Space",
                    insightMe: "His space is not about me. Do something nourishing for yourself.",
                    insightYou: "Naming when you'll return helps her nervous system settle."
                },
                overwhelmed: {
                    label: "Feeling overwhelmed",
                    message: "Feeling a bit overwhelmed right now. I need to step back and recalibrate.",
                    insightTitle: "When He's Overwhelmed",
                    insightMe: "His withdrawal isn't punishment, it's protection. Don't chase.",
                    insightYou: "A small gesture when you're ready bridges the gap."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I've been in my own world lately. It's not intentional. I want to find our way back.",
                    insightTitle: "When He Feels Disconnected",
                    insightMe: "He's naming it, that's huge. Let him lead the reconnection.",
                    insightYou: "She'll appreciate you naming this."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to be close. Just wanted you to know I'm here.",
                    insightTitle: "When He's Ready to Reconnect",
                    insightMe: "Receive this. Don't overwhelm the moment. Match his pace.",
                    insightYou: "Your presence is the gift."
                },
                good: {
                    label: "All good ‚ô°",
                    message: "I'm good. Feeling settled and close to you. ‚ô°",
                    insightTitle: "All Good",
                    insightMe: "Soak this in. This is what secure feels like.",
                    insightYou: "Enjoy this moment of peace together."
                }
            }
        };

        // ============ INITIALIZATION ============
        function init() {
            // Check for saved room first
            const savedRoom = localStorage.getItem('lastRoom');
            const urlParams = new URLSearchParams(window.location.search);
            
            // Priority: URL param > saved room > new room
            if (urlParams.get('room')) {
                roomId = urlParams.get('room');
            } else if (savedRoom) {
                roomId = savedRoom;
                document.getElementById('returning-note').classList.add('visible');
            } else {
                roomId = generateRoomId();
            }
            
            // Update URL and save
            window.history.replaceState({}, '', `?room=${roomId}`);
            localStorage.setItem('lastRoom', roomId);
            
            // Load room name
            const savedName = localStorage.getItem('roomName_' + roomId);
            document.getElementById('room-name').textContent = savedName || 'Our Space';
            
            // Update share link
            document.getElementById('share-link').value = window.location.href;

            if (isFirebaseConfigured) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                roomRef = db.ref('rooms/' + roomId);
                historyRef = db.ref('history/' + roomId);
                
                roomRef.on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    updateLiveStatus(data);
                    checkForComboAlert(data);
                });

                historyRef.on('value', (snapshot) => {
                    const history = [];
                    snapshot.forEach((child) => history.push(child.val()));
                    // Sort by timestamp in JavaScript instead of Firebase query
                    history.sort((a, b) => b.timestamp - a.timestamp);
                    moodHistory = history;
                    updateMoodCalendar(history);
                    
                    if (currentIdentity && history.length >= 3) {
                        setTimeout(generateInsights, 500);
                        setTimeout(generateWeeklyReflection, 1000);
                    }
                });

                db.ref('.info/connected').on('value', (snap) => {
                    const dot = document.getElementById('connection-dot');
                    dot.classList.toggle('connected', snap.val());
                });
            }

            // Load saved identity
            const savedIdentity = localStorage.getItem('identity_' + roomId);
            if (savedIdentity) {
                selectIdentity(savedIdentity, true);
            }
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // ============ ROOM MANAGEMENT ============
        function editRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
        }

        function saveRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            const name = input.value.trim() || 'Our Space';
            display.textContent = name;
            display.style.display = 'inline';
            input.style.display = 'none';
            localStorage.setItem('roomName_' + roomId, name);
        }

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('visible');

            // Generate QR code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            // Add a small delay to ensure library is loaded
            setTimeout(() => {
                try {
                    if (typeof QRCode !== 'undefined') {
                        // Create canvas element
                        const canvas = document.createElement('canvas');
                        QRCode.toCanvas(canvas, window.location.href, {
                            width: 160,
                            margin: 2,
                            color: {
                                dark: '#4a4a5a',
                                light: '#ffffff'
                            }
                        }, (error) => {
                            if (error) {
                                console.error('QR generation error:', error);
                                qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">QR Code generation failed<br><span style="font-size: 0.7rem;">(Copy link below instead)</span></div>';
                            } else {
                                qrContainer.appendChild(canvas);
                            }
                        });
                    } else {
                        // Library not loaded - show fallback
                        qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">QR Code library loading...<br><span style="font-size: 0.7rem;">(Use link below)</span></div>';
                        console.warn('QRCode library not loaded. Check internet connection.');
                    }
                } catch (e) {
                    console.error('QR Code error:', e);
                    qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">Error generating QR code<br><span style="font-size: 0.7rem;">(Copy link below)</span></div>';
                }
            }, 100);
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('visible');
        }

        function copyLink() {
            const link = document.getElementById('share-link').value;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.querySelector('.copy-link-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }

        function shareViaText() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`sms:?body=Join our relationship space "${name}": ${link}`);
        }

        function shareViaEmail() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`mailto:?subject=Join our space&body=Here's our relationship check-in space "${name}": ${link}`);
        }

        function createNewRoom() {
            if (confirm('Create a new room? You can always come back to this one using the link.')) {
                localStorage.removeItem('lastRoom');
                localStorage.removeItem('identity_' + roomId);
                window.location.href = window.location.pathname;
            }
        }

        // ============ IDENTITY ============
        function selectIdentity(identity, silent = false) {
            currentIdentity = identity;
            localStorage.setItem('identity_' + roomId, identity);

            // Update UI
            document.querySelectorAll('.identity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.identity-btn.${identity}`).classList.add('active');
            
            // Show badge
            const badge = document.getElementById('identity-badge');
            badge.textContent = identity === 'me' ? 'Her' : 'Him';
            badge.className = `identity-badge ${identity}`;
            badge.style.display = 'inline-block';

            // Hide welcome after selection
            if (!silent) {
                document.getElementById('welcome-card').style.display = 'none';
            }

            // Show mood section
            document.getElementById('mood-section').classList.add('visible');
            populateMoodButtons();

            if (!silent) {
                document.getElementById('mood-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function populateMoodButtons() {
            const container = document.getElementById('mood-buttons');
            const moods = moodData[currentIdentity];
            container.innerHTML = '';
            
            // Check for existing mood today
            let todayMood = null;
            if (previousData && previousData[currentIdentity]) {
                const ts = previousData[currentIdentity].timestamp;
                if (new Date(ts).toDateString() === new Date().toDateString()) {
                    todayMood = previousData[currentIdentity].mood;
                    currentMoodKey = todayMood;
                    document.getElementById('note-box').classList.add('visible');
                }
            }

            Object.keys(moods).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'mood-btn';
                btn.textContent = moods[key].label;
                btn.onclick = function() { selectMood(key, this); };
                if (key === todayMood) {
                    btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');
                }
                container.appendChild(btn);
            });
        }

        // ============ MOOD SELECTION ============
        function selectMood(moodKey, btn) {
            currentMoodKey = moodKey;
            const mood = moodData[currentIdentity][moodKey];

            // Update buttons
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active-me', 'active-you'));
            btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');

            // Show note box
            document.getElementById('note-box').classList.add('visible');
            document.getElementById('note-input').value = '';

            // Floating hearts for "good"
            if (moodKey === 'good') createFloatingHearts(btn);

            // Save
            const timestamp = Date.now();
            const update = {
                mood: moodKey,
                label: mood.label,
                message: mood.message,
                customNote: '',
                timestamp: timestamp
            };

            if (roomRef && historyRef) {
                // Update current mood status
                roomRef.child(currentIdentity).set(update);

                // Save to history - always save so history reflects mood changes
                const historyEntry = {
                    person: currentIdentity,
                    mood: moodKey,
                    label: mood.label,
                    emoji: moodEmojis[moodKey],
                    timestamp: timestamp
                };
                historyRef.push(historyEntry).then(() => {
                    console.log('Mood saved to history:', historyEntry);
                }).catch(err => {
                    console.error('Failed to save mood to history:', err);
                });
            } else {
                console.warn('Firebase not initialized - mood not saved');
            }

            showInsight(currentIdentity, moodKey, false);
        }

        function sendNote() {
            const note = document.getElementById('note-input').value.trim();
            if (!currentMoodKey) return;

            const mood = moodData[currentIdentity][currentMoodKey];
            const update = {
                mood: currentMoodKey,
                label: mood.label,
                message: mood.message,
                customNote: note,
                timestamp: Date.now()
            };

            if (roomRef) {
                roomRef.child(currentIdentity).set(update).then(() => {
                    document.getElementById('note-input').value = '';
                    document.getElementById('note-input').placeholder = 'Sent! ‚ô°';
                    setTimeout(() => {
                        document.getElementById('note-input').placeholder = 'Anything else you want to share...';
                    }, 2000);
                });
                // Don't save to history here - it was already saved in selectMood()
            }
        }

        function createFloatingHearts(el) {
            const rect = el.getBoundingClientRect();
            const container = document.createElement('div');
            container.className = 'floating-hearts';
            container.style.left = rect.left + rect.width / 2 + 'px';
            container.style.top = rect.top + 'px';
            document.body.appendChild(container);

            const hearts = ['‚ô°', 'üíï', '‚ú®', 'üíó'];
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const heart = document.createElement('span');
                    heart.className = 'floating-heart';
                    heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                    heart.style.left = (Math.random() - 0.5) * 50 + 'px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 2000);
                }, i * 80);
            }
            setTimeout(() => container.remove(), 2500);
        }

        // ============ LIVE STATUS ============
        function updateLiveStatus(data) {
            ['me', 'you'].forEach(person => {
                const moodEl = document.getElementById(`live-mood-${person}`);
                const timeEl = document.getElementById(`live-time-${person}`);
                const card = moodEl.closest('.live-status-card');

                if (data && data[person]) {
                    const isNew = !previousData[person] || previousData[person].timestamp !== data[person].timestamp;
                    
                    moodEl.textContent = data[person].label;
                    moodEl.classList.add('active');
                    card.classList.add('has-mood');
                    
                    if (isNew) {
                        card.classList.remove('just-updated');
                        void card.offsetWidth;
                        card.classList.add('just-updated');
                    }

                    timeEl.textContent = formatTime(new Date(data[person].timestamp));

                    if (currentIdentity && person !== currentIdentity) {
                        showPartnerMessage(data[person]);
                    }
                } else {
                    moodEl.textContent = 'No status yet';
                    moodEl.classList.remove('active');
                    card.classList.remove('has-mood');
                    timeEl.textContent = '';
                }
            });
            previousData = JSON.parse(JSON.stringify(data || {}));
        }

        function formatTime(date) {
            const diff = Date.now() - date;
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function showPartnerMessage(data) {
            const container = document.getElementById('partner-message');
            const label = document.getElementById('partner-message-label');
            const text = document.getElementById('partner-message-text');
            const partnerIs = currentIdentity === 'me' ? 'Him' : 'Her';

            label.textContent = `Message from ${partnerIs}`;
            let html = data.message;
            if (data.customNote) {
                html += `<div class="custom-note"><span class="custom-note-label">Added:</span>${data.customNote}</div>`;
            }
            text.innerHTML = html;
            container.classList.add('visible');
            
            // Show insight for partner's mood
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';
            showInsight(partnerIdentity, data.mood, true);
        }

        // ============ INSIGHTS ============
        function showInsight(person, moodKey, isPartner = false) {
            const mood = moodData[person] && moodData[person][moodKey];
            if (!mood) return;

            document.getElementById('insight-title').textContent = mood.insightTitle;
            
            const label1 = document.getElementById('insight-label-1');
            const label2 = document.getElementById('insight-label-2');
            const text1 = document.getElementById('insight-text-1');
            const text2 = document.getElementById('insight-text-2');

            if (isPartner) {
                const who = person === 'me' ? 'She' : 'He';
                label1.textContent = `What ${who}'s Saying`;
                label2.textContent = 'How I Can Help';
                text1.textContent = mood.message;
                // Show the insight for the CURRENT user (partner of the person who set the mood)
                text2.textContent = currentIdentity === 'me' ? mood.insightMe : mood.insightYou;
            } else {
                label1.textContent = 'Reminder for Me';
                label2.textContent = 'What They\'ll See';
                text1.textContent = person === 'me' ? mood.insightMe : mood.insightYou;
                text2.textContent = mood.message;
            }

            document.getElementById('insight-panel').classList.add('visible');
        }

        function closeInsight() {
            document.getElementById('insight-panel').classList.remove('visible');
        }

        // ============ COMBO ALERTS ============
        function checkForComboAlert(data) {
            if (!data.me || !data.you) return;

            const alert = document.getElementById('combo-alert');
            const text = document.getElementById('combo-alert-text');
            const tension = ['anxious', 'overwhelmed', 'disconnected'];

            if (tension.includes(data.me.mood) && tension.includes(data.you.mood)) {
                alert.classList.add('visible');
                text.textContent = "You're both in a tender spot. Try the 20 minute rule: take space, then come back with curiosity. You've navigated this before.";
            } else if (data.me.mood === 'anxious' && (data.you.mood === 'space' || data.you.mood === 'overwhelmed')) {
                alert.classList.add('visible');
                text.textContent = "A familiar dance: she's reaching, he's retreating. His space isn't rejection, her reaching isn't pressure. Give it an hour.";
            } else if (data.me.mood === 'good' && data.you.mood === 'good') {
                alert.classList.add('visible');
                text.textContent = "‚òÄÔ∏è You're both feeling good. Soak it in. This is what you're building toward.";
                setTimeout(() => alert.classList.remove('visible'), 5000);
            } else {
                alert.classList.remove('visible');
            }
        }

        // ============ AI FEATURES ============
        const AI_CONTEXT = `You are a warm relationship coach helping an anxious-avoidant couple. 
        She is anxious-leaning (needs reassurance). He is avoidant-leaning (needs space).
        Keep responses brief (2-3 sentences), warm, and actionable.`;

        async function callAI(prompt) {
            // Check if API key is configured
            if (!CONFIG || !CONFIG.ANTHROPIC_API_KEY || CONFIG.ANTHROPIC_API_KEY === "YOUR_ANTHROPIC_API_KEY_HERE") {
                console.warn('AI features disabled: No API key configured');
                return null;
            }

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": CONFIG.ANTHROPIC_API_KEY,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 250,
                        system: AI_CONTEXT,
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                return data.content?.[0]?.text || null;
            } catch (e) {
                console.error('AI error:', e);
                return null;
            }
        }

        let currentSuggestion = '';

        async function improveMessage() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (!text) {
                input.placeholder = 'Write something first';
                setTimeout(() => input.placeholder = 'Anything else you want to share...', 2000);
                return;
            }

            const box = document.getElementById('ai-suggestion');
            const suggestionText = document.getElementById('ai-suggestion-text');
            box.classList.add('visible');
            suggestionText.textContent = 'Thinking...';

            const target = currentIdentity === 'me' ? 'an avoidant partner' : 'an anxious partner';
            const result = await callAI(`Rephrase this to land better with ${target}: "${text}". Just the rephrased message.`);
            
            if (result) {
                currentSuggestion = result;
                suggestionText.textContent = result;
            } else {
                box.classList.remove('visible');
            }
        }

        function useSuggestion() {
            if (currentSuggestion) document.getElementById('note-input').value = currentSuggestion;
            dismissSuggestion();
        }

        function dismissSuggestion() {
            document.getElementById('ai-suggestion').classList.remove('visible');
            currentSuggestion = '';
        }

        async function helpMeUnderstand() {
            const response = document.getElementById('understand-response');
            const text = document.getElementById('understand-text');
            response.classList.add('visible');
            text.textContent = 'Thinking...';

            const partner = currentIdentity === 'me' ? 'you' : 'me';
            const data = previousData[partner];
            if (!data) {
                text.textContent = "Your partner hasn't shared yet.";
                return;
            }

            const type = partner === 'me' ? 'anxious-leaning (she)' : 'avoidant-leaning (he)';
            const result = await callAI(`My ${type} partner shared: "${data.label}". Message: "${data.message}". ${data.customNote ? `Note: "${data.customNote}"` : ''} What do they need and what's one thing I can do?`);
            text.textContent = result || "Try responding to what they asked for directly.";
        }

        async function generateInsights() {
            if (!currentIdentity || moodHistory.length < 3) {
                document.getElementById('ai-insights-text').textContent = 'Keep logging moods to see patterns!';
                return;
            }

            document.getElementById('insights-loading').classList.add('visible');
            document.getElementById('ai-insights-text').style.display = 'none';

            const summary = moodHistory.slice(-15).map(h => `${h.person === 'me' ? 'Her' : 'Him'}: ${h.label}`).join(', ');
            const who = currentIdentity === 'me' ? 'Her (anxious)' : 'Him (avoidant)';
            
            const result = await callAI(`Mood history: ${summary}. I'm ${who}. One encouraging pattern insight. Start with emoji.`);
            
            document.getElementById('insights-loading').classList.remove('visible');
            const textEl = document.getElementById('ai-insights-text');
            textEl.style.display = 'block';
            textEl.textContent = result || "‚ú® You're both showing up. That's the foundation.";
        }

        async function generateWeeklyReflection() {
            const week = moodHistory.filter(h => h.timestamp > Date.now() - 7 * 24 * 60 * 60 * 1000);
            if (week.length < 3) {
                document.getElementById('weekly-text').textContent = 'Keep checking in to see your weekly reflection!';
                return;
            }

            document.getElementById('weekly-loading').classList.add('visible');
            document.getElementById('weekly-text').style.display = 'none';

            const good = week.filter(h => h.mood === 'good' || h.mood === 'reconnect').length;
            const hard = week.filter(h => ['anxious', 'overwhelmed', 'disconnected'].includes(h.mood)).length;
            
            const result = await callAI(`This week: ${good} good moments, ${hard} harder ones. Write a warm 2 sentence reflection. Start with emoji.`);
            
            document.getElementById('weekly-loading').classList.remove('visible');
            const textEl = document.getElementById('weekly-text');
            textEl.style.display = 'block';
            textEl.textContent = result || `üìù ${good} good moments this week. You're showing up for each other.`;
        }

        // ============ MOOD CALENDAR ============
        function updateMoodCalendar(history) {
            const container = document.getElementById('mood-calendar');
            console.log('updateMoodCalendar called with', history?.length, 'entries:', history);

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="no-history">No mood history yet.</div>';
                return;
            }

            const grouped = {};
            history.forEach(h => {
                const key = new Date(h.timestamp).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(h);
            });

            console.log('Grouped calendar data:', grouped);

            const sorted = Object.keys(grouped).sort((a, b) => 
                new Date(grouped[b][0].timestamp) - new Date(grouped[a][0].timestamp)
            );

            let html = '';
            sorted.slice(0, 10).forEach((day, i) => {
                const entries = grouped[day].sort((a, b) => b.timestamp - a.timestamp);
                html += `<div class="calendar-day" style="animation-delay: ${i * 0.05}s">
                    <div class="calendar-date">${day}</div>
                    <div class="calendar-moods">`;
                entries.forEach(e => {
                    const time = new Date(e.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    html += `<div class="calendar-mood-entry ${e.person}">
                        <span class="entry-emoji">${e.emoji || moodEmojis[e.mood]}</span>
                        <span>${e.person === 'me' ? 'Her' : 'Him'}</span>
                        <span class="entry-time">${time}</span>
                    </div>`;
                });
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        // ============ COLLAPSIBLE SECTIONS ============
        function toggleSection(header) {
            header.classList.toggle('open');
            header.nextElementSibling.classList.toggle('open');
        }

        // Initialize
        init();
    </script>

    <!-- Footer -->
    <footer style="width: 100%; max-width: 920px; text-align: center; padding: 40px 20px 20px; margin-top: 40px; border-top: 1px solid rgba(0,0,0,0.06);">
        <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">
            Made with üíï for better understanding between partners
        </p>
        <a href="https://github.com/hereshecodes" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); text-decoration: none; color: #4a4a5a; font-size: 0.8rem; transition: all 0.2s;">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            View on GitHub
        </a>
    </footer>
</body>
</html>