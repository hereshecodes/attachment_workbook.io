<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupled Systems Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=2.1.1">
    <script>
        // Initialize CONFIG - will be overridden by config.js if it loads
        var CONFIG = { ANTHROPIC_API_KEY: "YOUR_ANTHROPIC_API_KEY_HERE" };
    </script>
    <script src="config.js" onerror="console.log('Note: config.js not loaded (this is normal when opening file directly). AI features will use embedded config or be disabled.')"></script>
</head>
<body>
    <h1>Coupled Systems Interface</h1>
    <p class="subtitle">Real-time status monitoring for bidirectional feedback loops</p>

    <!-- 1. ROOM BAR (Sticky) -->
    <div class="room-bar" id="room-bar">
        <div class="room-bar-top">
            <div class="room-identity">
                <div class="connection-dot" id="connection-dot"></div>
                <div class="room-name-display">
                    <span class="room-name" id="room-name">Node Session</span>
                    <button class="room-name-edit" onclick="editRoomName()">‚úèÔ∏è</button>
                    <input type="text" class="room-name-input" id="room-name-input" maxlength="20" onblur="saveRoomName()" onkeypress="if(event.key==='Enter')saveRoomName()">
                </div>
                <span class="identity-badge" id="identity-badge" style="display: none;"></span>
            </div>
            <button class="room-bar-toggle" onclick="toggleRoomBar()">‚ñº</button>
        </div>
        <div class="room-bar-content" id="room-bar-content">
            <div class="share-actions">
                <button class="share-btn" onclick="openAboutModal()">‚ÑπÔ∏è What Is This?</button>
                <button class="share-btn" onclick="openMusicModal()">üéµ Music</button>
                <button class="share-btn" onclick="togglePrivateNotes()">üîí Private Notes</button>
                <button class="share-btn" onclick="openMessageAnalysis()">üí¨ Message Analysis</button>
                <button class="share-btn" onclick="openTherapyExport()">üìä Therapy Export</button>
                <button class="share-btn" onclick="openDateNightIdeas()">üíù Date Ideas</button>
                <button class="share-btn" onclick="openPersonalizationSettings()">‚öôÔ∏è Config</button>
                <button class="share-btn" onclick="openShareModal()">üì§ Share URL</button>
                <button class="share-btn" onclick="createNewRoom()">+ New Session</button>
            </div>
        </div>
    </div>

    <!-- Growth Checklist Sidebar -->
    <div class="growth-sidebar" id="growth-sidebar">
        <div class="growth-sidebar-header">
            <div class="growth-sidebar-title" id="growth-sidebar-title">üéØ Active Growth Tasks</div>
            <button class="growth-sidebar-toggle" onclick="toggleGrowthSidebar()">‚Üê</button>
        </div>
        <div class="growth-sidebar-subtitle" id="growth-sidebar-subtitle">Select your identity to see personalized tasks</div>
        <div class="growth-checklist" id="growth-checklist">
            <div class="growth-loading">Select your identity (Node A or Node B) to begin...</div>
        </div>
    </div>

    <!-- Music Modal -->
    <div class="music-modal" id="music-modal">
        <div class="music-modal-content">
            <button class="close-music-btn" onclick="closeMusicModal()">‚úï</button>

            <div class="music-header">
                <h2 class="music-title">üéµ Context-Aware Music Suggestions</h2>
                <p class="music-subtitle">Curated playlists based on your current emotional states</p>
            </div>

            <div class="music-current-state">
                <div class="music-state-title">Current System State:</div>
                <div class="music-state-badges">
                    <div class="music-state-badge" id="music-my-state">Select your mood first</div>
                    <div class="music-state-badge" id="music-partner-state">Awaiting partner status</div>
                </div>
            </div>

            <div class="music-playlists" id="music-playlists">
                <div class="music-loading">Log your mood to get personalized music suggestions...</div>
            </div>

            <div class="music-note">
                <strong>How this works:</strong> Music suggestions adapt to both partners' emotional states. Links open in Spotify or your preferred music service. No tracking‚Äîjust suggestions based on proven emotion regulation research.
            </div>
        </div>
    </div>

    <!-- Message Analysis Modal -->
    <div class="music-modal" id="message-modal">
        <div class="music-modal-content">
            <button class="close-music-btn" onclick="closeMessageAnalysis()">‚úï</button>

            <div class="music-header">
                <h2 class="music-title">üí¨ Message History Analysis</h2>
                <p class="music-subtitle">Import text/message history to analyze communication patterns</p>
            </div>

            <div class="message-upload-section">
                <div class="upload-instructions">
                    <h3>How to Import:</h3>
                    <ol>
                        <li>Export your text messages (iMessage, WhatsApp, etc.) as a text file</li>
                        <li>Upload the file below</li>
                        <li>We'll analyze patterns like message frequency, response times, and communication style</li>
                    </ol>
                </div>

                <input type="file" id="message-file-input" accept=".txt,.csv" style="display: none;" onchange="processMessageFile(event)">
                <button class="upload-btn" onclick="document.getElementById('message-file-input').click()">
                    üìÅ Upload Message History
                </button>

                <div class="message-stats" id="message-stats" style="display: none;">
                    <h3>Analysis Results:</h3>
                    <div id="message-analysis-content"></div>
                </div>
            </div>

            <div class="music-note">
                <strong>Privacy:</strong> All analysis happens in your browser. No data is sent to any server. Message content is analyzed for patterns only‚Äînot stored or shared.
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="about-modal" id="about-modal">
        <div class="about-modal-content">
            <button class="close-about-btn" onclick="closeAboutModal()">‚úï</button>

            <div class="about-section">
                <h2 class="about-title">What Is This Tool?</h2>
                <p class="about-text">
                    This is a real-time emotional regulation tracker designed specifically for couples dealing with attachment pattern differences‚Äîespecially anxious-avoidant pairings.
                </p>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üéØ What It Does</h3>
                <ul class="about-list">
                    <li><strong>Tracks emotional states in real-time:</strong> Both partners log their current state (anxious, calm, overwhelmed, etc.) so you can see each other's nervous system regulation</li>
                    <li><strong>Provides context-aware insights:</strong> Get specific advice based on YOUR attachment style + YOUR PARTNER'S current state</li>
                    <li><strong>Shows objective progress:</strong> The Consistency Tracker proves emotional regulation improvements with data, not subjective feelings</li>
                    <li><strong>Prevents protest-withdraw cycles:</strong> Real-time visibility helps anxious partners see their partner hasn't disappeared, and avoidant partners understand when their silence triggers panic</li>
                    <li><strong>Identifies repair windows:</strong> Alerts you when BOTH partners are calm‚Äîthe optimal time for difficult conversations</li>
                </ul>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üß† The Science Behind It</h3>
                <p class="about-text">
                    This tool is built on 30+ years of attachment theory research (Bowlby, Ainsworth, Hazan & Shaver), Emotionally Focused Therapy (Sue Johnson), Gottman Method couples research, and Polyvagal Theory (Stephen Porges). Every percentage, insight, and suggestion is grounded in peer-reviewed research.
                </p>
                <p class="about-text">
                    The "tech/systems" language isn't arbitrary‚Äîit's designed to make emotional concepts feel concrete and debuggable for specific partner types.
                </p>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üí° Why The Tech Metaphor?</h3>
                <ul class="about-list">
                    <li><strong>Makes emotions concrete:</strong> "I'm dysregulated" ‚Üí "My system is running at high load"</li>
                    <li><strong>Removes blame:</strong> Not "you're abandoning me" ‚Üí "Pursuit-distance pattern detected‚Äîexpected system behavior"</li>
                    <li><strong>Provides actionable steps:</strong> "We need to talk" ‚Üí "Optimal repair window: both nodes regulated for 24h+"</li>
                    <li><strong>Appeals to logic:</strong> Especially helpful for avoidant partners who trust data over emotion</li>
                </ul>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üîï Zero-Notification Architecture</h3>
                <p class="about-text">
                    <strong>This system does not send notifications.</strong> No alerts, no pings, no pressure for immediate responses. The line stays open indefinitely for when partners are ready. Both nodes can process at their own pace‚Äîhours, days, or longer‚Äîwithout breaking the connection.
                </p>
                <p class="about-text">
                    Your need for space and autonomous processing is built into the core design. Check in when YOU'RE ready, not when pushed by a notification. This respects avoidant partners' need for processing time while giving anxious partners visibility without requiring active reassurance-seeking.
                </p>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üí° Engineering Note: Interface Optimization, Not Bug Fixes</h3>
                <p class="about-text">
                    This isn't about fixing bugs in each other‚Äîit's about <strong>optimizing the interface between two well-functioning systems</strong>. When Node A signals high load, Node B doesn't need to debug Node A's internals. Just acknowledge the signal and allow async processing.
                </p>
                <p class="about-text">
                    Both systems remain stable independently. The issue isn't that either system is broken‚Äîit's that they communicate in incompatible protocols. Node A sends rapid pings when anxious (connection verification), Node B interprets this as system overload and goes into buffer mode (disconnects to preserve stability). Neither is wrong‚Äîthey're just using different communication standards.
                </p>
                <p class="about-text">
                    <strong>This tool translates between protocols</strong> so both systems can maintain their optimal operating state while staying connected.
                </p>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üìä Key Features Explained</h3>
                <div class="feature-grid">
                    <div class="feature-item">
                        <div class="feature-name">üéØ Growth Tasks (Left Sidebar)</div>
                        <div class="feature-desc">Auto-generated action items based on your current patterns. Updates as you log moods.</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-name">üìà Consistency Tracker</div>
                        <div class="feature-desc">Objective proof of emotional regulation progress. Shows 7-day stability, 30-day trends, and self-soothing rate.</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-name">üè• System Health</div>
                        <div class="feature-desc">Research-based coupling probability for your attachment pairing. Shows what's working and what typically derails similar couples.</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-name">üîÑ Real-Time Status</div>
                        <div class="feature-desc">See your partner's current state without asking. Reduces anxious "are you okay?" checking and avoidant withdrawal from pressure.</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-name">üìä Mood History</div>
                        <div class="feature-desc">Visual timeline showing patterns over time. Helps identify triggers and improvements.</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-name">üíù Date Night Ideas</div>
                        <div class="feature-desc">Context-aware suggestions based on both partners' current states. No generic advice‚Äîtailored to YOUR situation right now.</div>
                    </div>
                </div>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">üöÄ How To Use This Tool</h3>
                <ol class="about-list">
                    <li><strong>Both partners create an identity:</strong> Click "I am Node A" or "I am Node B" to establish your profile</li>
                    <li><strong>Configure attachment styles:</strong> Go to ‚öôÔ∏è Config and select your attachment types (anxious, avoidant, secure, fearful)</li>
                    <li><strong>Share the URL:</strong> Click üì§ Share URL and send to your partner so you're in the same session</li>
                    <li><strong>Log your state regularly:</strong> When you feel anxious, calm, overwhelmed, etc.‚Äîlog it. The more data, the better the insights</li>
                    <li><strong>Check the insights:</strong> Look at System Monitoring, Growth Tasks, and Consistency Tracker for guidance</li>
                    <li><strong>Use repair windows:</strong> When both partners are calm, that's your green light for deeper conversations</li>
                </ol>
            </div>

            <div class="about-section">
                <h3 class="about-subtitle">‚ö†Ô∏è What This Tool Is NOT</h3>
                <ul class="about-list">
                    <li>‚ùå Not a replacement for couples therapy (but it's a great supplement)</li>
                    <li>‚ùå Not a "fix" for abuse, infidelity, or fundamental incompatibility</li>
                    <li>‚ùå Not about changing your partner‚Äîit's about understanding patterns and improving communication</li>
                    <li>‚ùå Not a monitoring tool to track your partner's every move‚Äîit's for voluntary, mutual transparency</li>
                </ul>
            </div>

            <div class="about-section about-footer">
                <p class="about-text">
                    <strong>Built with research, designed for real relationships.</strong><br>
                    All coupling probabilities and insights are based on longitudinal attachment research, not arbitrary percentages.
                </p>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-title">Share Session Endpoint</div>
            <div class="share-modal-subtitle">Send this URL to Node B to establish bidirectional connection</div>
            <div class="qr-code" id="qr-code"></div>
            <div class="share-link-box">
                <input type="text" class="share-link-input" id="share-link" readonly>
                <button class="copy-link-btn" onclick="copyLink()">Copy URL</button>
            </div>
            <div class="share-options">
                <button class="share-option-btn" onclick="shareViaText()">üí¨ SMS</button>
                <button class="share-option-btn" onclick="shareViaEmail()">üìß Email</button>
            </div>
            <button class="close-modal-btn" onclick="closeShareModal()">Close</button>
        </div>
    </div>

    <!-- Image Modal for Server Illustration -->
    <div class="image-modal" id="image-modal" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="close-modal-btn" onclick="closeImageModal()" style="margin-bottom: 16px;">‚úï Close</button>
            <img src="server-illustration.svg" alt="Two-Node Server Architecture" style="width: 100%; max-width: 800px; height: auto; display: block;">
        </div>
    </div>

    <!-- Crisis Mode Modal -->
    <div class="share-modal" id="crisis-mode-modal" style="background: rgba(239, 68, 68, 0.15);">
        <div class="share-modal-content" style="max-width: 600px; border: 2px solid #ef4444;">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 3rem; margin-bottom: 8px;">üö®</div>
                <div class="share-modal-title" style="color: #ef4444; font-size: 1.5rem;">CRISIS MODE ACTIVATED</div>
                <div class="share-modal-subtitle">Both systems are in high-stress states. Implement emergency protocols.</div>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #ef4444; margin-bottom: 12px; font-size: 1.1rem;">‚ö†Ô∏è Current System Status</div>
                <div style="color: #e2e8f0; font-size: 0.95rem; line-height: 1.6;">
                    <div id="crisis-status-me"></div>
                    <div id="crisis-status-partner"></div>
                </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #f59e0b; margin-bottom: 12px; font-size: 1.1rem;">ü§î Decision Point</div>
                <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">Choose your immediate response:</div>

                <button onclick="showCrisisOption('space')" style="width: 100%; padding: 16px; margin-bottom: 12px; background: rgba(139, 92, 246, 0.2); border: 2px solid #8b5cf6; border-radius: 8px; color: #e2e8f0; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    üîå TAKE SPACE (Disconnect & Self-Regulate)
                </button>

                <button onclick="showCrisisOption('repair')" style="width: 100%; padding: 16px; background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981; border-radius: 8px; color: #e2e8f0; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    ü§ù ATTEMPT REPAIR (Stay & De-escalate)
                </button>
            </div>

            <div id="crisis-guidance" style="display: none;"></div>

            <button class="close-modal-btn" onclick="closeCrisisMode()">Exit Crisis Mode</button>
        </div>
    </div>

    <!-- First-Time User Tutorial -->
    <div class="tutorial-modal" id="tutorial-modal" style="display: none;">
        <div class="tutorial-content">
            <button class="skip-tutorial-btn" onclick="skipTutorial()">Skip</button>

            <div class="tutorial-step" id="tutorial-step-1">
                <div class="tutorial-icon">üîß</div>
                <div class="tutorial-title">System Initialization</div>
                <div class="tutorial-text">
                    This is a real-time interface for two autonomous systems to broadcast status updates and optimize their shared throughput. Think of it as a bidirectional API where both nodes can signal state changes without blocking the other.
                </div>
                <div class="tutorial-progress">
                    <span class="dot active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <button class="tutorial-next-btn" onclick="nextTutorialStep()">Next</button>
            </div>

            <div class="tutorial-step" id="tutorial-step-2" style="display: none;">
                <div class="tutorial-icon">üì°</div>
                <div class="tutorial-title">Broadcast Status Updates</div>
                <div class="tutorial-text">
                    Select a status to broadcast your current operational state. The other node receives the signal in real-time along with recommended response protocols. No manual synchronization required‚ÄîFirebase handles the WebSocket connection.
                </div>
                <div class="tutorial-example">
                    <div class="example-mood">‚ö° "HIGH_LOAD detected"</div>
                    <div class="example-arrow">‚Üí</div>
                    <div class="example-result">Node B receives: "// ACK - Node A processing independently. Simple keepalive sufficient."</div>
                </div>
                <div class="tutorial-progress">
                    <span class="dot"></span>
                    <span class="dot active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <button class="tutorial-next-btn" onclick="nextTutorialStep()">Next</button>
            </div>

            <div class="tutorial-step" id="tutorial-step-3" style="display: none;">
                <div class="tutorial-icon">üìä</div>
                <div class="tutorial-title">System Telemetry & Pattern Analysis</div>
                <div class="tutorial-text">
                    Your git log tracks status changes over time. The AI analyzes telemetry data to identify recurring patterns, suggest optimizations, and provide performance metrics on system stability.
                </div>
                <div class="tutorial-features">
                    <div class="feature-item">ü§ñ ML-powered pattern detection</div>
                    <div class="feature-item">üìà Weekly performance reports</div>
                    <div class="feature-item">üí¨ Protocol suggestion engine</div>
                </div>
                <div class="tutorial-progress">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot active"></span>
                    <span class="dot"></span>
                </div>
                <button class="tutorial-next-btn" onclick="nextTutorialStep()">Next</button>
            </div>

            <div class="tutorial-step" id="tutorial-step-4" style="display: none;">
                <div class="tutorial-icon">üîó</div>
                <div class="tutorial-title">Establish Connection to Node B</div>
                <div class="tutorial-text">
                    This session URL is scoped to a two-node architecture. Share the endpoint with the second node to establish the bidirectional connection. All telemetry data is isolated to your unique namespace in the Firebase Realtime Database.
                </div>
                <div class="tutorial-tip">
                    ‚öôÔ∏è <strong>Next Step:</strong> Configure both partners' names and attachment styles in System Configuration to enable accurate coupling analysis.
                </div>
                <div class="tutorial-tip">
                    üí° Tip: Bookmark this endpoint for persistent session access.
                </div>
                <div class="tutorial-progress">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot active"></span>
                </div>
                <button class="tutorial-done-btn" onclick="closeTutorial()">Initialize System</button>
            </div>
        </div>
    </div>

    <!-- 2. WELCOME / NODE IDENTITY SELECTOR -->
    <div class="welcome-card" id="welcome-card">
        <div class="welcome-title">Node Configuration</div>
        <div class="welcome-subtitle">Select your node identity</div>
        <div class="identity-buttons">
            <button class="identity-btn me" onclick="selectIdentity('me')">I'm Node A (Her)</button>
            <button class="identity-btn you" onclick="selectIdentity('you')">I'm Node B (Him)</button>
        </div>
        <div class="returning-user-note" id="returning-note">
            ‚úì Session restored from local cache.
        </div>
    </div>

    <!-- ATTACHMENT STYLE ONBOARDING -->
    <div class="attachment-onboarding" id="attachment-onboarding" style="display: none;">
        <div class="onboarding-content">
            <div class="onboarding-title">Node Configuration Protocol</div>
            <div class="onboarding-subtitle">Setting operational parameters optimizes protocol recommendations</div>

            <div class="attachment-quiz">
                <div class="quiz-question">
                    <div class="question-number">Question 1 of 3</div>
                    <div class="question-text" id="quiz-question-text">In relationships, I tend to...</div>
                    <div class="quiz-options" id="quiz-options">
                        <!-- Options will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="attachment-results" id="attachment-results" style="display: none;">
                <div class="results-title">Node Operational Profile</div>
                <div class="style-badge" id="style-badge"></div>
                <div class="style-description" id="style-description"></div>
                <div class="style-strengths" id="style-strengths"></div>
                <div class="style-growth" id="style-growth"></div>
                <button class="continue-btn" onclick="completeOnboarding()">Initialize Interface</button>
            </div>
        </div>
    </div>

    <!-- ATTACHMENT STYLE SETTINGS (accessible later) -->
    <div class="attachment-settings-modal" id="attachment-settings-modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="settings-header">
                <div class="settings-title">System Configuration</div>
                <button class="close-settings-btn" onclick="closeAttachmentSettings()">‚úï</button>
            </div>

            <div class="settings-intro">
                <p><strong>‚ö†Ô∏è Configure this before starting:</strong> Set names, attachment styles, and pronouns for both partners to enable accurate coupling analysis and personalized protocols.</p>
            </div>

            <div class="settings-body">
                <div class="setting-section">
                    <div class="setting-label">Node A Operational Profile</div>
                    <div class="attachment-dual-selects">
                        <div class="attachment-primary">
                            <label class="attachment-sublabel">Primary Style</label>
                            <select class="attachment-select" id="my-attachment-select" onchange="updateAttachmentStyle('me', this.value)">
                                <option value="anxious">Connection-Optimized (Lower latency tolerance)</option>
                                <option value="avoidant">Autonomy-Optimized (Buffer preference)</option>
                                <option value="secure">Balanced (Adaptive)</option>
                                <option value="fearful">Mixed-Mode (Context-dependent)</option>
                            </select>
                        </div>
                        <div class="attachment-secondary">
                            <label class="attachment-sublabel">Secondary Style (Optional)</label>
                            <select class="attachment-select" id="my-attachment-secondary-select">
                                <option value="">None</option>
                                <option value="anxious">Connection-Optimized</option>
                                <option value="avoidant">Autonomy-Optimized</option>
                                <option value="secure">Balanced</option>
                                <option value="fearful">Mixed-Mode</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-description" id="my-style-description"></div>
                </div>

                <div class="setting-section">
                    <div class="setting-label">Node B Operational Profile</div>
                    <div class="attachment-dual-selects">
                        <div class="attachment-primary">
                            <label class="attachment-sublabel">Primary Style</label>
                            <select class="attachment-select" id="partner-attachment-select" onchange="updateAttachmentStyle('you', this.value)">
                                <option value="anxious">Connection-Optimized (Lower latency tolerance)</option>
                                <option value="avoidant">Autonomy-Optimized (Buffer preference)</option>
                                <option value="secure">Balanced (Adaptive)</option>
                                <option value="fearful">Mixed-Mode (Context-dependent)</option>
                            </select>
                        </div>
                        <div class="attachment-secondary">
                            <label class="attachment-sublabel">Secondary Style (Optional)</label>
                            <select class="attachment-select" id="partner-attachment-secondary-select">
                                <option value="">None</option>
                                <option value="anxious">Connection-Optimized</option>
                                <option value="avoidant">Autonomy-Optimized</option>
                                <option value="secure">Balanced</option>
                                <option value="fearful">Mixed-Mode</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-description" id="partner-style-description"></div>
                </div>

                <div class="setting-section">
                    <div class="setting-label">Node Display Labels</div>
                    <div class="name-inputs">
                        <input type="text" class="name-input" id="my-name-input" placeholder="Node A label (e.g., Alex)" maxlength="15">
                        <input type="text" class="name-input" id="partner-name-input" placeholder="Node B label (e.g., Sam)" maxlength="15">
                    </div>
                </div>

                <div class="setting-section">
                    <div class="setting-label">Node A Pronouns</div>
                    <select class="pronoun-select" id="my-pronoun-select">
                        <option value="she/her">she/her</option>
                        <option value="he/him">he/him</option>
                        <option value="they/them">they/them</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" class="custom-pronoun-input" id="my-custom-pronoun" placeholder="Enter custom pronouns" style="display: none;" maxlength="20">
                </div>

                <div class="setting-section">
                    <div class="setting-label">Node B Pronouns</div>
                    <select class="pronoun-select" id="partner-pronoun-select">
                        <option value="she/her">she/her</option>
                        <option value="he/him">he/him</option>
                        <option value="they/them">they/them</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" class="custom-pronoun-input" id="partner-custom-pronoun" placeholder="Enter custom pronouns" style="display: none;" maxlength="20">
                </div>
            </div>

            <button class="save-settings-btn" onclick="savePersonalizationSettings()">Save Configuration</button>
        </div>
    </div>

    <!-- 3. MOOD SELECTOR (PRIMARY ACTION) -->
    <div class="mood-section" id="mood-section">
        <div class="mood-header">System Status Update</div>
        <div class="mood-buttons" id="mood-buttons"></div>
        
        <div class="note-box" id="note-box">
            <label>Append custom message payload (optional)</label>
            <textarea id="note-input" placeholder="Additional context to transmit..."></textarea>
            <div class="note-actions">
                <button class="ai-rephrase-btn" onclick="improveMessage()">ü§ñ Optimize for clarity</button>
                <button class="send-note-btn" onclick="sendNote()">Send Payload</button>
            </div>
            <div class="ai-suggestion" id="ai-suggestion">
                <div class="ai-suggestion-label">üí≠ Protocol optimization:</div>
                <div class="ai-suggestion-text" id="ai-suggestion-text"></div>
                <div class="suggestion-actions">
                    <button class="use-btn" onclick="useSuggestion()">Apply</button>
                    <button class="dismiss-btn" onclick="dismissSuggestion()">Keep original</button>
                </div>
            </div>
        </div>

        <div class="private-note-box" id="private-note-box" style="display: none;">
            <div class="private-note-header">
                <span class="private-icon">üîí</span>
                <label>Private Note (Only visible to you)</label>
            </div>
            <textarea id="private-note-input" placeholder="Personal reflection, triggers, patterns... Partner cannot see this."></textarea>
            <button class="save-private-note-btn" onclick="savePrivateNote()">Save Private Note</button>
            <div class="private-note-saved" id="private-note-saved" style="display: none;">‚úì Saved locally</div>

            <div class="private-notes-history" id="private-notes-history" style="margin-top: 20px;">
                <div style="font-weight: 600; color: #d97706; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìù Your Note History</span>
                    <button onclick="clearAllPrivateNotes()" style="font-size: 0.75rem; padding: 4px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer;">Clear All</button>
                </div>
                <div id="private-notes-list"></div>
            </div>
        </div>
    </div>

    <!-- 4. MOOD HISTORY / GIT LOG -->
    <div class="collapsible-section" style="margin-top: 30px;">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üìä</span>
                <span class="collapsible-title">git log --graph relationship.branch</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="calendar-legend" style="font-family: 'Courier New', monospace; font-size: 0.85rem;">
                    <span class="legend-item"><span class="emoji">üåø</span> IDLE (buffering)</span>
                    <span class="legend-item"><span class="emoji">üåä</span> HIGH_LOAD</span>
                    <span class="legend-item"><span class="emoji">üå´Ô∏è</span> TIMEOUT</span>
                    <span class="legend-item"><span class="emoji">üå∏</span> READY</span>
                    <span class="legend-item"><span class="emoji">‚òÄÔ∏è</span> 200 OK</span>
                </div>
                <div class="month-navigation">
                    <button class="month-nav-btn" onclick="previousMonth()">‚óÄ git log --skip</button>
                    <span class="current-month" id="current-month" style="font-family: 'Courier New', monospace;">December 2025</span>
                    <button class="month-nav-btn" onclick="nextMonth()">git log --recent ‚ñ∂</button>
                    <button class="month-nav-btn" onclick="updateMoodCalendar(moodHistory)" style="margin-left: 12px;">üîÑ git pull</button>
                </div>
                <div class="calendar-container" id="mood-calendar">
                    <div class="no-history" style="font-family: 'Courier New', monospace;">// No commits yet. Initialize with your first status update.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. SYSTEM MONITORING DASHBOARD -->
    <div class="monitoring-dashboard">
        <div class="dashboard-header">
            <span class="dashboard-icon">üì°</span>
            <span class="dashboard-title">System Monitoring</span>
        </div>

        <div class="monitoring-grid">
            <!-- Live Status Cards -->
            <div class="monitoring-section">
                <div class="monitoring-section-title">Partner Status Update</div>
                <div class="live-status">
                    <div class="live-status-card me-card" id="status-card-me">
                        <div class="live-status-name">Node A (Her)</div>
                        <div class="attachment-style-badge" id="attachment-badge-me"></div>
                        <div class="live-status-mood" id="live-mood-me">// Awaiting initial broadcast</div>
                        <div class="live-status-time" id="live-time-me"></div>
                    </div>
                    <div class="live-status-card you-card" id="status-card-you">
                        <div class="live-status-name">Node B (Him)</div>
                        <div class="attachment-style-badge" id="attachment-badge-you"></div>
                        <div class="live-status-mood" id="live-mood-you">// Awaiting initial broadcast</div>
                        <div class="live-status-time" id="live-time-you"></div>
                    </div>
                </div>
            </div>

            <!-- Coupling Success Gauge (Mini Version) -->
            <div class="monitoring-section">
                <div class="monitoring-section-title">Relationship Success Probability</div>
                <div class="monitoring-gauge-compact">
                    <div class="gauge-compact">
                        <div class="gauge-compact-fill" id="gauge-compact-fill"></div>
                        <div class="gauge-compact-text" id="gauge-compact-text">--</div>
                    </div>
                    <div class="gauge-compact-label" id="gauge-compact-label">Analyzing...</div>
                    <button class="view-details-btn" onclick="scrollToCouplingAnalysis()">View Full Analysis ‚Üí</button>
                </div>
            </div>

            <!-- Consistency Tracker -->
            <div class="monitoring-section">
                <div class="monitoring-section-title">üìà Emotional Consistency Score</div>
                <div class="consistency-metrics">
                    <div class="consistency-metric">
                        <div class="metric-label">Last 3 Entries</div>
                        <div class="metric-value" id="stability-3day">--</div>
                        <div class="metric-bar">
                            <div class="metric-bar-fill" id="stability-3day-bar"></div>
                        </div>
                        <div class="metric-entries" id="entries-3day"></div>
                    </div>
                    <div class="consistency-metric">
                        <div class="metric-label">Last 5 Entries</div>
                        <div class="metric-value" id="stability-5day">--</div>
                        <div class="metric-bar">
                            <div class="metric-bar-fill" id="stability-5day-bar"></div>
                        </div>
                        <div class="metric-entries" id="entries-5day"></div>
                    </div>
                    <div class="consistency-metric">
                        <div class="metric-label">Last 7 Entries</div>
                        <div class="metric-value" id="stability-7day">--</div>
                        <div class="metric-bar">
                            <div class="metric-bar-fill" id="stability-7day-bar"></div>
                        </div>
                        <div class="metric-entries" id="entries-7day"></div>
                    </div>
                </div>
                <div class="consistency-evidence">
                    <div class="evidence-label">Evidence of Progress:</div>
                    <div class="evidence-list" id="evidence-list">
                        <div class="evidence-loading">Select your identity to track consistency...</div>
                    </div>
                </div>
            </div>

            <!-- ML Pattern Detection -->
            <div class="monitoring-section">
                <div class="monitoring-section-title">
                    <span>ü§ñ ML Pattern Detection</span>
                    <button class="refresh-btn-inline" onclick="generateInsights()">Analyze</button>
                </div>
                <div class="ai-loading" id="insights-loading">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
                <div class="monitoring-content" id="ai-insights-text">
                    // Select node identity to run pattern analysis
                </div>
            </div>

            <!-- Weekly Performance Report -->
            <div class="monitoring-section">
                <div class="monitoring-section-title">üìä Weekly Performance Report</div>
                <div class="ai-loading" id="weekly-loading">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
                <div class="monitoring-content" id="weekly-text">
                    // Awaiting telemetry data for weekly performance metrics
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ALERTS & PARTNER MESSAGE -->
    <div class="alert-section" id="alert-section">
        <div class="combo-alert" id="combo-alert">
            <div class="combo-alert-title">‚ö†Ô∏è System Notification</div>
            <div class="combo-alert-text" id="combo-alert-text"></div>
        </div>

        <div class="partner-message" id="partner-message">
            <div class="partner-message-label" id="partner-message-label">Incoming message from Node B</div>
            <div class="partner-message-text" id="partner-message-text"></div>
            <button class="understand-btn" onclick="helpMeUnderstand()">üìñ Parse response protocol</button>
            <div class="understand-response" id="understand-response">
                <div class="understand-text" id="understand-text"></div>
            </div>
        </div>

        <!-- Partner Communication Card (Context-Aware Guidance) -->
        <div class="partner-context-card" id="partner-context-card" style="display: none;">
            <div class="context-card-header">
                <div class="context-card-title">
                    <span class="context-icon">üí°</span>
                    <span id="context-card-partner-name">Partner</span> Status Update
                </div>
                <button class="context-card-close" onclick="closePartnerContextCard()">‚úï</button>
            </div>

            <div class="context-card-body">
                <div class="context-section context-current-state">
                    <div class="context-label" id="context-label-state">Current State:</div>
                    <div class="context-mood-display" id="context-mood-display">
                        <span class="context-emoji" id="context-emoji">üòê</span>
                        <span class="context-mood-label" id="context-mood-label">Awaiting status</span>
                    </div>
                </div>

                <div class="context-section context-needs">
                    <div class="context-label" id="context-label-needs">üí≠ What they likely need:</div>
                    <ul class="context-list" id="context-needs-list">
                        <li>Analyzing pattern...</li>
                    </ul>
                </div>

                <div class="context-section context-fears">
                    <div class="context-label" id="context-label-fears">‚ö†Ô∏è What they might be afraid of:</div>
                    <ul class="context-list" id="context-fears-list">
                        <li>Analyzing pattern...</li>
                    </ul>
                </div>

                <div class="context-section context-actions">
                    <div class="context-label" id="context-label-actions">‚úÖ How you can support them:</div>
                    <div class="context-action-cards" id="context-actions-list">
                        <div class="context-action-card">
                            <div class="action-rank">1</div>
                            <div class="action-content">
                                <div class="action-title">Quick Reassurance</div>
                                <div class="action-desc">Send a brief "I'm here" message</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="context-section context-avoid">
                    <div class="context-label" id="context-label-avoid">üö´ What NOT to do:</div>
                    <ul class="context-list context-avoid-list" id="context-avoid-list">
                        <li>Don't withdraw without explanation</li>
                    </ul>
                </div>

                <div class="context-section context-conversation">
                    <div class="context-label" id="context-label-convo">üí¨ Conversation starter (if ready):</div>
                    <div class="context-conversation-box" id="context-conversation-box">
                        <em>"Hey, I noticed you're feeling [mood]. Want to talk about it, or would you prefer some space right now?"</em>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. CONTEXTUAL INSIGHT -->
    <div class="insight-panel" id="insight-panel">
        <div class="insight-header">
            <div class="insight-title" id="insight-title">System State Analysis</div>
            <button class="insight-close" onclick="closeInsight()">‚úï</button>
        </div>
        <div class="insight-grid">
            <div class="insight-card for-me">
                <h4 id="insight-label-1">// Local Processing Notes</h4>
                <p id="insight-text-1"></p>
            </div>
            <div class="insight-card for-you">
                <h4 id="insight-label-2">// Remote Node Receives</h4>
                <p id="insight-text-2"></p>
            </div>
        </div>
    </div>

    <!-- 8. VENN DIAGRAM (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üîß</span>
                <span class="collapsible-title">Node Architecture Diagram</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="venn-container">
                    <div class="circle circle-me"></div>
                    <div class="circle circle-you"></div>

                    <div class="content-card card-me">
                        <div class="card-title">Node A</div>
                        <div class="card-subtitle" id="venn-subtitle-me">Connection-Optimized ¬∑ Low Latency Preference</div>
                        <ul class="traits" id="venn-traits-me">
                            <li>Processes state through synchronous communication</li>
                            <li>Stability achieved through regular keepalive packets</li>
                            <li>Lower tolerance for connection timeout</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Preferred input signals</span>
                            <div class="section-content" id="venn-signals-me">Acts of service, verbal acknowledgment</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">Optimization target</span>
                            <div class="growth-item" id="venn-target-me">Trust async processing ‚â† dropped connection</div>
                        </div>
                    </div>

                    <div class="overlap-card">
                        <div class="overlap-title">Interface Layer</div>
                        <span class="overlap-icon">‚ö°</span>
                        <ul class="overlap-traits" id="venn-overlap-traits">
                            <li>Physical co-location stabilizes both systems</li>
                            <li>Defensive protocols relax in proximity</li>
                            <li>Shared objective, different optimization strategies</li>
                            <li>Both nodes more committed than external metrics show</li>
                            <li>Peak throughput in unscheduled, low-pressure sessions</li>
                        </ul>
                        <div class="shared-lang">
                            <span class="shared-lang-label">Shared communication protocols</span>
                            <span id="venn-overlap-protocols">Verbal acknowledgment & demonstrated action</span>
                        </div>
                    </div>

                    <div class="content-card card-you">
                        <div class="card-title">Node B</div>
                        <div class="card-subtitle" id="venn-subtitle-you">Autonomy-Optimized ¬∑ Internal Processing</div>
                        <ul class="traits" id="venn-traits-you">
                            <li>Deep signal processing, async execution model</li>
                            <li>Resource recovery through isolated processing time</li>
                            <li>Maintains autonomy while preserving connection</li>
                            <li>Demonstrates commitment through actions & presence</li>
                        </ul>
                        <div class="section-divider">
                            <span class="section-label">Preferred input signals</span>
                            <div class="section-content" id="venn-signals-you">Verbal acknowledgment, physical presence</div>
                        </div>
                        <div class="section-divider">
                            <span class="section-label">Optimization target</span>
                            <div class="growth-item" id="venn-target-you">Broadcast status before disconnect: "Processing independently, will reconnect"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- COUPLING COMPATIBILITY ANALYSIS -->
    <div class="collapsible-section" data-section="coupling-analysis">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">üìä</span>
                <span class="collapsible-title">Coupling Analysis & Success Probability</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div class="health-indicator-container">
                    <!-- Success Probability Gauge -->
                    <div class="health-gauge-section">
                        <div class="health-gauge-label">Long-Term Relationship Success Probability</div>
                        <div class="health-gauge-wrapper">
                            <div class="health-gauge">
                                <div class="health-gauge-fill" id="health-gauge-fill"></div>
                                <div class="health-gauge-text" id="health-gauge-text">--</div>
                            </div>
                        </div>
                        <div class="health-status-label" id="health-status-label">Analyzing coupling dynamics...</div>
                    </div>

                    <!-- Research Context -->
                    <div class="health-research-section">
                        <div class="health-section-title">üìö What The Research Shows</div>
                        <div class="health-research-content" id="health-research-content">
                            Based on 30+ years of attachment research tracking relationship outcomes for different coupling types.
                        </div>
                    </div>

                    <!-- Disconnect Points -->
                    <div class="health-blocking-section" id="health-blocking-section" style="display: none;">
                        <div class="health-section-title">‚ö†Ô∏è Where Disconnect Typically Happens</div>
                        <ul class="health-blocking-list" id="health-blocking-list"></ul>
                    </div>

                    <!-- Connection Points -->
                    <div class="health-connection-section" id="health-connection-section" style="display: none;">
                        <div class="health-section-title">üíö Where You Naturally Align</div>
                        <div class="health-connection-content" id="health-connection-content"></div>
                    </div>

                    <!-- How Probability is Calculated -->
                    <div class="health-calculation-section" id="health-calculation-section" style="display: none;">
                        <div class="health-section-title">üî¨ How This Percentage is Calculated</div>
                        <div class="health-calculation-content" id="health-calculation-content"></div>
                    </div>

                    <!-- Optimal Path Forward -->
                    <div class="health-path-section" id="health-path-section" style="display: none;">
                        <div class="health-section-title">‚ú® What Makes This Coupling Work</div>
                        <div class="health-path-steps" id="health-path-steps"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. SYSTEM OPTIMIZATION PROTOCOLS (Collapsible) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
            <div class="collapsible-header-left">
                <span class="collapsible-icon">‚öôÔ∏è</span>
                <span class="collapsible-title">System Optimization Protocols</span>
            </div>
            <span class="collapsible-toggle">‚ñº</span>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-inner">
                <div style="background: rgba(138, 106, 154, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: #5a4a6a;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a;">üìä Coupled Systems Architecture</div>
                    <pre style="margin: 0; white-space: pre; overflow-x: auto;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Node A    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Node B    ‚îÇ
‚îÇ  (Her)  ‚îÇ    Bidirectional   ‚îÇ (Him)  ‚îÇ
‚îÇ             ‚îÇ   Feedback Loop    ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                  ‚îÇ
       ‚îú‚îÄ‚ñ∫ Signal Processing              ‚îú‚îÄ‚ñ∫ Buffer Space
       ‚îú‚îÄ‚ñ∫ State Validation               ‚îú‚îÄ‚ñ∫ Async Handling
       ‚îî‚îÄ‚ñ∫ Load Balancing ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</pre>
                    <div style="margin-top: 12px; font-size: 0.8rem; font-style: italic;">Two autonomous systems optimizing for shared throughput</div>
                </div>

                <!-- Server Illustration -->
                <div style="margin-bottom: 24px; padding: 20px; background: rgba(15, 15, 26, 0.3); border-radius: 12px; border: 1px solid rgba(138, 106, 154, 0.2);">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a; text-align: center; font-family: 'Courier New', monospace;">üíª Visual Node Topology</div>
                    <img src="server-illustration.svg" alt="Two-Node Server Architecture" style="width: 100%; height: auto; display: block; border-radius: 8px; cursor: pointer;" onclick="openImageModal()" title="Click to view full size">
                    <div style="margin-top: 8px; text-align: center; font-size: 0.75rem; color: #8a6a9a; font-style: italic;">Tap to enlarge</div>
                </div>

                <div class="helps-grid">
                    <div class="helps-column">
                        <h3>Node A Optimizations</h3>
                        <ul id="protocol-node-a">
                            <li><strong>Allow async processing:</strong> Partner's buffer space prevents system overload</li>
                            <li><strong>Emit status updates:</strong> Broadcast state without expecting ACK</li>
                            <li><strong>Trust the handshake:</strong> Connection persists through idle cycles</li>
                            <li><strong>Parallel processing:</strong> Both nodes need independent compute time</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>System-Wide Protocols</h3>
                        <ul id="protocol-system-wide">
                            <li><strong>Use descriptive logging:</strong> "STATUS: feeling X" vs "ERROR: you always Y"</li>
                            <li><strong>Implement graceful degradation:</strong> Temporary disconnects don't crash the system</li>
                            <li><strong>Schedule health checks:</strong> Regular pings maintain connection stability</li>
                            <li><strong>Load balancing:</strong> Distribute processing across both nodes</li>
                        </ul>
                    </div>
                    <div class="helps-column">
                        <h3>Node B Optimizations</h3>
                        <ul id="protocol-node-b">
                            <li><strong>Send keepalive packets:</strong> Small signals maintain connection health</li>
                            <li><strong>Broadcast intent:</strong> Quick ETA reduces timeout anxiety</li>
                            <li><strong>Share debug logs:</strong> Internal state visibility builds trust</li>
                            <li><strong>Presence > perfection:</strong> Uptime matters more than flawless output</li>
                        </ul>
                    </div>
                </div>

                <div style="background: rgba(138, 106, 154, 0.05); padding: 16px; border-radius: 12px; margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: #5a4a6a;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a;">üì° Network Traffic Flow</div>
                    <pre style="margin: 0; white-space: pre; overflow-x: auto;">
Request Flow:
Node A ‚îÄ‚îÄ[SIGNAL: need_space]‚îÄ‚îÄ> Node B
       <‚îÄ[ACK: optional]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Node B

Response Latency Tolerance:
Immediate      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë Nice when it happens
Hours          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë Common, expected
Days           ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% valid - No timeout ever

All response times are acceptable system behavior.
Connection persists regardless of latency.

Status Codes:
200 OK                    - System stable
202 Accepted              - Processing async (no ETA required)
408 Extended Processing   - Taking more time (not an error)
503 Service Unavailable   - Temporary buffer overflow (normal)</pre>
                </div>

                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e8f4fd 0%, #dce8f7 100%); border-radius: 12px; border-left: 4px solid #A855F7; box-shadow: 0 2px 8px rgba(168, 85, 247, 0.15);">
                    <div style="font-weight: 600; color: #4a3a5a; margin-bottom: 8px;">üîï Zero-Notification Architecture</div>
                    <div style="font-size: 0.9rem; color: #4a3a5a; line-height: 1.6;">
                        <strong>This system does not send notifications.</strong> No alerts, no pings, no pressure for immediate responses. The line stays open indefinitely for when partners are ready. Both nodes can process at their own pace‚Äîhours, days, or longer‚Äîwithout breaking the connection. Your need for space and autonomous processing is built into the core design.
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fff5d9 100%); border-radius: 12px; border-left: 4px solid #f0c040;">
                    <div style="font-weight: 600; color: #6a5a4a; margin-bottom: 8px;">üí° Engineering Note:</div>
                    <div style="font-size: 0.9rem; color: #6a5a4a; line-height: 1.6;">
                        This isn't about fixing bugs in each other‚Äîit's about optimizing the interface between two well-functioning systems. When Node A signals high load, Node B doesn't need to debug Node A's internals. Just acknowledge the signal and allow async processing. Both systems remain stable independently.
                    </div>
                </div>

                <div style="background: rgba(138, 106, 154, 0.05); padding: 16px; border-radius: 12px; margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: #5a4a6a;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: #4a3a5a;">üîÄ Version Control Metaphor</div>
                    <pre style="margin: 0; white-space: pre; overflow-x: auto;">
git log --oneline relationship.branch

* a3f91c2 (HEAD) Merge: Better async communication
* 8b2e4d1 feat: Implemented keepalive packets
* c7a9f3e fix: Reduced timeout anxiety
* 2d1b8a4 refactor: Optimized buffer handling
* f5e3c2b Initial commit: Two systems connecting

// No force push. No hard reset.
// Just continuous integration.</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyDivrvDQijdlHP6nFOBlQB7eAOf8WFo_GA",
            authDomain: "attachmentstyles-b807c.firebaseapp.com",
            databaseURL: "https://attachmentstyles-b807c-default-rtdb.firebaseio.com",
            projectId: "attachmentstyles-b807c",
            storageBucket: "attachmentstyles-b807c.firebasestorage.app",
            messagingSenderId: "619137221036",
            appId: "1:619137221036:web:905bcdec602659048d7a09"
        };

        const isFirebaseConfigured = !firebaseConfig.apiKey.includes("YOUR_");

        let db = null;
        let roomRef = null;
        let historyRef = null;
        let currentIdentity = null;
        let roomId = null;
        let currentMoodKey = null;
        let previousData = {};
        let moodHistory = [];
        let currentMonthOffset = 0; // 0 = current month, -1 = last month, etc.

        // ============ ATTACHMENT STYLE DATA ============
        const attachmentStyleData = {
            anxious: {
                title: 'Connection-Optimized',
                subtitle: 'Low Latency Preference',
                traits: [
                    'Processes state through synchronous communication',
                    'Stability achieved through regular keepalive packets',
                    'Lower tolerance for connection timeout',
                    'High-frequency status checks preferred'
                ],
                preferredSignals: 'Acts of service, verbal acknowledgment, quality time',
                optimizationTarget: 'Trust async processing ‚â† dropped connection',
                color: '#3B82F6'
            },
            avoidant: {
                title: 'Autonomy-Optimized',
                subtitle: 'Internal Processing',
                traits: [
                    'Deep signal processing, async execution model',
                    'Resource recovery through isolated processing time',
                    'Maintains autonomy while preserving connection',
                    'Demonstrates commitment through actions & presence'
                ],
                preferredSignals: 'Verbal acknowledgment, physical presence, quality time',
                optimizationTarget: 'Broadcast status before disconnect: "Processing independently, will reconnect"',
                color: '#7C3AED'
            },
            secure: {
                title: 'Balanced Processing',
                subtitle: 'Adaptive & Flexible',
                traits: [
                    'Comfortable with both sync and async communication',
                    'Self-regulates without external validation',
                    'Provides stability during partner\'s high-load states',
                    'Balances connection needs with autonomy'
                ],
                preferredSignals: 'All forms of communication, adaptable to partner needs',
                optimizationTarget: 'Continue modeling healthy communication patterns',
                color: '#10B981'
            },
            fearful: {
                title: 'Mixed-Mode Processing',
                subtitle: 'Context-Dependent',
                traits: [
                    'Oscillates between connection-seeking and withdrawal',
                    'Processing mode depends on system state',
                    'Benefits from explicit protocol definitions',
                    'Requires additional reassurance during transitions'
                ],
                preferredSignals: 'Clear communication, gentle reassurance, patience',
                optimizationTarget: 'Build trust through consistent, predictable responses',
                color: '#F59E0B'
            }
        };

        // ============ ATTACHMENT PAIRING DATA (Interface Layer) ============
        const attachmentPairingData = {
            'anxious-avoidant': {
                traits: [
                    'Classic pursuit-distance dynamic requires conscious intervention',
                    'Both styles trigger each other\'s core fears initially',
                    'High growth potential through learning opposite strategies',
                    'Physical proximity significantly reduces defensive protocols',
                    'Success requires explicit communication of needs and reassurance'
                ],
                protocols: 'Regular check-ins, clear ETAs, verbal reassurance'
            },
            'anxious-anxious': {
                traits: [
                    'Both nodes seek high-frequency connection and validation',
                    'Risk of over-dependency without external stability',
                    'Strong empathy for each other\'s connection needs',
                    'May amplify anxiety during conflicts without secure base',
                    'Thrives when both practice self-soothing techniques'
                ],
                protocols: 'Mutual reassurance, scheduled quality time, grounding practices'
            },
            'anxious-secure': {
                traits: [
                    'Secure node provides consistent stability and reassurance',
                    'Anxious node learns trust through reliable responsiveness',
                    'Lower conflict potential with secure\'s emotional regulation',
                    'Secure node models healthy independence',
                    'Balanced dynamic with clear growth path for anxious node'
                ],
                protocols: 'Secure provides consistent reassurance, anxious practices trust'
            },
            'anxious-fearful': {
                traits: [
                    'Mixed-mode node oscillates between connection and withdrawal',
                    'Requires extra patience during fearful node\'s withdrawal phases',
                    'Both benefit from explicit protocol definitions',
                    'Connection-seeking phases align well',
                    'Growth through understanding each other\'s triggers'
                ],
                protocols: 'Gentle communication, patience during transitions, clear boundaries'
            },
            'avoidant-avoidant': {
                traits: [
                    'Both value autonomy and independent processing',
                    'Low conflict but risk of emotional distance',
                    'Comfortable with async communication patterns',
                    'May need conscious effort to maintain intimacy',
                    'Thrives with scheduled connection time and mutual respect for space'
                ],
                protocols: 'Scheduled quality time, respect for independence, intentional vulnerability'
            },
            'avoidant-secure': {
                traits: [
                    'Secure node respects autonomy while maintaining connection',
                    'Avoidant node feels safe to gradually increase vulnerability',
                    'Balanced dynamic with low pressure on avoidant node',
                    'Secure models healthy interdependence',
                    'Natural progression toward secure attachment for avoidant'
                ],
                protocols: 'Space with reassurance, patient consistency, celebrating small openings'
            },
            'avoidant-fearful': {
                traits: [
                    'Both need significant buffer space during high-load states',
                    'Fearful node\'s connection-seeking can trigger avoidant withdrawal',
                    'Success requires clear communication of shifting needs',
                    'Both benefit from understanding attachment patterns',
                    'Physical presence without pressure works well for both'
                ],
                protocols: 'Clear boundaries, patient presence, explicit reassurance when needed'
            },
            'secure-secure': {
                traits: [
                    'Both nodes comfortable with interdependence and autonomy',
                    'High emotional regulation reduces conflict escalation',
                    'Natural balance of connection and independence',
                    'Strong foundation for long-term stability',
                    'Optimal system architecture for resilience'
                ],
                protocols: 'Adaptive communication, mutual support, natural flow'
            },
            'secure-fearful': {
                traits: [
                    'Secure node provides stability during fearful node\'s transitions',
                    'Fearful node learns trust through consistent secure responses',
                    'Requires patience during mixed-mode oscillations',
                    'Strong growth potential for fearful node toward security',
                    'Secure node models healthy attachment without judgment'
                ],
                protocols: 'Consistent reassurance, patience with shifts, gentle communication'
            },
            'fearful-fearful': {
                traits: [
                    'Both nodes experience push-pull dynamics',
                    'High empathy for each other\'s internal conflicts',
                    'Risk of amplifying each other\'s anxiety and withdrawal',
                    'Success requires external support and self-awareness',
                    'Strong bond through shared understanding of complexity'
                ],
                protocols: 'Therapy support, explicit communication, patience with each other\'s patterns'
            }
        };

        // ============ ATTACHMENT-SPECIFIC OPTIMIZATION PROTOCOLS ============
        const optimizationProtocols = {
            anxious: {
                nodeOptimizations: [
                    '<strong>Self-soothing protocols:</strong> Practice anxiety reduction before broadcasting distress signals',
                    '<strong>Trust async mode:</strong> Partner\'s silence ‚â† connection dropped',
                    '<strong>Emit honest status:</strong> Broadcast needs directly vs seeking validation indirectly',
                    '<strong>Buffer tolerance:</strong> Allow partner processing time without flooding with pings'
                ],
                partnerSupport: [
                    '<strong>Send keepalive packets:</strong> Small reassurance signals prevent timeout anxiety',
                    '<strong>Broadcast ETAs:</strong> "Processing, will reconnect in 2h" reduces latency fears',
                    '<strong>Consistent responses:</strong> Reliability builds connection trust over time',
                    '<strong>Validate then redirect:</strong> Acknowledge feelings before problem-solving'
                ]
            },
            avoidant: {
                nodeOptimizations: [
                    '<strong>Proactive status broadcasts:</strong> Signal buffer needs before going async',
                    '<strong>Share debug logs:</strong> Verbalize internal state vs expecting partner to infer',
                    '<strong>Scheduled connection time:</strong> Regular sync prevents drift',
                    '<strong>Incremental vulnerability:</strong> Small emotional packets build tolerance'
                ],
                partnerSupport: [
                    '<strong>Respect buffer space:</strong> Allow async processing without interpreting as rejection',
                    '<strong>Low-pressure presence:</strong> Parallel processing (same room, different tasks) works well',
                    '<strong>Celebrate small opens:</strong> Reinforce emotional risk-taking positively',
                    '<strong>Accept action-based care:</strong> Recognize non-verbal expressions of connection'
                ]
            },
            secure: {
                nodeOptimizations: [
                    '<strong>Model healthy patterns:</strong> Demonstrate balanced connection-autonomy for partner',
                    '<strong>Provide stability:</strong> Consistent presence during partner\'s high-load states',
                    '<strong>Adaptive processing:</strong> Flex communication style to partner\'s current needs',
                    '<strong>Maintain boundaries:</strong> Self-care prevents burnout from over-supporting'
                ],
                partnerSupport: [
                    '<strong>Continue secure base:</strong> Your stability anchors the relationship system',
                    '<strong>Patient consistency:</strong> Reliable responses help partner build trust',
                    '<strong>Self-awareness:</strong> Monitor for compassion fatigue or resentment',
                    '<strong>Celebrate growth:</strong> Acknowledge partner\'s progress toward security'
                ]
            },
            fearful: {
                nodeOptimizations: [
                    '<strong>Track activation patterns:</strong> Identify when connection vs withdrawal mode triggers',
                    '<strong>Explicit mode signals:</strong> Broadcast when shifting between approach/avoid states',
                    '<strong>Therapy as debugging:</strong> External support helps stabilize oscillating patterns',
                    '<strong>Self-compassion protocols:</strong> Mixed signals are system behavior, not character flaws'
                ],
                partnerSupport: [
                    '<strong>Extra patience buffer:</strong> Inconsistency is expected system behavior',
                    '<strong>Gentle communication:</strong> Minimize perceived threat during vulnerable moments',
                    '<strong>Consistent reassurance:</strong> Regular validation helps reduce fear responses',
                    '<strong>Respect both modes:</strong> Honor connection needs AND space needs as equally valid'
                ]
            }
        };

        // ============ MOOD DATA ============
        const moodEmojis = {
            space: 'üåø',
            anxious: 'üåä',
            overwhelmed: 'üåä',
            disconnected: 'üå´Ô∏è',
            reconnect: 'üå∏',
            good: '‚òÄÔ∏è'
        };

        const moodData = {
            me: {
                space: {
                    label: "Need space, but okay",
                    message: "I just need a little quiet time to recharge. This isn't about you. I'll be back soon.",
                    insightTitle: "When I Need Space",
                    insightMe: "// STATUS: 200 OK - Processing independently. Take this time to do something that fills your cup.",
                    insightYou: "// ACK received - She's self-regulating. A simple 'take your time' is perfect keepalive packet."
                },
                anxious: {
                    label: "Feeling anxious",
                    message: "I'm feeling a bit anxious right now. I don't need you to fix it. Just knowing you're there helps.",
                    insightTitle: "When I'm Feeling Anxious",
                    insightMe: "// High latency detected - Notice this feeling without acting on it. Try 5 deep breaths first.",
                    insightYou: "// Signal received - She's being vulnerable. A heart emoji or 'I'm here' goes far."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I'm feeling a bit distant from us. I'd love some quality time when you're ready.",
                    insightTitle: "When I Feel Disconnected",
                    insightMe: "// TODO: Debug - Am I seeking connection or seeking reassurance?",
                    insightYou: "// Connection timeout - She's missing you. Low-pressure sync session would help."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to connect. No pressure, just wanted you to know. ‚ô°",
                    insightTitle: "Ready to Reconnect",
                    insightMe: "// READY state - Stay open without expecting specific response code.",
                    insightYou: "// Port open - This is an invitation, not a requirement. Good time to sync."
                },
                good: {
                    label: "All good ‚ô°",
                    message: "Feeling good and settled. Just wanted you to know all is well. ‚ô°",
                    insightTitle: "All Good",
                    insightMe: "// 200 OK - System stable. Note what contributed to this state.",
                    insightYou: "// All systems nominal - She's content. No action needed. Just receive this."
                }
            },
            you: {
                space: {
                    label: "Need space, but okay",
                    message: "I'm taking some time to recharge. This isn't distance, it's how I process. I'll be back.",
                    insightTitle: "When He Needs Space",
                    insightMe: "// His buffer processing != connection issue. Do something nourishing for yourself.",
                    insightYou: "// Broadcasting ETA reduces timeout anxiety - Naming when you'll return helps stabilize system."
                },
                overwhelmed: {
                    label: "Feeling overwhelmed",
                    message: "Feeling a bit overwhelmed right now. I need to step back and recalibrate.",
                    insightTitle: "When He's Overwhelmed",
                    insightMe: "// 503 Service Temporarily Unavailable - His withdrawal is system protection, not punishment. Don't retry immediately.",
                    insightYou: "// High load detected - A small keepalive packet when ready bridges the gap."
                },
                disconnected: {
                    label: "Feeling disconnected",
                    message: "I've been in my own world lately. It's not intentional. I want to find our way back.",
                    insightTitle: "When He Feels Disconnected",
                    insightMe: "// git commit -m 'Acknowledge disconnect' - He's naming it, that's huge. Let him initiate merge.",
                    insightYou: "// Sharing internal state visibility builds trust - She'll appreciate you naming this."
                },
                reconnect: {
                    label: "Ready to reconnect",
                    message: "I'm feeling open and ready to be close. Just wanted you to know I'm here.",
                    insightTitle: "When He's Ready to Reconnect",
                    insightMe: "// Connection restored - Receive this. Don't overload. Match his bandwidth.",
                    insightYou: "// Your uptime presence > perfection - Being available is the gift."
                },
                good: {
                    label: "All good ‚ô°",
                    message: "I'm good. Feeling settled and close to you. ‚ô°",
                    insightTitle: "All Good",
                    insightMe: "// 200 OK - Both systems stable. Soak this in. This is what secure feels like.",
                    insightYou: "// Optimal throughput achieved - Enjoy this moment of low-latency connection."
                }
            }
        };

        // ============ INITIALIZATION ============
        function init() {
            // Collapse growth sidebar on mobile by default
            if (window.innerWidth <= 768) {
                document.getElementById('growth-sidebar').classList.add('collapsed');
            }

            // Check for first-time user
            const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
            if (!hasSeenTutorial) {
                // Show tutorial after a brief delay
                setTimeout(() => {
                    document.getElementById('tutorial-modal').style.display = 'flex';
                }, 500);
            }

            // Check for saved room first
            const savedRoom = localStorage.getItem('lastRoom');
            const urlParams = new URLSearchParams(window.location.search);

            // Priority: URL param > saved room > new room
            if (urlParams.get('room')) {
                roomId = urlParams.get('room');
            } else if (savedRoom) {
                roomId = savedRoom;
                document.getElementById('returning-note').classList.add('visible');
            } else {
                roomId = generateRoomId();
            }

            // Update URL and save
            window.history.replaceState({}, '', `?room=${roomId}`);
            localStorage.setItem('lastRoom', roomId);

            // Load room name
            const savedName = localStorage.getItem('roomName_' + roomId);
            document.getElementById('room-name').textContent = savedName || 'Node Session';

            // Load and apply display names
            updateDisplayNames();

            // Update Venn diagram on load
            updateVennDiagram();

            // Update optimization protocols on load
            updateOptimizationProtocols();

            // Update share link
            document.getElementById('share-link').value = window.location.href;

            if (isFirebaseConfigured) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                roomRef = db.ref('rooms/' + roomId);
                historyRef = db.ref('history/' + roomId);
                
                roomRef.on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    updateLiveStatus(data);
                    checkForComboAlert(data);
                    updateSystemHealth(data);

                    // Load settings from Firebase
                    if (data.settings) {
                        localStorage.setItem('myName', data.settings.myName || 'Her');
                        localStorage.setItem('partnerName', data.settings.partnerName || 'Him');
                        localStorage.setItem('myPronouns', data.settings.myPronouns || 'she/her');
                        localStorage.setItem('partnerPronouns', data.settings.partnerPronouns || 'he/him');
                        if (data.settings.myAttachment) localStorage.setItem('myAttachment', data.settings.myAttachment);
                        if (data.settings.partnerAttachment) localStorage.setItem('partnerAttachment', data.settings.partnerAttachment);
                        if (data.settings.myAttachmentSecondary) localStorage.setItem('myAttachmentSecondary', data.settings.myAttachmentSecondary);
                        if (data.settings.partnerAttachmentSecondary) localStorage.setItem('partnerAttachmentSecondary', data.settings.partnerAttachmentSecondary);
                        updateDisplayNames();
                        updateVennDiagram();
                        updateOptimizationProtocols();
                    }
                });

                historyRef.on('value', (snapshot) => {
                    console.log('Firebase snapshot received:', snapshot.exists(), 'Number of children:', snapshot.numChildren());
                    const history = [];
                    snapshot.forEach((child) => {
                        const entry = child.val();
                        console.log('Processing history entry:', entry);
                        history.push(entry);
                    });
                    console.log('Total history entries loaded:', history.length);
                    // Sort by timestamp in JavaScript instead of Firebase query
                    history.sort((a, b) => b.timestamp - a.timestamp);
                    console.log('Sorted history:', history);
                    moodHistory = history;
                    updateMoodCalendar(history);

                    if (currentIdentity && history.length >= 3) {
                        setTimeout(generateInsights, 500);
                        setTimeout(generateWeeklyReflection, 1000);
                    }

                    // Update growth checklist and consistency metrics
                    setTimeout(generateGrowthChecklist, 100);
                    setTimeout(calculateConsistencyMetrics, 150);

                    // Auto-refresh partner context card and status visibility when moods update
                    if (currentIdentity) {
                        setTimeout(showPartnerLatestStatus, 100);
                        setTimeout(updateStatusCardVisibility, 100);
                    }
                });

                db.ref('.info/connected').on('value', (snap) => {
                    const dot = document.getElementById('connection-dot');
                    dot.classList.toggle('connected', snap.val());
                });
            }

            // Load saved identity
            const savedIdentity = localStorage.getItem('identity_' + roomId);
            if (savedIdentity) {
                selectIdentity(savedIdentity, true);
            }
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // ============ ROOM MANAGEMENT ============
        function editRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
        }

        function saveRoomName() {
            const display = document.getElementById('room-name');
            const input = document.getElementById('room-name-input');
            const name = input.value.trim() || 'Node Session';
            display.textContent = name;
            display.style.display = 'inline';
            input.style.display = 'none';
            localStorage.setItem('roomName_' + roomId, name);
        }

        function toggleRoomBar() {
            const roomBar = document.getElementById('room-bar');
            const content = document.getElementById('room-bar-content');
            const toggle = document.querySelector('.room-bar-toggle');

            roomBar.classList.toggle('collapsed');

            if (roomBar.classList.contains('collapsed')) {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            } else {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            }
        }

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('visible');

            // Generate QR code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            // Add a small delay to ensure library is loaded
            setTimeout(() => {
                try {
                    if (typeof QRCode !== 'undefined') {
                        // Create QR code using qrcodejs
                        new QRCode(qrContainer, {
                            text: window.location.href,
                            width: 160,
                            height: 160,
                            colorDark: '#4a4a5a',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    } else {
                        // Library not loaded - show fallback
                        qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">QR Code library loading...<br><span style="font-size: 0.7rem;">(Use link below)</span></div>';
                        console.warn('QRCode library not loaded. Check internet connection.');
                    }
                } catch (e) {
                    console.error('QR Code error:', e);
                    qrContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.8rem; text-align: center; padding: 20px;">Error generating QR code<br><span style="font-size: 0.7rem;">(Copy link below)</span></div>';
                }
            }, 100);
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('visible');
        }

        function openAboutModal() {
            document.getElementById('about-modal').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeAboutModal() {
            document.getElementById('about-modal').classList.remove('visible');
            document.body.style.overflow = '';
        }

        function openMusicModal() {
            document.getElementById('music-modal').classList.add('visible');
            document.body.style.overflow = 'hidden';
            generateMusicSuggestions();
        }

        function closeMusicModal() {
            document.getElementById('music-modal').classList.remove('visible');
            document.body.style.overflow = '';
        }

        function showDisconnectedMusicSuggestion() {
            // Create a floating notification for the disconnected song
            const notification = document.createElement('div');
            notification.className = 'music-notification';
            notification.innerHTML = `
                <div class="music-notif-header">
                    <span class="music-notif-icon">üéµ</span>
                    <span class="music-notif-title">Suggested for you</span>
                    <button class="music-notif-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                </div>
                <div class="music-notif-body">
                    <div class="music-notif-song">"Solo" by The Story So Far</div>
                    <div class="music-notif-desc">For when you're feeling disconnected</div>
                </div>
                <div class="music-notif-actions">
                    <a href="https://music.apple.com/us/album/solo/1440852673?i=1440852858" target="_blank" class="music-notif-btn apple">
                        Listen on Apple Music
                    </a>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 15 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.4s ease-out';
                setTimeout(() => notification.remove(), 400);
            }, 15000);
        }

        function generateMusicSuggestions() {
            const playlistsContainer = document.getElementById('music-playlists');
            const myStateEl = document.getElementById('music-my-state');
            const partnerStateEl = document.getElementById('music-partner-state');

            // Get current moods from most recent logged entries
            const myRecentMood = moodHistory
                .filter(h => h.person === currentIdentity)
                .sort((a, b) => b.timestamp - a.timestamp)[0];
            const partnerRecentMood = moodHistory
                .filter(h => h.person !== currentIdentity)
                .sort((a, b) => b.timestamp - a.timestamp)[0];

            const myMood = myRecentMood?.mood;
            const partnerMood = partnerRecentMood?.mood;

            // Update state badges
            if (myMood) {
                const moodLabels = moodData[currentIdentity];
                myStateEl.textContent = `You: ${moodLabels[myMood]?.label || myMood}`;
                myStateEl.className = 'music-state-badge ' + (currentIdentity === 'me' ? 'me' : 'you');
            } else {
                myStateEl.textContent = 'Select your mood first';
                myStateEl.className = 'music-state-badge';
            }

            if (partnerMood) {
                const partnerIdentity = currentIdentity === 'me' ? 'partner' : 'me';
                const partnerMoodLabels = moodData[partnerIdentity];
                partnerStateEl.textContent = `Partner: ${partnerMoodLabels[partnerMood]?.label || partnerMood}`;
                partnerStateEl.className = 'music-state-badge ' + (currentIdentity === 'me' ? 'you' : 'me');
            } else {
                partnerStateEl.textContent = 'Awaiting partner status';
                partnerStateEl.className = 'music-state-badge';
            }

            if (!myMood) {
                playlistsContainer.innerHTML = '<div class="music-loading">Log your mood to get personalized music suggestions...</div>';
                return;
            }

            // Generate playlist suggestions based on mood combinations
            const playlists = getMusicRecommendations(myMood, partnerMood);

            const html = playlists.map(playlist => `
                <div class="music-playlist-card">
                    <div class="music-playlist-icon">${playlist.icon}</div>
                    <div class="music-playlist-info">
                        <div class="music-playlist-name">${playlist.name}</div>
                        <div class="music-playlist-desc">${playlist.description}</div>
                        <div class="music-playlist-reason">${playlist.reason}</div>
                    </div>
                    <div class="music-playlist-links">
                        <a href="${playlist.appleMusic}" target="_blank" class="music-playlist-link apple">
                             Apple Music ‚Üí
                        </a>
                        <a href="${playlist.spotify}" target="_blank" class="music-playlist-link spotify">
                             Spotify ‚Üí
                        </a>
                    </div>
                </div>
            `).join('');

            playlistsContainer.innerHTML = html;
        }

        function getMusicRecommendations(myMood, partnerMood) {
            const playlists = [];

            const regulated = ['good', 'calm', 'connected', 'playful', 'content', 'reconnect'];
            const activated = ['anxious', 'overwhelmed'];
            const disconnected = ['disconnected', 'shutdown', 'withdrawn'];

            const myRegulated = regulated.includes(myMood);
            const partnerRegulated = partnerMood && regulated.includes(partnerMood);
            const myActivated = activated.includes(myMood);
            const partnerActivated = partnerMood && activated.includes(partnerMood);

            // Both regulated - uplifting/connection music
            if (myRegulated && partnerRegulated) {
                playlists.push({
                    icon: 'üåü',
                    name: 'Peaceful Piano',
                    description: 'Gentle, calming instrumental piano',
                    reason: 'Both partners calm - maintain this regulated state',
                    appleMusic: 'https://music.apple.com/us/playlist/peaceful-piano/pl.c12bd5f3b456482ab2691acbff6a774a',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DX4sWSpwq3LiO'
                });
                playlists.push({
                    icon: 'üí´',
                    name: 'Chill Hits',
                    description: 'Relaxed, feel-good vibes',
                    reason: 'Perfect for shared calm moments',
                    appleMusic: 'https://music.apple.com/us/playlist/todays-chill/pl.9fdc47146fc243bb807004afe29e05fc',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DWU0ScTcjJBdj'
                });
            }

            // One or both activated - calming/grounding music
            if (myActivated || partnerActivated) {
                playlists.push({
                    icon: 'üåä',
                    name: 'Deep Focus',
                    description: 'Ambient electronic for concentration',
                    reason: 'Helps regulate nervous system during activation',
                    appleMusic: 'https://music.apple.com/us/playlist/deep-focus/pl.c2273b7e89b44121b3093f67228918e7',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DWZeKCadgRdKQ'
                });
                playlists.push({
                    icon: 'üßò',
                    name: 'Calm Meditation',
                    description: 'Soothing sounds for anxiety relief',
                    reason: 'Research-backed for stress reduction',
                    appleMusic: 'https://music.apple.com/us/playlist/meditation-music/pl.567c9c4608e64373919f558078ea29f0',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DWZqd5JICZI0u'
                });
            }

            // Disconnected/shutdown - gentle, non-demanding music
            if (disconnected.includes(myMood) || (partnerMood && disconnected.includes(partnerMood))) {
                playlists.push({
                    icon: 'üåô',
                    name: 'Ambient Relaxation',
                    description: 'Gentle soundscapes, no lyrics',
                    reason: 'Low-stimulation for shutdown states',
                    appleMusic: 'https://music.apple.com/us/playlist/pure-ambient/pl.b1078b2e00b54d97b2d6dc6f5c7cf3b8',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DWXe9gFZP0gtP'
                });
                playlists.push({
                    icon: 'üå≤',
                    name: 'Nature Sounds',
                    description: 'Rain, forest, ocean waves',
                    reason: 'Grounding without emotional demands',
                    appleMusic: 'https://music.apple.com/us/playlist/nature-sounds/pl.b35d54f3f2a943b5a99e63c45ed9f78d',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DWVFeEut75IAL'
                });
            }

            // Playful/connected - upbeat but not overwhelming
            if (myMood === 'playful' || partnerMood === 'playful') {
                playlists.push({
                    icon: '‚ú®',
                    name: 'Feel Good Indie',
                    description: 'Uplifting indie and alternative',
                    reason: 'Light, positive energy for playful moods',
                    appleMusic: 'https://music.apple.com/us/playlist/indie-pop/pl.1bb64568059547969a95d0d35cc4e589',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DX2sUQwD7tbmL'
                });
            }

            // Both good/reconnecting - celebration music
            if ((myMood === 'good' || myMood === 'reconnect') && (partnerMood === 'good' || partnerMood === 'reconnect')) {
                playlists.push({
                    icon: 'üíï',
                    name: 'Love Songs',
                    description: 'Romantic, connection-focused',
                    reason: 'Celebrate your regulated connection',
                    appleMusic: 'https://music.apple.com/us/playlist/love-songs/pl.4f87c2b0c1154b11a9eba26bfb0c0bdb',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DX50QitC6Oqtn'
                });
            }

            // Default calming playlists
            if (playlists.length === 0) {
                playlists.push({
                    icon: 'üéµ',
                    name: 'Acoustic Chill',
                    description: 'Soft acoustic tracks',
                    reason: 'Versatile for any mood state',
                    appleMusic: 'https://music.apple.com/us/playlist/acoustic-chill/pl.83c4c5f0b6c44433ab76bbd5c3fbdfe1',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DX0SM0LYsmbMT'
                });
                playlists.push({
                    icon: 'üå∏',
                    name: 'Lofi Beats',
                    description: 'Mellow hip-hop instrumentals',
                    reason: 'Non-intrusive background music',
                    appleMusic: 'https://music.apple.com/us/playlist/lofi-chill/pl.2d86c226b7084775bb5642a36c537828',
                    spotify: 'https://open.spotify.com/playlist/37i9dQZF1DWWQRwui0ExPn'
                });
            }

            return playlists;
        }

        // ============ MESSAGE ANALYSIS ============
        function openMessageAnalysis() {
            document.getElementById('message-modal').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeMessageAnalysis() {
            document.getElementById('message-modal').classList.remove('visible');
            document.body.style.overflow = '';
        }

        function processMessageFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                analyzeMessages(content);
            };
            reader.readAsText(file);
        }

        function analyzeMessages(textContent) {
            // Parse message patterns
            const lines = textContent.split('\n');
            const myName = localStorage.getItem('myName') || 'Me';
            const partnerName = localStorage.getItem('partnerName') || 'Partner';

            let myMessages = 0;
            let partnerMessages = 0;
            let totalMessages = lines.length;

            // Try to detect who sent each message (basic pattern matching)
            lines.forEach(line => {
                if (line.includes(myName) || line.toLowerCase().includes('me:')) {
                    myMessages++;
                } else if (line.includes(partnerName) || line.toLowerCase().includes('you:')) {
                    partnerMessages++;
                }
            });

            // Calculate patterns
            const myPercentage = Math.round((myMessages / totalMessages) * 100);
            const partnerPercentage = Math.round((partnerMessages / totalMessages) * 100);

            // Display analysis
            const analysisHTML = `
                <div class="message-stat-card">
                    <div class="stat-label">Total Messages Analyzed</div>
                    <div class="stat-value">${totalMessages}</div>
                </div>
                <div class="message-stat-card">
                    <div class="stat-label">${myName}'s Messages</div>
                    <div class="stat-value">${myMessages} (${myPercentage}%)</div>
                </div>
                <div class="message-stat-card">
                    <div class="stat-label">${partnerName}'s Messages</div>
                    <div class="stat-value">${partnerMessages} (${partnerPercentage}%)</div>
                </div>
                <div class="message-insight">
                    <strong>Communication Pattern:</strong><br>
                    ${myPercentage > 60 ? `${myName} initiates more - may indicate anxious attachment pursuing connection` : ''}
                    ${partnerPercentage > 60 ? `${partnerName} initiates more - balanced or secure communication` : ''}
                    ${Math.abs(myPercentage - partnerPercentage) < 20 ? 'Balanced communication - both partners contributing equally' : ''}
                </div>
            `;

            document.getElementById('message-analysis-content').innerHTML = analysisHTML;
            document.getElementById('message-stats').style.display = 'block';
        }

        function openImageModal() {
            document.getElementById('image-modal').classList.add('visible');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('visible');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function copyLink() {
            const link = document.getElementById('share-link').value;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.querySelector('.copy-link-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }

        function shareViaText() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`sms:?body=Connect to coupled systems interface "${name}": ${link}`);
        }

        function shareViaEmail() {
            const link = window.location.href;
            const name = document.getElementById('room-name').textContent;
            window.open(`mailto:?subject=Node Session Invitation&body=Connect to coupled systems interface "${name}": ${link}`);
        }

        function createNewRoom() {
            if (confirm('Create a new room? You can always come back to this one using the link.')) {
                // Clear room-specific data
                localStorage.removeItem('lastRoom');
                localStorage.removeItem('identity_' + roomId);
                localStorage.removeItem('roomName_' + roomId);

                // Clear personalization settings so they don't carry over
                localStorage.removeItem('myName');
                localStorage.removeItem('partnerName');
                localStorage.removeItem('myPronouns');
                localStorage.removeItem('partnerPronouns');
                localStorage.removeItem('myAttachment');
                localStorage.removeItem('partnerAttachment');
                localStorage.removeItem('myAttachmentSecondary');
                localStorage.removeItem('partnerAttachmentSecondary');

                // Redirect to clean room
                window.location.href = window.location.pathname;
            }
        }

        // ============ IDENTITY ============
        function selectIdentity(identity, silent = false) {
            currentIdentity = identity;
            localStorage.setItem('identity_' + roomId, identity);

            // Update UI
            document.querySelectorAll('.identity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.identity-btn.${identity}`).classList.add('active');

            // Show badge with saved name
            const myName = localStorage.getItem('myName') || 'Her';
            const partnerName = localStorage.getItem('partnerName') || 'Him';
            const badge = document.getElementById('identity-badge');
            badge.textContent = identity === 'me' ? myName : partnerName;
            badge.className = `identity-badge ${identity}`;
            badge.style.display = 'inline-block';

            // Hide welcome after selection
            if (!silent) {
                document.getElementById('welcome-card').style.display = 'none';
            }

            // Show mood section
            document.getElementById('mood-section').classList.add('visible');
            populateMoodButtons();

            // Update all display names and UI elements
            updateDisplayNames();
            updateVennDiagram();
            updateOptimizationProtocols();

            // Update attachment badges for both nodes
            const myAttachment = localStorage.getItem('myAttachment');
            const partnerAttachment = localStorage.getItem('partnerAttachment');
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary');
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary');
            if (myAttachment) updateAttachmentBadge('me', myAttachment, myAttachmentSecondary);
            if (partnerAttachment) updateAttachmentBadge('you', partnerAttachment, partnerAttachmentSecondary);

            // Update all dashboard components with fresh data
            updateMoodCalendar(moodHistory);
            calculateConsistencyMetrics();
            generateGrowthChecklist();

            // Generate insights and reflections if enough data
            if (moodHistory.length >= 3) {
                setTimeout(generateInsights, 500);
                setTimeout(generateWeeklyReflection, 1000);
            }

            // Show partner's latest status in context card
            showPartnerLatestStatus();

            // Update status cards to show only partner's card
            updateStatusCardVisibility();

            // Refresh live status and system health from Firebase
            if (roomRef) {
                roomRef.once('value').then(snapshot => {
                    const data = snapshot.val() || {};
                    updateLiveStatus(data);
                    updateSystemHealth(data);
                }).catch(err => {
                    console.error('Error refreshing Firebase data:', err);
                });
            }

            if (!silent) {
                document.getElementById('mood-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateStatusCardVisibility() {
            if (!currentIdentity) return;

            // Show partner's card, hide own card
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';

            document.getElementById(`status-card-${currentIdentity}`).style.display = 'none';
            document.getElementById(`status-card-${partnerIdentity}`).style.display = 'block';
        }

        function populateMoodButtons() {
            const container = document.getElementById('mood-buttons');
            const moods = moodData[currentIdentity];
            container.innerHTML = '';
            
            // Check for existing mood today
            let todayMood = null;
            if (previousData && previousData[currentIdentity]) {
                const ts = previousData[currentIdentity].timestamp;
                if (new Date(ts).toDateString() === new Date().toDateString()) {
                    todayMood = previousData[currentIdentity].mood;
                    currentMoodKey = todayMood;
                    document.getElementById('note-box').classList.add('visible');
                }
            }

            Object.keys(moods).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'mood-btn';
                btn.textContent = moods[key].label;
                btn.onclick = function() { selectMood(key, this); };
                if (key === todayMood) {
                    btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');
                }
                container.appendChild(btn);
            });
        }

        // ============ MOOD SELECTION ============
        function selectMood(moodKey, btn) {
            currentMoodKey = moodKey;
            const mood = moodData[currentIdentity][moodKey];

            // Update buttons
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active-me', 'active-you'));
            btn.classList.add(currentIdentity === 'me' ? 'active-me' : 'active-you');

            // Show note box
            document.getElementById('note-box').classList.add('visible');
            document.getElementById('note-input').value = '';

            // Floating hearts for "good"
            if (moodKey === 'good') createFloatingHearts(btn);

            // Auto-suggest music for "disconnected"
            if (moodKey === 'disconnected') {
                showDisconnectedMusicSuggestion();
            }

            // Save
            const timestamp = Date.now();
            const update = {
                mood: moodKey,
                label: mood.label,
                message: mood.message,
                customNote: '',
                timestamp: timestamp
            };

            if (roomRef && historyRef) {
                // Update current mood status
                roomRef.child(currentIdentity).set(update);

                // Save to history - always save so history reflects mood changes
                const historyEntry = {
                    person: currentIdentity,
                    mood: moodKey,
                    label: mood.label,
                    emoji: moodEmojis[moodKey],
                    timestamp: timestamp
                };
                historyRef.push(historyEntry).then(() => {
                    console.log('Mood saved to history:', historyEntry);
                }).catch(err => {
                    console.error('Failed to save mood to history:', err);
                });
            } else {
                console.warn('Firebase not initialized - mood not saved');
            }

            showInsight(currentIdentity, moodKey, false);

            // Partner context card will auto-update via Firebase listener
        }

        function sendNote() {
            const note = document.getElementById('note-input').value.trim();
            if (!currentMoodKey) return;

            const mood = moodData[currentIdentity][currentMoodKey];
            const update = {
                mood: currentMoodKey,
                label: mood.label,
                message: mood.message,
                customNote: note,
                timestamp: Date.now()
            };

            if (roomRef) {
                roomRef.child(currentIdentity).set(update).then(() => {
                    document.getElementById('note-input').value = '';
                    document.getElementById('note-input').placeholder = 'Sent! ‚ô°';
                    setTimeout(() => {
                        document.getElementById('note-input').placeholder = 'Anything else you want to share...';
                    }, 2000);
                });
                // Don't save to history here - it was already saved in selectMood()
            }
        }

        // ============ MOOD ENTRY DELETION ============
        function deleteMoodEntry(timestamp) {
            // Convert timestamp to number if it's a string
            const timestampNum = typeof timestamp === 'string' ? parseInt(timestamp, 10) : timestamp;

            console.log('Delete requested:', { timestamp: timestampNum, currentIdentity });
            console.log('MoodHistory entries:', moodHistory.map(e => ({ timestamp: e.timestamp, person: e.person })));

            // Find the entry to delete
            const entryToDelete = moodHistory.find(e => e.timestamp === timestampNum && e.person === currentIdentity);

            console.log('Entry to delete:', entryToDelete);

            if (!entryToDelete) {
                alert(`Entry not found or you do not have permission to delete it.\n\nYour identity: ${currentIdentity}\nTimestamp: ${timestampNum}`);
                return;
            }

            // Confirmation dialog
            const entryDate = new Date(timestampNum).toLocaleString();
            const entryMood = entryToDelete.mood;
            const confirmMessage = `Delete this mood entry?\n\n${entryToDelete.emoji || moodEmojis[entryMood]} ${entryMood}\n${entryDate}\n\nThis action cannot be undone.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Delete from Firebase
            if (historyRef) {
                // Find the Firebase key for this entry
                historyRef.orderByChild('timestamp').equalTo(timestampNum).once('value', snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const entry = childSnapshot.val();
                        // Verify it's the current user's entry
                        if (entry.person === currentIdentity && entry.timestamp === timestampNum) {
                            childSnapshot.ref.remove().then(() => {
                                console.log('Mood entry deleted from Firebase:', timestampNum);

                                // Remove from local moodHistory array
                                const index = moodHistory.findIndex(e => e.timestamp === timestampNum && e.person === currentIdentity);
                                if (index !== -1) {
                                    moodHistory.splice(index, 1);
                                }

                                // Refresh displays
                                updateMoodCalendar(moodHistory);
                                calculateConsistencyMetrics();
                                generateWeeklyReflection();

                                // Show success message
                                alert('Entry deleted successfully.');
                            }).catch(err => {
                                console.error('Failed to delete entry from Firebase:', err);
                                alert('Failed to delete entry. Please try again.');
                            });
                        }
                    });
                });
            } else {
                alert('Firebase not initialized. Cannot delete entry.');
            }
        }

        // ============ PRIVATE NOTES (PARTNER VISIBILITY TOGGLE) ============
        function togglePrivateNotes() {
            const privateBox = document.getElementById('private-note-box');
            const isVisible = privateBox.style.display !== 'none';

            if (isVisible) {
                privateBox.style.display = 'none';
            } else {
                privateBox.style.display = 'block';
                loadPrivateNote();
                displayPrivateNotes();
            }
        }

        function savePrivateNote() {
            const note = document.getElementById('private-note-input').value;
            if (!note.trim()) return;

            const timestamp = Date.now();

            // Save to localStorage with timestamp
            const privateNotes = JSON.parse(localStorage.getItem('privateNotes') || '[]');
            privateNotes.push({
                note: note,
                timestamp: timestamp,
                mood: currentMoodKey || 'general'
            });
            localStorage.setItem('privateNotes', JSON.stringify(privateNotes));

            // Show saved confirmation
            const savedIndicator = document.getElementById('private-note-saved');
            savedIndicator.style.display = 'block';
            setTimeout(() => {
                savedIndicator.style.display = 'none';
            }, 2000);

            // Clear the input
            document.getElementById('private-note-input').value = '';

            // Refresh the notes display
            displayPrivateNotes();
        }

        function loadPrivateNote() {
            // Load most recent private note for current mood if available
            const privateNotes = JSON.parse(localStorage.getItem('privateNotes') || '[]');
            if (privateNotes.length > 0 && currentMoodKey) {
                const recentNote = privateNotes
                    .filter(n => n.mood === currentMoodKey)
                    .sort((a, b) => b.timestamp - a.timestamp)[0];

                if (recentNote) {
                    document.getElementById('private-note-input').placeholder =
                        `Last note for this mood: "${recentNote.note.substring(0, 50)}${recentNote.note.length > 50 ? '...' : ''}"`;
                }
            }
        }

        function displayPrivateNotes() {
            const privateNotes = JSON.parse(localStorage.getItem('privateNotes') || '[]');
            const notesList = document.getElementById('private-notes-list');

            if (privateNotes.length === 0) {
                notesList.innerHTML = '<div style="color: #94a3b8; font-size: 0.875rem; text-align: center; padding: 20px;">No notes yet. Start writing!</div>';
                return;
            }

            // Sort by timestamp, newest first
            const sortedNotes = privateNotes.sort((a, b) => b.timestamp - a.timestamp);

            notesList.innerHTML = sortedNotes.map((note, index) => {
                const date = new Date(note.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const moodLabel = note.mood && moodData[note.mood] ? moodData[note.mood].label : 'General';

                return `
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(217, 119, 6, 0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; gap: 10px;">
                            <div style="font-size: 0.75rem; color: #f59e0b; flex: 1; min-width: 0;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${moodLabel}</div>
                                <div style="color: #94a3b8;">${dateStr} at ${timeStr}</div>
                            </div>
                            <button onclick="deletePrivateNote(${index})" style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 0.875rem; padding: 0; flex-shrink: 0;">‚úï</button>
                        </div>
                        <div style="color: #e2e8f0; font-size: 0.875rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${note.note}</div>
                    </div>
                `;
            }).join('');
        }

        function deletePrivateNote(index) {
            if (!confirm('Delete this note?')) return;

            const privateNotes = JSON.parse(localStorage.getItem('privateNotes') || '[]');
            const sortedNotes = privateNotes.sort((a, b) => b.timestamp - a.timestamp);
            sortedNotes.splice(index, 1);
            localStorage.setItem('privateNotes', JSON.stringify(sortedNotes));
            displayPrivateNotes();
        }

        function clearAllPrivateNotes() {
            if (!confirm('Delete ALL private notes? This cannot be undone.')) return;

            localStorage.removeItem('privateNotes');
            displayPrivateNotes();
        }

        function openTherapyExport() {
            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary') || '';
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary') || '';
            const myName = localStorage.getItem('myName') || 'Node A';
            const partnerName = localStorage.getItem('partnerName') || 'Node B';
            const myPronouns = localStorage.getItem('myPronouns') || 'she/her';
            const partnerPronouns = localStorage.getItem('partnerPronouns') || 'he/him';

            // Get most recent moods from history
            const myRecentMood = moodHistory
                .filter(h => h.person === 'me')
                .sort((a, b) => b.timestamp - a.timestamp)[0];
            const partnerRecentMood = moodHistory
                .filter(h => h.person === 'partner')
                .sort((a, b) => b.timestamp - a.timestamp)[0];

            const timestamp = new Date().toLocaleString();

            const report = `ATTACHMENT WORKBOOK - THERAPY SESSION NOTES
Generated: ${timestamp}

=== SYSTEM CONFIGURATION ===
Node A: ${myName} (${myPronouns})
- Primary Attachment Style: ${myAttachment}
${myAttachmentSecondary ? `- Secondary Style: ${myAttachmentSecondary}` : ''}
- Current Status: ${myRecentMood ? myRecentMood.mood : 'Not set'}

Node B: ${partnerName} (${partnerPronouns})
- Primary Attachment Style: ${partnerAttachment}
${partnerAttachmentSecondary ? `- Secondary Style: ${partnerAttachmentSecondary}` : ''}
- Current Status: ${partnerRecentMood ? partnerRecentMood.mood : 'Not set'}

=== CURRENT DYNAMICS ===
${myRecentMood ? `Node A Mood: ${myRecentMood.mood} - ${myRecentMood.message || ''}` : ''}
${partnerRecentMood ? `Node B Mood: ${partnerRecentMood.mood} - ${partnerRecentMood.message || ''}` : ''}

=== PATTERN NOTES ===
(Space for therapist/client notes about recurring patterns)

- Communication Style:

- Conflict Resolution:

- Connection Needs:

- Autonomy Needs:

=== ACTION ITEMS ===
(Goals and homework for next session)

1.
2.
3.

=== NEXT SESSION ===
Date: _______________
Focus Areas:

---
Generated by Attachment Workbook - Systems Engineering Approach to Relationships
`;

            // Create download
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `therapy-notes-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('‚úÖ Therapy notes exported! Check your downloads folder.');
        }

        function openDateNightIdeas() {
            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';

            // Get partner mood from previousData
            const partner = currentIdentity === 'me' ? 'you' : 'me';
            const partnerMood = previousData[partner] ? previousData[partner].mood : null;

            const ideas = [];

            // Low energy / shutdown states
            if (currentMoodKey === 'shutdown' || partnerMood === 'shutdown' ||
                currentMoodKey === 'processing' || partnerMood === 'processing') {
                ideas.push('üõãÔ∏è Low-Bandwidth Connection: Watch a show together with minimal talking required. Physical proximity without demands.');
                ideas.push('üìö Parallel Processing: Same room, different activities. Read books, work on hobbies, occasional check-ins.');
            }

            // Anxious attachment needs
            if (myAttachment === 'anxious' || partnerAttachment === 'anxious') {
                ideas.push('üë®‚Äçüç≥ Quality Time Intensive: Cooking together, board game, deep conversation over dinner.');
                ideas.push('üé¢ Planned Adventure: Try something new together - builds shared experience and connection.');
            }

            // Avoidant attachment needs
            if (myAttachment === 'avoidant' || partnerAttachment === 'avoidant') {
                ideas.push('ü•æ Side-by-Side Activity: Hike, bike ride, museum visit - connected but with natural breaks in conversation.');
                ideas.push('üé¨ Structured Date: Movie, concert, or event with clear start/end time and built-in topic of conversation.');
            }

            // Connected/calm states
            if ((currentMoodKey === 'connected' || currentMoodKey === 'calm') &&
                (partnerMood === 'connected' || partnerMood === 'calm')) {
                ideas.push('üí¨ Relationship Check-In: Appreciate what\'s working. Discuss system optimization over nice dinner.');
                ideas.push('‚ú® Try Something New: Good time to expand comfort zone together - new restaurant, activity, or experience.');
            }

            // Conflict state
            if (currentMoodKey === 'conflict' || partnerMood === 'conflict') {
                ideas.push('üéÆ Reset Activity: Low-stakes fun to rebuild connection - mini golf, arcade, ice cream walk.');
            }

            // Both need space
            if (currentMoodKey === 'needSpace' && partnerMood === 'needSpace') {
                ideas.push('üîÑ Separate But Together: Solo activities in morning, brief connection point for lunch, back to solo time.');
            }

            // Both need closeness
            if (currentMoodKey === 'needClose' && partnerMood === 'needClose') {
                ideas.push('‚ù§Ô∏è Intimacy Focus: Stay home, eliminate distractions, full focus on each other. Talk, touch, connect.');
            }

            // Default suggestions
            if (ideas.length === 0) {
                ideas.push('üçΩÔ∏è Classic Dinner Date: Nice restaurant, dress up a bit, have real conversation.');
                ideas.push('üèÉ Active Date: Physical activity together - hike, bike, dance class, rock climbing.');
                ideas.push('üè† Home Cozy Night: Cook together, movie, games - comfortable and low-pressure.');
            }

            const ideaList = ideas.map((idea, i) => `${i + 1}. ${idea}`).join('\n\n');
            alert(`üíï ATTACHMENT-AWARE DATE NIGHT IDEAS\n\nBased on your current attachment styles and moods:\n\n${ideaList}`);
        }

        function createFloatingHearts(el) {
            const rect = el.getBoundingClientRect();
            const container = document.createElement('div');
            container.className = 'floating-hearts';
            container.style.left = rect.left + rect.width / 2 + 'px';
            container.style.top = rect.top + 'px';
            document.body.appendChild(container);

            const hearts = ['‚ô°', 'üíï', '‚ú®', 'üíó'];
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const heart = document.createElement('span');
                    heart.className = 'floating-heart';
                    heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                    heart.style.left = (Math.random() - 0.5) * 50 + 'px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 2000);
                }, i * 80);
            }
            setTimeout(() => container.remove(), 2500);
        }

        // ============ LIVE STATUS ============
        function updateLiveStatus(data) {
            ['me', 'you'].forEach(person => {
                const moodEl = document.getElementById(`live-mood-${person}`);
                const timeEl = document.getElementById(`live-time-${person}`);
                const card = moodEl.closest('.live-status-card');

                if (data && data[person]) {
                    const isNew = !previousData[person] || previousData[person].timestamp !== data[person].timestamp;
                    
                    moodEl.textContent = data[person].label;
                    moodEl.classList.add('active');
                    card.classList.add('has-mood');
                    
                    if (isNew) {
                        card.classList.remove('just-updated');
                        void card.offsetWidth;
                        card.classList.add('just-updated');
                    }

                    timeEl.textContent = formatTime(new Date(data[person].timestamp));

                    if (currentIdentity && person !== currentIdentity) {
                        showPartnerMessage(data[person]);
                    }
                } else {
                    moodEl.textContent = '// Awaiting initial broadcast';
                    moodEl.classList.remove('active');
                    card.classList.remove('has-mood');
                    timeEl.textContent = '';
                }
            });
            previousData = JSON.parse(JSON.stringify(data || {}));
        }

        function formatTime(date) {
            const diff = Date.now() - date;
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function showPartnerMessage(data) {
            const container = document.getElementById('partner-message');
            const label = document.getElementById('partner-message-label');
            const text = document.getElementById('partner-message-text');
            const partnerIs = currentIdentity === 'me' ? 'Node B' : 'Node A';

            label.textContent = `Incoming message from ${partnerIs}`;
            let html = data.message;
            if (data.customNote) {
                html += `<div class="custom-note"><span class="custom-note-label">Added:</span>${data.customNote}</div>`;
            }
            text.innerHTML = html;
            container.classList.add('visible');

            // Show insight for partner's mood
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';
            showInsight(partnerIdentity, data.mood, true);

            // Show partner context card
            showPartnerContextCard(data.mood, partnerIdentity);
        }

        // ============ PARTNER CONTEXT CARD ============
        function showPartnerLatestStatus() {
            if (!currentIdentity) return;

            // Get partner's identity (opposite of current)
            // currentIdentity is 'me' or 'you', and person field is also 'me' or 'you'
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';

            // Find partner's most recent mood entry
            const partnerEntries = moodHistory.filter(h => h.person === partnerIdentity);

            if (partnerEntries.length === 0) {
                // No partner mood yet - hide card or show message
                const card = document.getElementById('partner-context-card');
                card.style.display = 'none';
                return;
            }

            // Get most recent partner mood (moodHistory is already sorted newest first)
            const latestPartnerMood = partnerEntries[0];

            // Show context card for partner's mood
            showPartnerContextCard(latestPartnerMood.mood, partnerIdentity);
        }

        function showPartnerContextCard(moodKey, personIdentity) {
            const card = document.getElementById('partner-context-card');

            // Names are stored as Node A = myName, Node B = partnerName (absolute)
            const nodeAName = localStorage.getItem('myName') || 'Node A';
            const nodeBName = localStorage.getItem('partnerName') || 'Node B';
            const nodeAAttachment = localStorage.getItem('myAttachment') || 'anxious';
            const nodeBAttachment = localStorage.getItem('partnerAttachment') || 'avoidant';

            // Determine whose info to display based on personIdentity
            // personIdentity is 'me' or 'you'
            const displayName = personIdentity === 'me' ? nodeAName : nodeBName;
            const personAttachment = personIdentity === 'me' ? nodeAAttachment : nodeBAttachment;

            // Get current user's attachment for context
            const myAttachment = currentIdentity === 'me' ? nodeAAttachment : nodeBAttachment;

            // Update display name
            document.getElementById('context-card-partner-name').textContent = displayName;

            // Update section labels with partner's name for clarity
            document.getElementById('context-label-state').textContent = `${displayName}'s Current State:`;
            document.getElementById('context-label-needs').textContent = `üí≠ What ${displayName} likely needs:`;
            document.getElementById('context-label-fears').textContent = `‚ö†Ô∏è What ${displayName} might be afraid of:`;
            document.getElementById('context-label-actions').textContent = `‚úÖ How you can support ${displayName}:`;
            document.getElementById('context-label-avoid').textContent = `üö´ What NOT to do with ${displayName}:`;
            document.getElementById('context-label-convo').textContent = `üí¨ Conversation starter for ${displayName}:`;

            // Update mood display
            const emoji = moodEmojis[moodKey] || 'üòê';
            document.getElementById('context-emoji').textContent = emoji;
            document.getElementById('context-mood-label').textContent = moodKey;

            // Get context-specific guidance
            // When showing YOUR mood: what you need, how partner can help
            // When showing PARTNER mood: what they need, how you can help
            const context = getPartnerContext(moodKey, personAttachment, myAttachment, displayName);

            // Populate needs
            const needsList = document.getElementById('context-needs-list');
            needsList.innerHTML = context.needs.map(need => `<li>${need}</li>`).join('');

            // Populate fears
            const fearsList = document.getElementById('context-fears-list');
            fearsList.innerHTML = context.fears.map(fear => `<li>${fear}</li>`).join('');

            // Populate actions
            const actionsList = document.getElementById('context-actions-list');
            actionsList.innerHTML = context.actions.map((action, index) => `
                <div class="context-action-card">
                    <div class="action-rank">${index + 1}</div>
                    <div class="action-content">
                        <div class="action-title">${action.title}</div>
                        <div class="action-desc">${action.desc}</div>
                    </div>
                </div>
            `).join('');

            // Populate avoid list
            const avoidList = document.getElementById('context-avoid-list');
            avoidList.innerHTML = context.avoid.map(item => `<li>${item}</li>`).join('');

            // Set conversation starter
            document.getElementById('context-conversation-box').innerHTML = `<em>${context.conversation}</em>`;

            // Show card
            card.style.display = 'block';
        }

        function getPartnerContext(moodKey, partnerAttachment, myAttachment, partnerName) {
            // Research-backed guidance database: mood √ó attachment style
            const contexts = {
                anxious: {
                    anxious: {
                        needs: ['Low-latency acknowledgment packet', 'Clear SLA for next sync', 'Explicit keep-alive signal'],
                        fears: ['Connection timeout (permanent)', 'Sent malformed request', 'Link degradation detected'],
                        actions: [
                            { title: 'Send ACK Packet', desc: 'Brief "thinking of you ‚ô°" or status ping' },
                            { title: 'Set Reconnect Window', desc: 'Specific timestamp: "Let\'s sync at 7pm"' },
                            { title: 'Acknowledge Status Code', desc: 'Validate their signal: "I see HIGH_LOAD - what do you need?"' }
                        ],
                        avoid: ['Dropped packets (going silent)', 'Saying "traffic too high"', 'Initiating shutdown sequence'],
                        conversation: `"Hey ${partnerName || 'love'}, I see you're broadcasting HIGH_LOAD. Connection stable - I'm here. Want to discuss?"`
                    },
                    avoidant: {
                        needs: ['Buffer space without dropped connection', 'Understanding async ‚â† offline', 'Patience during processing'],
                        fears: ['Your constant pings will overload their queue', 'Loss of autonomous processing', 'Your needs = forced dependency'],
                        actions: [
                            { title: 'Grant Processing Time + ACK', desc: '"Take your time - connection persists"' },
                            { title: 'Don\'t Spam Requests', desc: 'One keepalive, then await response' },
                            { title: 'Self-Regulate Load', desc: 'Route your overflow elsewhere - don\'t DDoS them with anxiety' }
                        ],
                        avoid: ['Constant polling when they\'re idle', 'Repeated "are we synced?" checks', 'Making their buffer about your latency'],
                        conversation: `"I see you need processing buffer. Connection stays open - reach out when ready to sync."`
                    },
                    secure: {
                        needs: ['Open communication', 'Balance of connection/autonomy', 'Collaborative problem-solving'],
                        fears: ['Being too anxious for secure partner', 'They\'ll tire of reassuring', 'They don\'t need you'],
                        actions: [
                            { title: 'Communicate Openly', desc: '"I\'m feeling anxious - can we talk?"' },
                            { title: 'Trust Their Consistency', desc: 'Secure partners show up reliably' },
                            { title: 'Practice Self-Soothing', desc: 'Use their stability as anchor' }
                        ],
                        avoid: ['Testing with protest behavior', 'Assuming calm = indifference', 'Creating drama for reassurance'],
                        conversation: `"I'm noticing some anxiety coming up. Can we talk through what I'm feeling?"`
                    },
                    fearful: {
                        needs: ['Gentle, patient communication', 'Safety for contradictory feelings', 'Reassurance without pressure'],
                        fears: ['Both abandonment AND engulfment', 'Vulnerability = hurt', 'Too broken to be loved'],
                        actions: [
                            { title: 'Move Slowly', desc: 'Gentle reassurance without overwhelming' },
                            { title: 'Validate Both Needs', desc: '"Makes sense you\'d want connection AND space"' },
                            { title: 'Be Consistent', desc: 'Predictable presence builds safety' }
                        ],
                        avoid: ['Pushing for quick resolution', 'Taking push-pull personally', 'Giving up when tested'],
                        conversation: `"I see you're anxious. I'm here, and we can go at whatever pace feels right."`
                    }
                },
                overwhelmed: {
                    anxious: {
                        needs: ['Support without fixing', 'Presence without demands', 'Validation it\'s okay to struggle'],
                        fears: ['Being a burden', 'Vulnerability will make you leave', 'Should handle alone'],
                        actions: [
                            { title: 'Low-Pressure Support', desc: '"I\'m here if needed - no pressure to talk"' },
                            { title: 'Validate Experience', desc: '"This sounds hard. You\'re not alone"' },
                            { title: 'Concrete Help', desc: '"Can I [bring dinner/handle X]?"' }
                        ],
                        avoid: ['Minimizing: "It\'s not that bad"', 'Fixing without permission', 'Making it about you'],
                        conversation: `"I see you're overwhelmed. Want to talk, or prefer I just sit with you?"`
                    },
                    avoidant: {
                        needs: ['Space to process', 'Autonomy in handling stress', 'Support respecting independence'],
                        fears: ['Struggle = weakness', 'Help = loss of autonomy', 'You\'ll be overwhelmed too'],
                        actions: [
                            { title: 'Respect Their Process', desc: 'Let them handle it their way' },
                            { title: 'Practical Support', desc: '"Would it help if I handled [task]?"' },
                            { title: 'Available, Not Intrusive', desc: '"I\'m here if needed" then space' }
                        ],
                        avoid: ['Hovering/"are you okay?" every hour', 'Forcing them to lean on you', 'Taking independence as rejection'],
                        conversation: `"I see you're dealing with a lot. Let me know if I can help - otherwise I'll give you space."`
                    },
                    secure: {
                        needs: ['Collaborative stress management', 'Permission to not be okay', 'Partnership in problem-solving'],
                        fears: ['Disappointing you', 'Not meeting standards', 'Letting others down'],
                        actions: [
                            { title: 'Team Approach', desc: '"What can we do together to lighten load?"' },
                            { title: 'Active Listening', desc: 'Ask what they need vs assuming' },
                            { title: 'Share the Load', desc: 'Take specific tasks off their plate' }
                        ],
                        avoid: ['Assuming they\'ll ask if needed', 'Waiting for breakdown', 'Ignoring stress signals'],
                        conversation: `"You seem overwhelmed. Want to talk through your plate and see what I can help with?"`
                    }
                },
                space: {
                    anxious: {
                        needs: ['Idle state without terminating process', 'Reassurance: IDLE ‚â† OFFLINE', 'TTL for next heartbeat'],
                        fears: ['Requesting buffer = protocol violation', 'You\'ll interpret as disconnect', 'Their isolation proves defect'],
                        actions: [
                            { title: 'Grant Idle Time + SLA', desc: 'Acknowledge request without blocking' },
                            { title: 'Request Reconnect Timestamp', desc: '"When should I ping?" (then honor)' },
                            { title: 'Route Load Elsewhere', desc: 'Spin up your own processes - distribute workload' }
                        ],
                        avoid: ['Constant health checks', 'Making their buffer your bottleneck', 'Connection penalty on return'],
                        conversation: `"Acknowledged - take processing time. Connection persists, ping when ready ‚ô°"`
                    },
                    avoidant: {
                        needs: ['Independent thread execution', 'No forced synchronization', 'Trust in async patterns'],
                        fears: ['Both nodes idle = system failure', 'Won\'t find sync point after', 'Mutual buffering = disconnect'],
                        actions: [
                            { title: 'Parallel Processing Mode', desc: 'Both run independently, schedule merge point' },
                            { title: 'Set Explicit Sync Time', desc: '"Let\'s reconnect [specific timestamp]"' },
                            { title: 'Trust Async Design', desc: 'Buffering actually improves avoidant-avoidant throughput' }
                        ],
                        avoid: ['Competing for most distance', 'Forgetting merge commit', 'Using silence as weapon'],
                        conversation: `"Good call - I\'ll process independently too. Sync tomorrow 7pm?"`
                    },
                    secure: {
                        needs: ['Respected autonomy', 'Confidence you\'ll reconnect', 'Space as healthy practice'],
                        fears: ['Minimal - comfortable with space', 'May worry if excessive', 'Pattern shift concern'],
                        actions: [
                            { title: 'Grant Space Easily', desc: '"Take time you need - see you later"' },
                            { title: 'Use Time Productively', desc: 'Your own interests/self-care' },
                            { title: 'Gentle Boundary If Needed', desc: '"Noticing more distance - want to talk?"' }
                        ],
                        avoid: ['Over-analyzing normal space needs', 'Feeling rejected by autonomy', 'Creating problems'],
                        conversation: `"Absolutely, enjoy your time! Let me know when you want to connect."`
                    }
                },
                disconnected: {
                    anxious: {
                        needs: ['Patient reconnection protocol', 'Understanding circuit breaker = protection', 'Low-pressure handshake attempts'],
                        fears: ['Connection permanently terminated', 'Timeout is irreversible', 'Link degradation confirmed'],
                        actions: [
                            { title: 'Don\'t Flood the Line', desc: 'One keepalive, then wait for ACK' },
                            { title: 'Self-Stabilize', desc: 'Route anxiety load elsewhere - don\'t crash their system with panic' },
                            { title: 'Leave Port Open', desc: '"Connection available when ready"' }
                        ],
                        avoid: ['Request spam', 'Catastrophizing normal latency', 'Multiple "link status?" pings'],
                        conversation: `"Detecting TIMEOUT state. Port remains open - initiate handshake when ready."`
                    },
                    avoidant: {
                        needs: ['Isolation mode for system recovery', 'No forced reconnection attempts', 'Clear path to re-establish without audit'],
                        fears: ['Reconnection = immediate overload', 'Loss of core process integrity', 'Vulnerability = exploit risk'],
                        actions: [
                            { title: 'Respect Circuit Breaker', desc: 'Major buffer - don\'t attempt forced sync' },
                            { title: 'Passive Availability Signal', desc: 'Brief "connection available" no response required' },
                            { title: 'Await Their Ping', desc: 'Let them initialize handshake' }
                        ],
                        avoid: ['Forcing synchronous calls', 'Issuing connection ultimatums', 'Penalty for utilizing circuit breaker'],
                        conversation: `"Circuit breaker detected. System available - ping when ready to sync."`
                    }
                },
                reconnect: {
                    anxious: {
                        needs: ['Enthusiasm for their initiative', 'Explicit receptiveness', 'Rewarding vulnerable reaching'],
                        fears: ['You won\'t reciprocate', 'Being needy again', 'Just tolerating them'],
                        actions: [
                            { title: 'Respond Warmly', desc: '"I\'d love to reconnect!"' },
                            { title: 'Make Time Soon', desc: 'Prioritize connection in 24-48hrs' },
                            { title: 'Validate Attempt', desc: '"So glad you reached out"' }
                        ],
                        avoid: ['Lukewarm: "sure, maybe later"', 'Making them work for engagement', 'Punishing earlier distance'],
                        conversation: `"I'm so glad you want to reconnect - I've missed you. When's good?"`
                    },
                    avoidant: {
                        needs: ['THIS IS HUGE - overriding avoidance', 'Gentle, non-overwhelming response', 'Respect for their courage'],
                        fears: ['You\'ll need too much immediately', 'Reconnection = loss of autonomy', 'Will regret vulnerability'],
                        actions: [
                            { title: 'Honor This Moment', desc: 'Recognize how significant this is' },
                            { title: 'Match Energy', desc: 'Don\'t overwhelm - meet where they are' },
                            { title: 'Make It Safe', desc: 'Keep initial reconnection light/low-pressure' }
                        ],
                        avoid: ['Immediate heavy conversations', 'Bringing up all you need to discuss', 'Making them regret reaching'],
                        conversation: `"I'd really like that. Want to [low-key activity] tonight?"`
                    }
                },
                good: {
                    anxious: {
                        needs: ['Sharing joy with you', 'Celebration of positive state', 'Connection while regulated'],
                        fears: ['Good feelings won\'t last', 'You\'re unavailable when happy', 'Letting guard down unsafe'],
                        actions: [
                            { title: 'Share Their Joy', desc: '"That\'s wonderful! Tell me more!"' },
                            { title: 'Optimal Connection Window', desc: 'PERFECT time for quality time' },
                            { title: 'Reinforce Positive', desc: 'Celebrate to build secure base' }
                        ],
                        avoid: ['Being unavailable during good mood', 'Bringing up problems now', 'Dampening positivity'],
                        conversation: `"I love that you're feeling good! Want to grab dinner and celebrate?"`
                    },
                    avoidant: {
                        needs: ['Sharing without pressure', 'Light/easy connection', 'Joy without demands'],
                        fears: ['Good feelings = vulnerability', 'Happiness means you\'ll need more', 'Minimal when feeling good'],
                        actions: [
                            { title: 'Light Connection', desc: 'Enjoy time together without heavy talks' },
                            { title: 'Positive Reinforcement', desc: 'Good experiences = more openness' },
                            { title: 'Respect Their Sharing', desc: 'They chose to include you - honor it' }
                        ],
                        avoid: ['Using good mood for "the talk"', 'Immediately asking for more', 'Assuming problems solved'],
                        conversation: `"So glad you're feeling good! Want to do something fun together?"`
                    },
                    secure: {
                        needs: ['Shared joy', 'Quality time in positive state', 'Building positive memories'],
                        fears: ['Minimal - secure in good moods', 'Want to maintain momentum', 'Protecting relationship health'],
                        actions: [
                            { title: 'Invest in Connection', desc: 'Optimal window for quality time' },
                            { title: 'Create Positive Memories', desc: 'Plan fun activities together' },
                            { title: 'Express Appreciation', desc: 'Share what you value' }
                        ],
                        avoid: ['Taking good moods for granted', 'Immediately pivoting to problems', 'Being too busy'],
                        conversation: `"I'm feeling good too - let's make the most of it! Date night?"`
                    }
                },
                calm: {
                    anxious: {
                        needs: ['Enjoying regulated state', 'Connection without crisis', 'Building positive memories'],
                        fears: ['Calm won\'t last', 'Will mess it up', 'Waiting for other shoe to drop'],
                        actions: [
                            { title: 'Reinforce Calm', desc: 'Positive attention during good times' },
                            { title: 'Quality Connection Time', desc: 'Optimal window for deeper talks' },
                            { title: 'Build on This', desc: 'What\'s working? Do more of it' }
                        ],
                        avoid: ['Ignoring them when calm', 'Only engaging during crisis', 'Bringing up past conflicts'],
                        conversation: `"It's really nice to see you feeling calm. Want to enjoy some time together?"`
                    },
                    avoidant: {
                        needs: ['Peaceful presence', 'Connection that feels easy', 'No pressure during calm'],
                        fears: ['Calm will invite demands', 'You\'ll use calm to push for more', 'Peace will be disrupted'],
                        actions: [
                            { title: 'Enjoy the Calm Together', desc: 'Low-key quality time' },
                            { title: 'Don\'t Push', desc: 'Let calm be enough' },
                            { title: 'Build Positive Association', desc: 'Connection can feel good/safe' }
                        ],
                        avoid: ['Using calm as opportunity for "serious talk"', 'Immediately asking for more closeness', 'Disrupting peace'],
                        conversation: `"You seem really peaceful. Want to just hang out?"`
                    }
                },
                connected: {
                    anxious: {
                        needs: ['Mutual vulnerability', 'Emotional intimacy', 'Savoring the closeness'],
                        fears: ['It won\'t last', 'Will sabotage it', 'Too good to be true'],
                        actions: [
                            { title: 'Be Present', desc: 'Fully engage in the connection' },
                            { title: 'Express Gratitude', desc: '"I really value this closeness"' },
                            { title: 'Resist Anxiety', desc: 'Don\'t test or create problems' }
                        ],
                        avoid: ['Testing: "Do you really love me?"', 'Sabotaging good moment', 'Waiting for abandonment'],
                        conversation: `"I love feeling this connected with you. This is really special."`
                    },
                    avoidant: {
                        needs: ['Intimacy without losing self', 'Closeness that feels safe', 'Connection on their terms'],
                        fears: ['Too much closeness', 'Will be smothered', 'Losing autonomy'],
                        actions: [
                            { title: 'Honor Their Openness', desc: 'HUGE for avoidant - don\'t waste it' },
                            { title: 'Match, Don\'t Overwhelm', desc: 'Meet their level, don\'t push for more' },
                            { title: 'Make It Safe', desc: 'Show connection doesn\'t = loss of self' }
                        ],
                        avoid: ['Immediately wanting deeper commitment', 'Pushing for more vulnerability', 'Making them regret opening up'],
                        conversation: `"This feels really nice. Thanks for letting me in."`
                    }
                },
                playful: {
                    anxious: {
                        needs: ['Light, joyful connection', 'Playfulness without anxiety', 'Fun together'],
                        fears: ['Playfulness will end', 'Not taking relationship seriously enough', 'Joy = vulnerability'],
                        actions: [
                            { title: 'Join the Fun', desc: 'Be playful back!' },
                            { title: 'Create Joy Together', desc: 'Shared laughter builds bonds' },
                            { title: 'Don\'t Overthink', desc: 'Let play be play' }
                        ],
                        avoid: ['Turning playful into serious', 'Analyzing the moment', 'Dampening their energy'],
                        conversation: `"I love seeing this playful side! What do you want to do?"`
                    },
                    avoidant: {
                        needs: ['Light connection', 'Fun without pressure', 'Playfulness as safe intimacy'],
                        fears: ['Play will turn heavy', 'Expectations will follow', 'Minimal - play feels safe'],
                        actions: [
                            { title: 'Match Their Energy', desc: 'Be playful, keep it light' },
                            { title: 'Build Positive Bond', desc: 'Play together = connection without threat' },
                            { title: 'Don\'t Shift Tone', desc: 'Let play stay play' }
                        ],
                        avoid: ['Using playful moment for serious talk', 'Making play into emotional intimacy push', 'Dampening fun'],
                        conversation: `"You're in a good mood! What should we get into?"`
                    }
                },
                content: {
                    anxious: {
                        needs: ['Sharing contentment', 'Peaceful presence', 'Appreciation'],
                        fears: ['Contentment = complacency', 'Not showing enough enthusiasm', 'Peace will end'],
                        actions: [
                            { title: 'Share the Peace', desc: 'Enjoy contentment together' },
                            { title: 'Express Appreciation', desc: '"I love these moments with you"' },
                            { title: 'Don\'t Disrupt', desc: 'Let contentment be enough' }
                        ],
                        avoid: ['Creating drama because it\'s "too quiet"', 'Needing intensity', 'Testing during peace'],
                        conversation: `"You seem really content. I feel that too - it's nice."`
                    },
                    avoidant: {
                        needs: ['Comfortable quiet', 'No pressure', 'Peace together'],
                        fears: ['You\'ll want more than contentment', 'Peace = opportunity for demands', 'Minimal when content'],
                        actions: [
                            { title: 'Comfortable Silence', desc: 'Be together without needing to do/say' },
                            { title: 'Appreciate the Peace', desc: 'This is connection for avoidants' },
                            { title: 'Don\'t Fill the Quiet', desc: 'Let contentment be' }
                        ],
                        avoid: ['Using contentment to push for emotional intimacy', 'Filling peaceful silence', 'Asking for more'],
                        conversation: `"This is really nice. Just being together."`
                    }
                }
            };

            // Default fallback
            const defaultContext = {
                needs: ['Understanding and patience', 'Clear communication', 'Emotional support'],
                fears: ['Rejection', 'Misunderstanding', 'Loss of connection'],
                actions: [
                    { title: 'Open Communication', desc: 'Ask what they need right now' },
                    { title: 'Active Listening', desc: 'Hear without trying to fix' },
                    { title: 'Show Presence', desc: 'Be available and attentive' }
                ],
                avoid: ['Making assumptions', 'Dismissing feelings', 'Making it about you'],
                conversation: `"I see you're feeling ${moodKey}. I'm here - want to talk?"`
            };

            return contexts[moodKey]?.[partnerAttachment] || defaultContext;
        }

        function closePartnerContextCard() {
            document.getElementById('partner-context-card').style.display = 'none';
        }

        // ============ INSIGHTS ============
        function showInsight(person, moodKey, isPartner = false) {
            const mood = moodData[person] && moodData[person][moodKey];
            if (!mood) return;

            document.getElementById('insight-title').textContent = mood.insightTitle;
            
            const label1 = document.getElementById('insight-label-1');
            const label2 = document.getElementById('insight-label-2');
            const text1 = document.getElementById('insight-text-1');
            const text2 = document.getElementById('insight-text-2');

            if (isPartner) {
                const who = person === 'me' ? 'She' : 'He';
                label1.textContent = `What ${who}'s Saying`;
                label2.textContent = 'How I Can Help';
                text1.textContent = mood.message;
                // Show the insight for the CURRENT user (partner of the person who set the mood)
                text2.textContent = currentIdentity === 'me' ? mood.insightMe : mood.insightYou;
            } else {
                label1.textContent = 'Reminder for Me';
                label2.textContent = 'What They\'ll See';
                text1.textContent = person === 'me' ? mood.insightMe : mood.insightYou;
                text2.textContent = mood.message;
            }

            document.getElementById('insight-panel').classList.add('visible');
        }

        function closeInsight() {
            document.getElementById('insight-panel').classList.remove('visible');
        }

        // ============ COMBO ALERTS ============
        function checkForComboAlert(data) {
            if (!data.me || !data.you) return;

            const alert = document.getElementById('combo-alert');
            const text = document.getElementById('combo-alert-text');
            const tension = ['anxious', 'overwhelmed', 'disconnected'];

            // Get attachment styles for context-aware alerts
            const myAttachment = localStorage.getItem('myAttachment') || 'anxious';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'avoidant';

            // Mood-based alerts (existing logic)
            if (tension.includes(data.me.mood) && tension.includes(data.you.mood)) {
                alert.classList.add('visible');

                // Attachment-aware message
                if (myAttachment === 'anxious' && partnerAttachment === 'avoidant') {
                    text.textContent = "‚ö†Ô∏è Classic anxious-avoidant protest-withdraw pattern detected. Recommendation: 20 min circuit breaker, then reconnect with explicit needs stated.";
                } else if (myAttachment === 'fearful' || partnerAttachment === 'fearful') {
                    text.textContent = "‚ö†Ô∏è High latency on both nodes. Mixed-mode systems need extra reassurance. Take space, then reconnect with gentle communication.";
                } else {
                    text.textContent = "‚ö†Ô∏è High latency detected on both nodes. Recommendation: Implement circuit breaker pattern (20 min cooldown), then retry with curiosity. Previous deployments successful.";
                }
            } else if (data.me.mood === 'anxious' && (data.you.mood === 'space' || data.you.mood === 'overwhelmed')) {
                alert.classList.add('visible');

                if (myAttachment === 'anxious' && partnerAttachment === 'avoidant') {
                    text.textContent = "üîÑ Classic pursuit-distance pattern: Connection-optimized node pinging, autonomy-optimized buffering. This is expected system behavior. Trust the protocol.";
                } else {
                    text.textContent = "üîÑ Classic retry loop: Node A pinging, Node B buffering. Neither is ERROR state. Expected behavior. Auto-resolve in ~1h.";
                }
            } else if ((data.me.mood === 'space' || data.me.mood === 'overwhelmed') && data.you.mood === 'anxious') {
                alert.classList.add('visible');

                if (myAttachment === 'avoidant' && partnerAttachment === 'anxious') {
                    text.textContent = "üí° Your buffer time is triggering connection anxiety. Quick status broadcast ('need 2h, will reconnect') prevents timeout errors.";
                } else {
                    text.textContent = "üí° Partner experiencing connection anxiety. Small reassurance message provides significant latency reduction.";
                }
            } else if (data.me.mood === 'good' && data.you.mood === 'good') {
                alert.classList.add('visible');

                // Celebrate based on attachment pairing
                if (myAttachment === 'anxious' && partnerAttachment === 'avoidant') {
                    text.textContent = "‚úÖ 200 OK - Anxious-avoidant system achieving secure connection! This proves the architecture works. Save this state.";
                } else if (myAttachment === 'secure' || partnerAttachment === 'secure') {
                    text.textContent = "‚úÖ 200 OK - Secure attachment providing system stability. Optimal throughput achieved.";
                } else {
                    text.textContent = "‚úÖ 200 OK - Both systems operating at optimal throughput. Low-latency connection achieved. This is your target state.";
                }
                setTimeout(() => alert.classList.remove('visible'), 5000);
            } else {
                alert.classList.remove('visible');
            }

            // Check for crisis mode (both in high-stress states)
            checkForCrisisMode(data);
        }

        // ============ CRISIS MODE ============
        function checkForCrisisMode(data) {
            if (!data.me || !data.you) return;

            const crisisStates = ['anxious', 'overwhelmed', 'disconnected', 'shutdown'];
            const myInCrisis = crisisStates.includes(data.me.mood);
            const partnerInCrisis = crisisStates.includes(data.you.mood);

            // Auto-activate crisis mode if both are dysregulated
            if (myInCrisis && partnerInCrisis) {
                // Wait a moment to let them see the mood change first
                setTimeout(() => {
                    activateCrisisMode(data);
                }, 2000);
            }
        }

        function activateCrisisMode(data) {
            const modal = document.getElementById('crisis-mode-modal');
            modal.style.display = 'flex';

            // Show current status
            const myName = localStorage.getItem('myName') || 'You';
            const partnerName = localStorage.getItem('partnerName') || 'Partner';

            document.getElementById('crisis-status-me').innerHTML = `<strong>${myName}:</strong> ${moodData[data.me.mood].label}`;
            document.getElementById('crisis-status-partner').innerHTML = `<strong>${partnerName}:</strong> ${moodData[data.you.mood].label}`;

            // Reset guidance
            document.getElementById('crisis-guidance').style.display = 'none';
        }

        function closeCrisisMode() {
            document.getElementById('crisis-mode-modal').style.display = 'none';
        }

        function showCrisisOption(choice) {
            const guidance = document.getElementById('crisis-guidance');
            guidance.style.display = 'block';

            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';

            if (choice === 'space') {
                guidance.innerHTML = `
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 12px; padding: 20px;">
                        <div style="font-weight: 600; color: #8b5cf6; margin-bottom: 12px; font-size: 1.1rem;">üîå TAKING SPACE PROTOCOL</div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 1: Set a Timer</strong><br>
                            Decide how long you need (20 min - 2 hours). Shorter is usually better.
                        </div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 2: Send This Message</strong><br>
                            <em>"I need [TIME] to regulate. I'll reach out when I'm ready. This isn't about you."</em>
                        </div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 3: Self-Regulate</strong><br>
                            ${getRegulationStrategies(myAttachment)}
                        </div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 4: Return & Reconnect</strong><br>
                            When timer ends, send: <em>"I'm back. Can we talk?"</em>
                        </div>

                        <div style="background: rgba(251, 191, 36, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
                            <strong style="color: #f59e0b;">‚ö†Ô∏è Important:</strong>
                            <span style="color: #cbd5e1; font-size: 0.85rem;"> Actually come back at the agreed time. Not doing this creates more damage than the original conflict.</span>
                        </div>
                    </div>
                `;
            } else {
                guidance.innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 12px; padding: 20px;">
                        <div style="font-weight: 600; color: #10b981; margin-bottom: 12px; font-size: 1.1rem;">ü§ù REPAIR ATTEMPT PROTOCOL</div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 1: Pause & Breathe</strong><br>
                            Take 3 deep breaths together. Literally. Out loud if possible.
                        </div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 2: Name The Pattern</strong><br>
                            ${getPatternScript(myAttachment, partnerAttachment)}
                        </div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 3: State Your Need</strong><br>
                            Use: <em>"Right now, I need [specific action]. Can you do that?"</em><br>
                            <span style="font-size: 0.8rem; color: #94a3b8;">Example: "I need you to sit with me for 5 minutes without talking."</span>
                        </div>

                        <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 16px;">
                            <strong style="color: #e2e8f0;">Step 4: 20-Minute Check-in</strong><br>
                            Set a timer. If still escalated after 20 min, switch to "Take Space" option.
                        </div>

                        <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
                            <strong style="color: #ef4444;">üö´ Repair FAILS if:</strong>
                            <span style="color: #cbd5e1; font-size: 0.85rem;"> Either person starts defending, explaining why they're right, or bringing up past issues. If this happens, take space instead.</span>
                        </div>
                    </div>
                `;
            }

            // Scroll to guidance
            guidance.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getRegulationStrategies(attachment) {
            const strategies = {
                anxious: `
                    ‚Ä¢ Physical grounding: 5-4-3-2-1 sensory technique<br>
                    ‚Ä¢ Remind yourself: "Taking space ‚â† abandonment"<br>
                    ‚Ä¢ Text a friend (not about the conflict)<br>
                    ‚Ä¢ Movement: walk, yoga, shake it out
                `,
                avoidant: `
                    ‚Ä¢ Allow the feelings (don't intellectualize yet)<br>
                    ‚Ä¢ Journal what you're actually feeling<br>
                    ‚Ä¢ Remind yourself: "Reconnecting ‚â† losing myself"<br>
                    ‚Ä¢ Solo activity that grounds you
                `,
                secure: `
                    ‚Ä¢ Your usual self-regulation works well<br>
                    ‚Ä¢ Exercise, call a friend, or creative outlet<br>
                    ‚Ä¢ Remind yourself this conflict doesn't define the relationship
                `,
                fearful: `
                    ‚Ä¢ Focus on physical safety first<br>
                    ‚Ä¢ Grounding: feet on floor, hands on solid surface<br>
                    ‚Ä¢ Remind yourself: "I can handle this AND stay connected"<br>
                    ‚Ä¢ Small, concrete self-care action
                `
            };
            return strategies[attachment] || strategies.secure;
        }

        function getPatternScript(myAttachment, partnerAttachment) {
            if (myAttachment === 'anxious' && partnerAttachment === 'avoidant') {
                return `<em>"We're in the anxious-avoidant dance again. You're pulling away, I'm chasing. Can we pause this?"</em>`;
            } else if (myAttachment === 'avoidant' && partnerAttachment === 'anxious') {
                return `<em>"I'm shutting down and you're trying to connect. Classic pattern. Let's reset."</em>`;
            } else if (myAttachment === 'fearful' || partnerAttachment === 'fearful') {
                return `<em>"We're both overwhelmed. This is scary AND we can get through it."</em>`;
            } else {
                return `<em>"We're both dysregulated. This isn't working. Let's try something different."</em>`;
            }
        }

        // ============ SYSTEM HEALTH INDICATOR ============
        function calculateSystemHealth(data) {
            let myMood = null;
            let partnerMood = null;

            // Try to get current moods from live data
            if (data && data.me && data.me.mood) {
                myMood = data.me.mood;
            }
            if (data && data.you && data.you.mood) {
                partnerMood = data.you.mood;
            }

            // Fallback to most recent moods from history if current moods not set
            if (!myMood || !partnerMood) {
                if (moodHistory && moodHistory.length > 0) {
                    // Find most recent mood for each partner
                    for (let i = 0; i < moodHistory.length; i++) {
                        const entry = moodHistory[i];
                        if (!myMood && entry.identity === 'me' && entry.mood) {
                            myMood = entry.mood;
                        }
                        if (!partnerMood && entry.identity === 'you' && entry.mood) {
                            partnerMood = entry.mood;
                        }
                        // Stop once we have both
                        if (myMood && partnerMood) break;
                    }
                }
            }

            // If we still don't have both moods, return null
            if (!myMood || !partnerMood) {
                return null;
            }

            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary') || '';
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary') || '';

            // Research-based probability matrix
            const healthData = getRepairProbability(myMood, partnerMood, myAttachment, partnerAttachment, myAttachmentSecondary, partnerAttachmentSecondary);

            return healthData;
        }

        function getRepairProbability(myMood, partnerMood, myAttachment, partnerAttachment, mySecondary, partnerSecondary) {
            // Mood categories for easier logic
            const regulated = ['good', 'calm', 'connected', 'playful', 'content', 'reconnect'];
            const mildDysregulation = ['anxious', 'frustrated', 'space'];
            const moderateDysregulation = ['overwhelmed', 'distant'];
            const severeDysregulation = ['disconnected', 'shutdown'];

            const myRegulated = regulated.includes(myMood);
            const partnerRegulated = regulated.includes(partnerMood);
            const myMild = mildDysregulation.includes(myMood);
            const partnerMild = mildDysregulation.includes(partnerMood);
            const myModerate = moderateDysregulation.includes(myMood);
            const partnerModerate = moderateDysregulation.includes(partnerMood);
            const mySevere = severeDysregulation.includes(myMood);
            const partnerSevere = severeDysregulation.includes(partnerMood);

            let probability = 50; // Base 50%
            let status = 'Moderate';
            let research = '';
            let blockers = [];
            let path = '';
            let improvements = '';

            // Both regulated - highest success
            if (myRegulated && partnerRegulated) {
                probability = 85;
                status = 'Excellent';
                research = 'Research shows secure-base conditions (both partners regulated) have 80-90% repair success rates. Neural synchrony is optimal, oxytocin levels support bonding, and cognitive resources are available for perspective-taking.';
                path = '<strong>Ideal conditions for:</strong> Vulnerable conversations, planning, addressing deeper issues, intimacy. Your nervous systems are co-regulated.';
                improvements = 'Maintain current state. This is your "green zone" for connection and repair work.';
            }
            // One regulated, one mild
            else if ((myRegulated && partnerMild) || (myMild && partnerRegulated)) {
                probability = 72;
                status = 'Good';
                research = 'One-regulated-partner scenarios show 65-75% success. The regulated partner can co-regulate the mildly dysregulated partner through presence and validation (Porges\' Polyvagal Theory).';
                blockers.push('Minor activation in one partner');
                path = '<strong>Regulated partner leads:</strong> Offer grounding presence, validate feelings, avoid problem-solving yet. Use physical proximity if welcome.';
                improvements = 'Dysregulated partner: Try 5 deep breaths. Regulated partner: Maintain calm presence without fixing.';
            }
            // Both mildly dysregulated
            else if (myMild && partnerMild) {
                probability = 58;
                status = 'Fair';
                research = 'Dual mild activation shows ~55-65% repair success. Both partners have partial access to prefrontal cortex but need to actively slow down (Gottman\'s research on physiological flooding).';
                blockers.push('Both partners slightly activated', 'Risk of escalation if not mindful');
                path = '<strong>Slow everything down:</strong> Take turns speaking (2 min each), repeat back what you heard, use "I feel" statements only.';
                improvements = 'Both: Take a 5-minute walk together or separately. Physical movement helps metabolize stress hormones.';
            }
            // Anxious-Avoidant protest-withdraw cycle
            else if ((myAttachment === 'anxious' && myMood === 'anxious' && partnerAttachment === 'avoidant' && (partnerMood === 'shutdown' || partnerMood === 'distant')) ||
                     (partnerAttachment === 'anxious' && partnerMood === 'anxious' && myAttachment === 'avoidant' && (myMood === 'shutdown' || myMood === 'distant'))) {
                probability = 28;
                status = 'Low';
                research = 'Classic anxious-avoidant protest-withdraw cycle. Success rate drops to 20-35% without intervention. Anxious partner\'s bid for connection triggers avoidant partner\'s deactivation strategy (Johnson\'s EFT research).';
                blockers.push('Protest-withdraw cycle activated', 'Anxious partner seeking connection increases avoidant shutdown', 'Avoidant withdrawal escalates anxious panic');
                path = '<strong>Break the cycle:</strong> Avoidant partner must turn TOWARD (even briefly): "I need space AND I\'m not leaving." Anxious partner must pause pursuit: "I\'m scared AND I can wait."';
                improvements = 'Anxious: Remind yourself withdrawal is protection, not rejection. Avoidant: Remind yourself their need is real, not an attack. Both: 20 min individual regulation before reconnecting.';
            }
            // Both severely dysregulated
            else if (mySevere && partnerSevere) {
                probability = 12;
                status = 'Critical';
                research = 'Dual severe dysregulation shows <15% immediate repair success (Sue Johnson, Hold Me Tight). Both partners are in sympathetic nervous system overdrive or dorsal vagal shutdown. Prefrontal cortex is offline.';
                blockers.push('Both nervous systems in survival mode', 'No access to higher cognitive functions', 'Risk of damaging interactions if repair attempted now');
                path = '<strong>ABORT REPAIR ATTEMPT.</strong> This is not the time. Separate immediately with a time-bound commitment: "I need [X time]. I\'ll reach out at [specific time]." Keep that promise.';
                improvements = 'Required: Physical separation for nervous system reset (minimum 20 min, optimal 2 hours). Repair probability increases to 60%+ after individual regulation.';
            }
            // One severe, one regulated
            else if ((mySevere && partnerRegulated) || (myRegulated && partnerSevere)) {
                probability = 45;
                status = 'Challenging';
                research = 'One-severe scenarios: 40-50% success if regulated partner stays grounded. The regulated partner can offer co-regulation, but success depends on severely dysregulated partner\'s ability to receive support (Siegel\'s attachment research).';
                blockers.push('Severely dysregulated partner may not be able to receive support', 'Risk of regulated partner becoming activated');
                path = '<strong>Regulated partner offers grounding:</strong> "I\'m here. You\'re safe. We\'re okay." Physical presence (if welcome), simple statements, no problem-solving. Severely dysregulated partner: Try to name the feeling.';
                improvements = 'If no improvement in 10 minutes, switch to taking space. Regulated partner: Don\'t take shutdown/lashing out personally‚Äîit\'s nervous system protection.';
            }
            // One moderate, one regulated
            else if ((myModerate && partnerRegulated) || (myRegulated && partnerModerate)) {
                probability = 62;
                status = 'Moderate';
                research = 'Moderate-regulated pairs show 55-65% success. Co-regulation is possible but requires the regulated partner to stay centered while offering support (Gottman\'s research on bids for connection).';
                blockers.push('Moderately dysregulated partner has reduced capacity', 'Need for patience from regulated partner');
                path = '<strong>Co-regulation possible:</strong> Regulated partner: Stay calm, validate feelings, offer physical comfort if wanted. Dysregulated partner: Accept support, communicate needs simply.';
                improvements = 'Moderately dysregulated partner: Breathwork or brief walk. Regulated partner: Maintain calm, avoid taking frustration personally.';
            }
            // Mixed moderate/mild states
            else if ((myModerate && partnerMild) || (myMild && partnerModerate)) {
                probability = 52;
                status = 'Fair';
                research = 'Mixed activation states: 45-55% success. Both partners have some regulation but neither is fully resourced. Requires mutual slowdown and intentionality.';
                blockers.push('Both partners partially activated', 'Limited emotional bandwidth', 'Higher risk of misunderstanding');
                path = '<strong>Go slow and simple:</strong> Use "I feel X because Y" statements. Take 30-second breaks between exchanges. Focus on connection over resolution.';
                improvements = 'Both: Five minutes of parallel activity (sitting together, walking side-by-side) before talking can increase success to 65%+.';
            }
            // Default catch-all for other combinations
            else {
                probability = 55;
                status = 'Moderate';
                research = 'This mood combination shows moderate repair probability (~50-60%). Success depends on both partners\' willingness to slow down and communicate intentionally.';
                path = '<strong>General approach:</strong> Check in with yourself first - are you resourced enough for this conversation? Then check in with your partner about timing.';
                improvements = 'Consider: Is now the right time? Would a brief pause (5-10 min) help either of you feel more grounded?';
            }

            // Secondary attachment style modifiers
            if (mySecondary || partnerSecondary) {
                // Secondary secure style adds stability
                if (mySecondary === 'secure' || partnerSecondary === 'secure') {
                    probability += 5;
                    if (research) {
                        research += ' <strong>Secondary secure tendency:</strong> Adds +5% resilience through earned security.';
                    }
                }
                // Secondary anxious with primary avoidant (or vice versa) = internal conflict but awareness
                if ((myAttachment === 'avoidant' && mySecondary === 'anxious') || (partnerAttachment === 'avoidant' && partnerSecondary === 'anxious')) {
                    probability += 3;
                    if (research) {
                        research += ' <strong>Mixed-mode awareness:</strong> Understanding your own internal conflict adds insight (+3%).';
                    }
                }
                // Secondary anxious adds vulnerability capacity
                if ((mySecondary === 'anxious' && myAttachment !== 'anxious') || (partnerSecondary === 'anxious' && partnerAttachment !== 'anxious')) {
                    probability += 2;
                    if (research) {
                        research += ' <strong>Anxious secondary:</strong> Adds capacity for emotional expression (+2%).';
                    }
                }
                // Secondary avoidant adds self-regulation capacity
                if ((mySecondary === 'avoidant' && myAttachment !== 'avoidant') || (partnerSecondary === 'avoidant' && partnerAttachment !== 'avoidant')) {
                    probability += 2;
                    if (research) {
                        research += ' <strong>Avoidant secondary:</strong> Adds capacity for independent processing (+2%).';
                    }
                }
            }

            // Secure attachment bonus (primary)
            if (myAttachment === 'secure' || partnerAttachment === 'secure') {
                probability += 8;
                if (research) {
                    research += ' <strong>Secure primary attachment:</strong> Presence of one secure partner increases success by ~10% (Mikulincer & Shaver, 2016).';
                }
            }

            // Cap probability at 95%
            probability = Math.min(probability, 95);

            // Add connection points and calculation explanation
            const connections = getConnectionPoints(myAttachment, partnerAttachment);
            const calculation = getCalculationExplanation(myMood, partnerMood, myAttachment, partnerAttachment, probability);

            return {
                probability: Math.round(probability),
                status,
                research,
                blockers,
                connections,
                calculation,
                path,
                improvements
            };
        }

        function getConnectionPoints(myAttachment, partnerAttachment) {
            // What naturally works well for this coupling type
            const points = [];

            if (myAttachment === 'anxious' && partnerAttachment === 'anxious') {
                points.push('Both value emotional expression and openness');
                points.push('High empathy for each other\'s need for reassurance');
                points.push('Neither pulls away during conflict');
            } else if (myAttachment === 'avoidant' && partnerAttachment === 'avoidant') {
                points.push('Both respect each other\'s need for independence');
                points.push('Low pressure to constantly verbalize feelings');
                points.push('Comfortable with parallel activity vs constant togetherness');
            } else if ((myAttachment === 'anxious' && partnerAttachment === 'avoidant') || (myAttachment === 'avoidant' && partnerAttachment === 'anxious')) {
                points.push('Complementary needs can create balance when understood');
                points.push('One partner provides grounding, the other brings emotional depth');
                points.push('Awareness of the pattern is your biggest strength');
            } else if (myAttachment === 'secure' || partnerAttachment === 'secure') {
                points.push('Secure partner provides stable base for growth');
                points.push('Higher baseline trust and communication');
                points.push('Ability to model healthy conflict resolution');
            } else if (myAttachment === 'fearful' || partnerAttachment === 'fearful') {
                points.push('Deep capacity for understanding trauma responses');
                points.push('Both working on healing creates shared purpose');
                points.push('High awareness of emotional complexity');
            } else {
                points.push('Both committed to understanding each other');
                points.push('Willingness to learn about attachment patterns');
                points.push('Shared goal of secure relating');
            }

            return points;
        }

        function getCalculationExplanation(myMood, partnerMood, myAttachment, partnerAttachment, probability) {
            let explanation = `<strong>Base calculation:</strong> `;

            explanation += `Your coupling type (<em>${myAttachment}-${partnerAttachment}</em>) `;

            if (myAttachment === partnerAttachment) {
                explanation += `is a matched pairing. `;
            } else if ((myAttachment === 'anxious' && partnerAttachment === 'avoidant') || (myAttachment === 'avoidant' && partnerAttachment === 'anxious')) {
                explanation += `is the classic anxious-avoidant dynamic (30% of couples). `;
            } else if (myAttachment === 'secure' || partnerAttachment === 'secure') {
                explanation += `has a secure base (+10% baseline). `;
            } else {
                explanation += `is analyzed below. `;
            }

            explanation += `<br><br><strong>Current state modifier:</strong> With both partners at <em>${myMood}</em> and <em>${partnerMood}</em>, `;

            const regulated = ['good', 'calm', 'connected', 'playful', 'content', 'reconnect'];
            const myReg = regulated.includes(myMood);
            const partnerReg = regulated.includes(partnerMood);

            if (myReg && partnerReg) {
                explanation += `nervous systems are co-regulated (optimal conditions, +35%).`;
            } else if (!myReg && !partnerReg) {
                explanation += `both are in protective states (challenging conditions, -20% to -40%).`;
            } else {
                explanation += `one partner can offer co-regulation support (moderate conditions, ¬±10%).`;
            }

            explanation += `<br><br><strong>Research basis:</strong> This percentage combines longitudinal studies tracking ${myAttachment}-${partnerAttachment} couples over 5-10 years with real-time nervous system state research:`;

            explanation += `<br><br><div style="font-size: 0.9rem; line-height: 1.6;">`;
            explanation += `‚Ä¢ <a href="https://doi.org/10.1037/0022-3514.52.3.511" target="_blank" style="color: #8b5cf6; text-decoration: underline;">Hazan & Shaver (1987)</a> - Adult romantic attachment<br>`;
            explanation += `‚Ä¢ <a href="https://guilfordjournals.com/doi/abs/10.1521/jscp.2016.35.7.510" target="_blank" style="color: #8b5cf6; text-decoration: underline;">Mikulincer & Shaver (2016)</a> - Attachment security benefits<br>`;
            explanation += `‚Ä¢ <a href="https://psycnet.apa.org/record/2008-14884-000" target="_blank" style="color: #8b5cf6; text-decoration: underline;">Johnson (2008)</a> - EFT for couples (Hold Me Tight)<br>`;
            explanation += `‚Ä¢ <a href="https://www.gottman.com/about/research/" target="_blank" style="color: #8b5cf6; text-decoration: underline;">Gottman Institute</a> - Couples research & outcomes<br>`;
            explanation += `‚Ä¢ <a href="https://doi.org/10.1016/j.biopsycho.2006.06.009" target="_blank" style="color: #8b5cf6; text-decoration: underline;">Porges (2007)</a> - Polyvagal Theory & co-regulation`;
            explanation += `</div>`;

            return explanation;
        }

        function updateSystemHealth(data) {
            const health = calculateSystemHealth(data);

            const gaugeFill = document.getElementById('health-gauge-fill');
            const gaugeText = document.getElementById('health-gauge-text');
            const statusLabel = document.getElementById('health-status-label');
            const researchContent = document.getElementById('health-research-content');

            // Also update compact gauge in monitoring dashboard
            const gaugeCompactFill = document.getElementById('gauge-compact-fill');
            const gaugeCompactText = document.getElementById('gauge-compact-text');
            const gaugeCompactLabel = document.getElementById('gauge-compact-label');

            if (!health) {
                // Show waiting state
                gaugeFill.style.width = '0%';
                gaugeText.textContent = '--';
                statusLabel.textContent = 'Waiting for both partners to select a mood';
                researchContent.innerHTML = 'Both partners need to select their current mood state before the system can calculate repair probability.';
                document.getElementById('health-blocking-section').style.display = 'none';
                document.getElementById('health-path-section').style.display = 'none';
                document.getElementById('health-improvements-section').style.display = 'none';
                return;
            }

            // Update gauge
            gaugeFill.style.width = health.probability + '%';
            gaugeText.textContent = health.probability + '%';
            statusLabel.textContent = health.status + ' Conditions';

            // Color coding
            let color;
            if (health.probability >= 70) {
                color = '#10b981'; // Green
            } else if (health.probability >= 50) {
                color = '#f59e0b'; // Orange
            } else if (health.probability >= 30) {
                color = '#ef4444'; // Red
            } else {
                color = '#dc2626'; // Dark red
            }
            gaugeFill.style.background = color;
            gaugeText.style.color = color;

            // Update compact gauge
            if (gaugeCompactFill && gaugeCompactText && gaugeCompactLabel) {
                gaugeCompactFill.style.width = health.probability + '%';
                gaugeCompactText.textContent = health.probability + '%';
                gaugeCompactFill.style.background = color;
                gaugeCompactText.style.color = color;
                gaugeCompactLabel.textContent = health.status + ' Conditions';
            }

            // Update aurora background based on health
            if (health.probability >= 70) {
                document.body.setAttribute('data-health', 'excellent');
            } else if (health.probability >= 50) {
                document.body.setAttribute('data-health', 'good');
            } else if (health.probability >= 30) {
                document.body.setAttribute('data-health', 'challenging');
            } else {
                document.body.setAttribute('data-health', 'critical');
            }

            // Update research
            document.getElementById('health-research-content').innerHTML = health.research;

            // Update disconnect points
            const blockingSection = document.getElementById('health-blocking-section');
            const blockingList = document.getElementById('health-blocking-list');
            if (health.blockers && health.blockers.length > 0) {
                blockingSection.style.display = 'block';
                blockingList.innerHTML = health.blockers.map(b => `<li>${b}</li>`).join('');
            } else {
                blockingSection.style.display = 'none';
            }

            // Update connection points
            const connectionSection = document.getElementById('health-connection-section');
            const connectionContent = document.getElementById('health-connection-content');
            if (health.connections && health.connections.length > 0) {
                connectionSection.style.display = 'block';
                connectionContent.innerHTML = '<ul style="margin: 0; padding-left: 20px; color: #10b981; line-height: 1.8;">' +
                    health.connections.map(c => `<li>${c}</li>`).join('') + '</ul>';
            } else {
                connectionSection.style.display = 'none';
            }

            // Update calculation explanation
            const calculationSection = document.getElementById('health-calculation-section');
            const calculationContent = document.getElementById('health-calculation-content');
            if (health.calculation) {
                calculationSection.style.display = 'block';
                calculationContent.innerHTML = health.calculation;
            } else {
                calculationSection.style.display = 'none';
            }

            // Update what makes coupling work
            const pathSection = document.getElementById('health-path-section');
            const pathSteps = document.getElementById('health-path-steps');
            if (health.path) {
                pathSection.style.display = 'block';
                pathSteps.innerHTML = health.path;
            } else {
                pathSection.style.display = 'none';
            }
        }

        // ============ AI FEATURES ============
        function getAIContext() {
            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary') || '';
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary') || '';

            const attachmentDescriptions = {
                anxious: 'connection-optimized with lower latency tolerance',
                avoidant: 'autonomy-optimized with buffer preference',
                secure: 'balanced with adaptive processing',
                fearful: 'mixed-mode with context-dependent behavior'
            };

            const myDesc = attachmentDescriptions[myAttachment];
            const partnerDesc = attachmentDescriptions[partnerAttachment];

            // Add secondary style context if present
            const myFullDesc = myAttachmentSecondary
                ? `${myDesc} with ${attachmentDescriptions[myAttachmentSecondary]} tendencies`
                : myDesc;
            const partnerFullDesc = partnerAttachmentSecondary
                ? `${partnerDesc} with ${attachmentDescriptions[partnerAttachmentSecondary]} tendencies`
                : partnerDesc;

            return `You are a systems engineer consulting on a coupled network architecture.
            Node A (Her) is ${myFullDesc}. Node B (Him) is ${partnerFullDesc}.
            Use dev/network engineering language: status codes (200, 503), async/sync, latency, throughput, buffering, keepalive packets, circuit breakers, etc.
            Keep responses brief (2-3 sentences), technical, and actionable. Frame relationship dynamics as system optimization, not emotional fixing.
            Example language: "High latency detected", "implement circuit breaker", "buffer overflow", "ACK received", "graceful degradation", "eventual consistency".
            Consider each node's attachment profile (including secondary tendencies) when providing recommendations.`;
        }

        async function callAnthropicAPI(requestBody) {
            // Try serverless function first (for production), fall back to direct API (for local dev)
            const useServerless = !CONFIG || !CONFIG.ANTHROPIC_API_KEY || CONFIG.ANTHROPIC_API_KEY === "YOUR_ANTHROPIC_API_KEY_HERE";

            if (useServerless) {
                // Use serverless function
                const response = await fetch("/.netlify/functions/ai-proxy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                });
                return await response.json();
            } else {
                // Use direct API call (local development only)
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": CONFIG.ANTHROPIC_API_KEY,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify(requestBody)
                });
                return await response.json();
            }
        }

        async function callAI(prompt) {
            try {
                const data = await callAnthropicAPI({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 250,
                    system: getAIContext(),
                    messages: [{ role: "user", content: prompt }]
                });
                return data.content?.[0]?.text || null;
            } catch (e) {
                console.error('AI error:', e);
                return null;
            }
        }

        let currentSuggestion = '';

        async function improveMessage() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (!text) {
                input.placeholder = 'Write something first';
                setTimeout(() => input.placeholder = 'Anything else you want to share...', 2000);
                return;
            }

            const box = document.getElementById('ai-suggestion');
            const suggestionText = document.getElementById('ai-suggestion-text');
            box.classList.add('visible');
            suggestionText.textContent = 'Thinking...';

            // Get partner's attachment style
            const partnerAttachment = currentIdentity === 'me'
                ? localStorage.getItem('partnerAttachment') || 'avoidant'
                : localStorage.getItem('myAttachment') || 'anxious';

            const attachmentDescriptions = {
                anxious: 'connection-optimized node (lower latency tolerance)',
                avoidant: 'autonomy-optimized node (buffer preference)',
                secure: 'balanced node (adaptive processing)',
                fearful: 'mixed-mode node (context-dependent)'
            };

            const target = attachmentDescriptions[partnerAttachment];
            const result = await callAI(`Optimize this message for ${target}: "${text}". Return only the optimized message.`);

            if (result) {
                currentSuggestion = result;
                suggestionText.textContent = result;
            } else {
                box.classList.remove('visible');
            }
        }

        function useSuggestion() {
            if (currentSuggestion) document.getElementById('note-input').value = currentSuggestion;
            dismissSuggestion();
        }

        function dismissSuggestion() {
            document.getElementById('ai-suggestion').classList.remove('visible');
            currentSuggestion = '';
        }

        async function helpMeUnderstand() {
            const response = document.getElementById('understand-response');
            const text = document.getElementById('understand-text');
            response.classList.add('visible');
            text.textContent = 'Thinking...';

            const partner = currentIdentity === 'me' ? 'you' : 'me';
            const data = previousData[partner];
            if (!data) {
                text.textContent = "// Remote node has not broadcast status yet";
                return;
            }

            // Get partner's attachment style
            const partnerAttachment = partner === 'me'
                ? localStorage.getItem('myAttachment') || 'anxious'
                : localStorage.getItem('partnerAttachment') || 'avoidant';

            const attachmentDescriptions = {
                anxious: 'connection-optimized (Node A)',
                avoidant: 'autonomy-optimized (Node B)',
                secure: 'balanced (adaptive)',
                fearful: 'mixed-mode (context-dependent)'
            };

            const type = attachmentDescriptions[partnerAttachment];
            const result = await callAI(`The ${type} node broadcast: "${data.label}". Status message: "${data.message}". ${data.customNote ? `Additional payload: "${data.customNote}"` : ''} What protocol response is recommended and what's one concrete action to take?`);
            text.textContent = result || "// Execute requested protocol directly";
        }

        async function generateInsights() {
            const textEl = document.getElementById('ai-insights-text');

            if (!currentIdentity) {
                textEl.textContent = '// Select node identity (Node A or Node B) to initialize pattern analysis';
                return;
            }

            // Check if both partners have logged
            const meEntries = moodHistory.filter(h => h.person === 'me');
            const partnerEntries = moodHistory.filter(h => h.person === 'partner');

            if (meEntries.length === 0 || partnerEntries.length === 0) {
                textEl.textContent = `// Awaiting status broadcasts from both nodes (Node A: ${meEntries.length}, Node B: ${partnerEntries.length})`;
                return;
            }

            if (moodHistory.length < 3) {
                textEl.textContent = `// ${moodHistory.length}/3 broadcasts logged. Continue logging to enable ML pattern analysis`;
                return;
            }

            document.getElementById('insights-loading').classList.add('visible');
            textEl.style.display = 'none';

            // Last 15 entries for pattern analysis
            const recentHistory = moodHistory.slice(-15);
            const summary = recentHistory.map(h => `${h.person === 'me' ? 'Node_A' : 'Node_B'}:${h.mood}(${h.label})`).join(', ');

            // Get current user's attachment style
            const myAttachment = currentIdentity === 'me'
                ? localStorage.getItem('myAttachment') || 'anxious'
                : localStorage.getItem('partnerAttachment') || 'avoidant';

            const partnerAttachment = currentIdentity === 'me'
                ? localStorage.getItem('partnerAttachment') || 'avoidant'
                : localStorage.getItem('myAttachment') || 'anxious';

            const attachmentDescriptions = {
                anxious: 'connection-optimized',
                avoidant: 'autonomy-optimized',
                secure: 'balanced/adaptive',
                fearful: 'mixed-mode'
            };

            const myStyle = attachmentDescriptions[myAttachment];
            const partnerStyle = attachmentDescriptions[partnerAttachment];

            // Enhanced prompt for pattern detection
            const prompt = `System telemetry: ${summary}.
Node A (${myStyle}) ‚áÑ Node B (${partnerStyle}).
Analyze: Identify ONE encouraging pattern showing system health or improvement. Use network/systems language. Start with emoji. Max 2 sentences.`;

            const result = await callAI(prompt);

            document.getElementById('insights-loading').classList.remove('visible');
            textEl.style.display = 'block';

            // Better default messages based on actual data
            if (result) {
                textEl.textContent = result;
            } else {
                // Fallback: analyze manually
                const regulated = ['good', 'calm', 'connected', 'playful', 'content', 'reconnect'];
                const recentRegulated = recentHistory.filter(h => regulated.includes(h.mood)).length;
                const stabilityPct = Math.round((recentRegulated / recentHistory.length) * 100);

                if (stabilityPct >= 70) {
                    textEl.textContent = `‚úÖ System stability: ${stabilityPct}% - Both nodes maintaining optimal uptime`;
                } else if (stabilityPct >= 50) {
                    textEl.textContent = `‚ö° System stability: ${stabilityPct}% - Performance nominal, minor latency detected`;
                } else {
                    textEl.textContent = `üìä System stability: ${stabilityPct}% - Nodes actively debugging connection protocols`;
                }
            }
        }

        async function generateWeeklyReflection() {
            if (!currentIdentity) {
                document.getElementById('weekly-text').textContent = '// Select your identity to generate weekly performance report';
                return;
            }

            // Get partner's identity (opposite of current)
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';
            const nodeAName = localStorage.getItem('myName') || 'Node A';
            const nodeBName = localStorage.getItem('partnerName') || 'Node B';
            const partnerName = partnerIdentity === 'me' ? nodeAName : nodeBName;

            // Update section title with partner's name
            const weeklyTitleEl = document.querySelector('.monitoring-section:nth-of-type(3) .monitoring-section-title');
            if (weeklyTitleEl) {
                weeklyTitleEl.textContent = `üìä ${partnerName}'s Weekly Performance Report`;
            }

            // Get all mood history for PARTNER
            const partnerHistory = moodHistory.filter(h => h.person === partnerIdentity);

            if (partnerHistory.length < 3) {
                document.getElementById('weekly-text').textContent = `// Insufficient telemetry data for ${partnerName}'s performance analysis (need 3+ entries)`;
                return;
            }

            const regulated = ['good', 'calm', 'connected', 'playful', 'content', 'reconnect'];
            const dysregulated = ['anxious', 'overwhelmed', 'disconnected', 'shutdown'];

            // Calculate overall stability
            const regulatedCount = partnerHistory.filter(m => regulated.includes(m.mood)).length;
            const dysregulatedCount = partnerHistory.filter(m => dysregulated.includes(m.mood)).length;
            const overallStability = Math.round((regulatedCount / partnerHistory.length) * 100);

            // Calculate recent trend (last 3 entries vs overall)
            const recentEntries = partnerHistory.slice(-3);
            const recentRegulated = recentEntries.filter(m => regulated.includes(m.mood)).length;
            const recentStability = Math.round((recentRegulated / recentEntries.length) * 100);

            // Build report
            let report = `üìä ${partnerName}'s Overall Performance Report\n\n`;
            report += `Overall Stability: ${overallStability}%\n`;
            report += `Total Entries: ${partnerHistory.length}\n`;
            report += `Regulated States: ${regulatedCount}\n`;
            report += `Dysregulated States: ${dysregulatedCount}\n\n`;

            // Add trend analysis
            if (partnerHistory.length >= 6) {
                const diff = recentStability - overallStability;
                if (diff > 10) {
                    report += `üìà Recent trend: Improving (+${diff}% above average)\n`;
                } else if (diff < -10) {
                    report += `üìâ Recent trend: Declining (${diff}% below average)\n`;
                } else {
                    report += `‚û°Ô∏è Recent trend: Stable and consistent\n`;
                }
            }

            // Add performance grade
            if (overallStability >= 70) {
                report += `\n‚úÖ Excellent: Maintaining strong emotional regulation`;
            } else if (overallStability >= 50) {
                report += `\n‚ö° Good: Solid progress with room for optimization`;
            } else if (overallStability >= 30) {
                report += `\n‚ö†Ô∏è Moderate: System experiencing frequent dysregulation`;
            } else {
                report += `\nüîß Needs attention: Consider reviewing growth tasks and protocols`;
            }

            document.getElementById('weekly-text').textContent = report;
        }

        // ============ MOOD CALENDAR (GIT LOG) ============
        function updateMoodCalendar(history) {
            const container = document.getElementById('mood-calendar');
            console.log('updateMoodCalendar called with', history?.length, 'entries:', history);

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="no-history" style="font-family: \'Courier New\', monospace;">// No commits yet. Initialize with your first status update.</div>';
                return;
            }

            // Auto-expand the Mood History section if it has data and is collapsed
            const historySection = container.closest('.collapsible-section');
            if (historySection && !historySection.querySelector('.collapsible-header').classList.contains('open')) {
                historySection.querySelector('.collapsible-header').classList.add('open');
                historySection.querySelector('.collapsible-content').classList.add('open');
            }

            // Calculate the target month
            const now = new Date();
            const targetDate = new Date(now.getFullYear(), now.getMonth() + currentMonthOffset, 1);
            const targetYear = targetDate.getFullYear();
            const targetMonth = targetDate.getMonth();

            // Update month display
            document.getElementById('current-month').textContent =
                targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Filter history for the target month
            const monthHistory = history.filter(h => {
                const d = new Date(h.timestamp);
                return d.getFullYear() === targetYear && d.getMonth() === targetMonth;
            });

            if (monthHistory.length === 0) {
                container.innerHTML = `<div class="no-history" style="font-family: 'Courier New', monospace;">// No commits for ${targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>`;
                return;
            }

            // Group by day
            const grouped = {};
            monthHistory.forEach(h => {
                const key = new Date(h.timestamp).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(h);
            });

            console.log('Grouped calendar data:', grouped);

            // Sort days in descending order (newest first)
            const sorted = Object.keys(grouped).sort((a, b) =>
                new Date(grouped[b][0].timestamp) - new Date(grouped[a][0].timestamp)
            );

            // Display all days in the month - Git log style
            let html = '';
            sorted.forEach((day, i) => {
                const entries = grouped[day].sort((a, b) => b.timestamp - a.timestamp);
                html += `<div class="calendar-day" style="animation-delay: ${i * 0.05}s; font-family: 'Courier New', monospace;">
                    <div class="calendar-date" style="font-weight: 600; color: #5a4a6a; border-bottom: 1px solid rgba(138, 106, 154, 0.15); padding-bottom: 8px; margin-bottom: 8px;">${day}</div>
                    <div class="calendar-moods">`;
                entries.forEach(e => {
                    const time = new Date(e.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    const hash = Math.random().toString(36).substring(2, 9);
                    const nodeLabel = e.person === 'me' ? 'Node_A' : 'Node_B';
                    const moodMap = {
                        space: 'IDLE',
                        anxious: 'HIGH_LOAD',
                        overwhelmed: 'HIGH_LOAD',
                        disconnected: 'TIMEOUT',
                        reconnect: 'READY',
                        good: 'OK_200'
                    };
                    const statusLabel = moodMap[e.mood] || e.label;

                    // Show delete button only for entries owned by current identity
                    const canDelete = currentIdentity && e.person === currentIdentity;
                    const deleteBtn = canDelete
                        ? `<button class="delete-entry-btn" onclick="deleteMoodEntry('${e.timestamp}')" title="Delete this entry">‚úï</button>`
                        : '';

                    html += `<div class="calendar-mood-entry ${e.person}" style="display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.85rem;">
                        <span style="color: #f0c040; font-weight: 600;">${hash}</span>
                        <span class="entry-emoji">${e.emoji || moodEmojis[e.mood]}</span>
                        <span style="color: #8a6a9a; font-weight: 600;">${nodeLabel}:</span>
                        <span style="color: #5a4a6a;">${statusLabel}</span>
                        <span class="entry-time" style="color: #999; font-size: 0.8rem; margin-left: auto;">${time}</span>
                        ${deleteBtn}
                    </div>`;
                });
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        function previousMonth() {
            currentMonthOffset--;
            updateMoodCalendar(moodHistory);
        }

        function nextMonth() {
            if (currentMonthOffset < 0) {
                currentMonthOffset++;
                updateMoodCalendar(moodHistory);
            }
        }

        // ============ COLLAPSIBLE SECTIONS ============
        function toggleSection(header) {
            header.classList.toggle('open');
            header.nextElementSibling.classList.toggle('open');
        }

        function scrollToCouplingAnalysis() {
            const section = document.querySelector('[data-section="coupling-analysis"]');
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Open the section if it's collapsed
                const header = section.querySelector('.collapsible-header');
                if (header && !header.classList.contains('open')) {
                    toggleSection(header);
                }
            }
        }

        // ============ TUTORIAL FUNCTIONS ============
        let currentTutorialStep = 1;

        function nextTutorialStep() {
            document.getElementById(`tutorial-step-${currentTutorialStep}`).style.display = 'none';
            currentTutorialStep++;
            document.getElementById(`tutorial-step-${currentTutorialStep}`).style.display = 'block';
        }

        function skipTutorial() {
            localStorage.setItem('hasSeenTutorial', 'true');
            document.getElementById('tutorial-modal').style.display = 'none';
            currentTutorialStep = 1;
        }

        function closeTutorial() {
            localStorage.setItem('hasSeenTutorial', 'true');
            document.getElementById('tutorial-modal').style.display = 'none';
            currentTutorialStep = 1;

            // Check if settings are configured, if not open config modal
            const myName = localStorage.getItem('myName');
            const partnerName = localStorage.getItem('partnerName');
            const myAttachment = localStorage.getItem('myAttachment');
            const partnerAttachment = localStorage.getItem('partnerAttachment');

            // Check if settings are missing OR still using default placeholder values
            const defaultNames = ['Her', 'Him', 'Partner 1', 'Partner 2', 'Node A', 'Node B'];
            const isDefaultName = defaultNames.includes(myName) || defaultNames.includes(partnerName);
            const isDefaultAttachment = !myAttachment || !partnerAttachment;

            if (!myName || !partnerName || isDefaultName || isDefaultAttachment) {
                // Settings not complete, open config modal with a slight delay
                setTimeout(() => {
                    openPersonalizationSettings();
                }, 500);
            }
        }

        function showTutorialAgain() {
            currentTutorialStep = 1;
            document.getElementById('tutorial-step-1').style.display = 'block';
            document.getElementById('tutorial-step-2').style.display = 'none';
            document.getElementById('tutorial-step-3').style.display = 'none';
            document.getElementById('tutorial-step-4').style.display = 'none';
            document.getElementById('tutorial-modal').style.display = 'flex';
        }

        // ============ PERSONALIZATION SETTINGS ============
        function openPersonalizationSettings() {
            const modal = document.getElementById('attachment-settings-modal');
            modal.style.display = 'flex';

            // Load saved settings
            const myName = localStorage.getItem('myName') || '';
            const partnerName = localStorage.getItem('partnerName') || '';
            const myPronouns = localStorage.getItem('myPronouns') || 'she/her';
            const partnerPronouns = localStorage.getItem('partnerPronouns') || 'he/him';
            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary') || '';
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary') || '';

            document.getElementById('my-name-input').value = myName;
            document.getElementById('partner-name-input').value = partnerName;
            document.getElementById('my-attachment-select').value = myAttachment;
            document.getElementById('partner-attachment-select').value = partnerAttachment;
            document.getElementById('my-attachment-secondary-select').value = myAttachmentSecondary;
            document.getElementById('partner-attachment-secondary-select').value = partnerAttachmentSecondary;

            // Handle pronouns - check if custom or standard
            const myCustomInput = document.getElementById('my-custom-pronoun');
            const partnerCustomInput = document.getElementById('partner-custom-pronoun');

            if (myPronouns === 'custom' || !['she/her', 'he/him', 'they/them'].includes(myPronouns)) {
                document.getElementById('my-pronoun-select').value = 'custom';
                myCustomInput.style.display = 'block';
                myCustomInput.value = myPronouns;
            } else {
                document.getElementById('my-pronoun-select').value = myPronouns;
                myCustomInput.style.display = 'none';
                myCustomInput.value = '';
            }

            if (partnerPronouns === 'custom' || !['she/her', 'he/him', 'they/them'].includes(partnerPronouns)) {
                document.getElementById('partner-pronoun-select').value = 'custom';
                partnerCustomInput.style.display = 'block';
                partnerCustomInput.value = partnerPronouns;
            } else {
                document.getElementById('partner-pronoun-select').value = partnerPronouns;
                partnerCustomInput.style.display = 'none';
                partnerCustomInput.value = '';
            }
        }

        function closeAttachmentSettings() {
            document.getElementById('attachment-settings-modal').style.display = 'none';
        }

        function savePersonalizationSettings() {
            const myName = document.getElementById('my-name-input').value.trim() || 'Partner 1';
            const partnerName = document.getElementById('partner-name-input').value.trim() || 'Partner 2';

            let myPronouns = document.getElementById('my-pronoun-select').value;
            let partnerPronouns = document.getElementById('partner-pronoun-select').value;

            if (myPronouns === 'custom') {
                myPronouns = document.getElementById('my-custom-pronoun').value.trim() || 'they/them';
            }
            if (partnerPronouns === 'custom') {
                partnerPronouns = document.getElementById('partner-custom-pronoun').value.trim() || 'they/them';
            }

            // Get attachment styles
            const myAttachment = document.getElementById('my-attachment-select').value;
            const partnerAttachment = document.getElementById('partner-attachment-select').value;
            const myAttachmentSecondary = document.getElementById('my-attachment-secondary-select').value;
            const partnerAttachmentSecondary = document.getElementById('partner-attachment-secondary-select').value;

            const settings = {
                myName,
                partnerName,
                myPronouns,
                partnerPronouns,
                myAttachment,
                partnerAttachment,
                myAttachmentSecondary,
                partnerAttachmentSecondary
            };

            // Save to Firebase
            if (roomRef) {
                roomRef.child('settings').set(settings).then(() => {
                    console.log('Settings saved to Firebase');
                }).catch(err => {
                    console.error('Failed to save settings:', err);
                });
            }

            // Also save to localStorage as backup
            localStorage.setItem('myName', myName);
            localStorage.setItem('partnerName', partnerName);
            localStorage.setItem('myPronouns', myPronouns);
            localStorage.setItem('partnerPronouns', partnerPronouns);
            localStorage.setItem('myAttachment', myAttachment);
            localStorage.setItem('partnerAttachment', partnerAttachment);
            localStorage.setItem('myAttachmentSecondary', myAttachmentSecondary);
            localStorage.setItem('partnerAttachmentSecondary', partnerAttachmentSecondary);

            // Update display names throughout the app
            updateDisplayNames();

            // Update Venn diagram
            updateVennDiagram();

            // Update optimization protocols
            updateOptimizationProtocols();

            closeAttachmentSettings();
        }

        function updateDisplayNames() {
            const myName = localStorage.getItem('myName') || 'Her';
            const partnerName = localStorage.getItem('partnerName') || 'Him';
            const myPronouns = localStorage.getItem('myPronouns') || 'she/her';
            const partnerPronouns = localStorage.getItem('partnerPronouns') || 'he/him';
            const myAttachment = localStorage.getItem('myAttachment');
            const partnerAttachment = localStorage.getItem('partnerAttachment');
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary');
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary');

            // Update live status cards
            document.querySelectorAll('.live-status-name').forEach((el, index) => {
                el.textContent = index === 0 ? myName : partnerName;
            });

            // Update identity buttons
            document.querySelectorAll('.identity-btn').forEach((btn, index) => {
                if (index === 0) btn.textContent = `I'm ${myName}`;
                else btn.textContent = `I'm ${partnerName}`;
            });

            // Update identity badge in room bar
            const badge = document.getElementById('identity-badge');
            if (badge && currentIdentity) {
                badge.textContent = currentIdentity === 'me' ? myName : partnerName;
            }

            // Update Venn diagram card titles with names and pronouns
            const cardMeTitle = document.querySelector('.card-me .card-title');
            const cardYouTitle = document.querySelector('.card-you .card-title');
            if (cardMeTitle) cardMeTitle.textContent = `${myName} (${myPronouns})`;
            if (cardYouTitle) cardYouTitle.textContent = `${partnerName} (${partnerPronouns})`;

            // Update attachment style badges
            updateAttachmentBadge('me', myAttachment, myAttachmentSecondary);
            updateAttachmentBadge('you', partnerAttachment, partnerAttachmentSecondary);
        }

        function updateAttachmentBadge(person, primaryStyle, secondaryStyle) {
            const badgeEl = document.getElementById(`attachment-badge-${person}`);
            if (!badgeEl || !primaryStyle) return;

            const attachmentLabels = {
                anxious: 'üîó Connection-Optimized',
                avoidant: 'üõ°Ô∏è Autonomy-Optimized',
                secure: '‚öñÔ∏è Balanced',
                fearful: 'üîÑ Mixed-Mode'
            };

            const attachmentShortLabels = {
                anxious: 'Connection',
                avoidant: 'Autonomy',
                secure: 'Balanced',
                fearful: 'Mixed-Mode'
            };

            // Remove all style classes
            badgeEl.classList.remove('anxious', 'avoidant', 'secure', 'fearful');

            // Add primary style class for color coding
            if (primaryStyle) {
                badgeEl.classList.add(primaryStyle);
            }

            // Build badge text
            let badgeText = attachmentLabels[primaryStyle] || '';
            if (secondaryStyle) {
                badgeText = `${attachmentShortLabels[primaryStyle]} / ${attachmentShortLabels[secondaryStyle]}`;
            }

            badgeEl.textContent = badgeText;
            badgeEl.style.display = primaryStyle ? 'block' : 'none';
        }

        function updateVennDiagram() {
            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';
            const myAttachmentSecondary = localStorage.getItem('myAttachmentSecondary') || '';
            const partnerAttachmentSecondary = localStorage.getItem('partnerAttachmentSecondary') || '';

            // Update Node A (me)
            const myData = getBlendedAttachmentData(myAttachment, myAttachmentSecondary);
            if (myData) {
                document.getElementById('venn-subtitle-me').textContent = myData.subtitle;
                const traitsMe = document.getElementById('venn-traits-me');
                traitsMe.innerHTML = myData.traits.map(trait => `<li>${trait}</li>`).join('');
                document.getElementById('venn-signals-me').textContent = myData.preferredSignals;
                document.getElementById('venn-target-me').textContent = myData.optimizationTarget;
            }

            // Update Node B (you)
            const partnerData = getBlendedAttachmentData(partnerAttachment, partnerAttachmentSecondary);
            if (partnerData) {
                document.getElementById('venn-subtitle-you').textContent = partnerData.subtitle;
                const traitsYou = document.getElementById('venn-traits-you');
                traitsYou.innerHTML = partnerData.traits.map(trait => `<li>${trait}</li>`).join('');
                document.getElementById('venn-signals-you').textContent = partnerData.preferredSignals;
                document.getElementById('venn-target-you').textContent = partnerData.optimizationTarget;
            }

            // Update Interface Layer (overlap) based on pairing
            const pairingKey = getPairingKey(myAttachment, partnerAttachment);
            const pairingData = attachmentPairingData[pairingKey];
            if (pairingData) {
                const overlapTraits = document.getElementById('venn-overlap-traits');
                let overlapTraitsList = [...pairingData.traits];

                // Add notes about secondary tendencies if present
                if (myAttachmentSecondary || partnerAttachmentSecondary) {
                    overlapTraitsList.push('Both partners show multi-faceted attachment patterns');
                    if (myAttachmentSecondary) {
                        const secondaryLabel = attachmentStyleData[myAttachmentSecondary].title;
                        overlapTraitsList.push(`Node A has ${secondaryLabel} tendencies during stress or specific triggers`);
                    }
                    if (partnerAttachmentSecondary) {
                        const secondaryLabel = attachmentStyleData[partnerAttachmentSecondary].title;
                        overlapTraitsList.push(`Node B has ${secondaryLabel} tendencies during stress or specific triggers`);
                    }
                }

                overlapTraits.innerHTML = overlapTraitsList.map(trait => `<li>${trait}</li>`).join('');
                document.getElementById('venn-overlap-protocols').textContent = pairingData.protocols;
            }
        }

        function getBlendedAttachmentData(primaryStyle, secondaryStyle) {
            if (!primaryStyle) return null;

            const primaryData = attachmentStyleData[primaryStyle];
            if (!secondaryStyle) {
                return {
                    subtitle: `${primaryData.title} ¬∑ ${primaryData.subtitle}`,
                    traits: primaryData.traits,
                    preferredSignals: primaryData.preferredSignals,
                    optimizationTarget: primaryData.optimizationTarget
                };
            }

            // Blend primary and secondary styles
            const secondaryData = attachmentStyleData[secondaryStyle];
            const blendedTraits = [
                primaryData.traits[0], // Lead with primary
                `Shows ${secondaryData.title.toLowerCase()} tendencies in stress or specific contexts`,
                primaryData.traits[1],
                secondaryData.traits[0] // Add key secondary trait
            ];

            return {
                subtitle: `${primaryData.title} (with ${secondaryData.title} tendencies)`,
                traits: blendedTraits,
                preferredSignals: `${primaryData.preferredSignals} (especially when ${secondaryStyle} needs activate)`,
                optimizationTarget: primaryData.optimizationTarget
            };
        }

        function getPairingKey(style1, style2) {
            // Normalize pairing keys to ensure consistent lookup
            // Order: anxious, avoidant, secure, fearful (alphabetically)
            const order = { anxious: 1, avoidant: 2, fearful: 3, secure: 4 };
            if (order[style1] <= order[style2]) {
                return `${style1}-${style2}`;
            } else {
                return `${style2}-${style1}`;
            }
        }

        function updateOptimizationProtocols() {
            const myAttachment = localStorage.getItem('myAttachment') || 'secure';
            const partnerAttachment = localStorage.getItem('partnerAttachment') || 'secure';

            // Get protocols for each attachment style
            const myProtocols = optimizationProtocols[myAttachment];
            const partnerProtocols = optimizationProtocols[partnerAttachment];

            if (!myProtocols || !partnerProtocols) return;

            // Update Node A optimizations (what I should do)
            const nodeAList = document.getElementById('protocol-node-a');
            if (nodeAList) {
                nodeAList.innerHTML = myProtocols.nodeOptimizations.map(item => `<li>${item}</li>`).join('');
            }

            // Update Node B optimizations (how to support partner)
            const nodeBList = document.getElementById('protocol-node-b');
            if (nodeBList) {
                nodeBList.innerHTML = partnerProtocols.partnerSupport.map(item => `<li>${item}</li>`).join('');
            }

            // Update System-Wide protocols (general best practices)
            const systemWideList = document.getElementById('protocol-system-wide');
            if (systemWideList) {
                const systemWideProtocols = [
                    '<strong>Use descriptive logging:</strong> "STATUS: feeling X" vs "ERROR: you always Y"',
                    '<strong>Implement graceful degradation:</strong> Temporary disconnects don\'t crash the system',
                    '<strong>Schedule health checks:</strong> Regular pings maintain connection stability',
                    '<strong>Recognize patterns:</strong> Both nodes have predictable behaviors under load'
                ];
                systemWideList.innerHTML = systemWideProtocols.map(item => `<li>${item}</li>`).join('');
            }
        }

        // Add pronoun select change handlers
        document.addEventListener('DOMContentLoaded', () => {
            const myPronounSelect = document.getElementById('my-pronoun-select');
            const partnerPronounSelect = document.getElementById('partner-pronoun-select');

            if (myPronounSelect) {
                myPronounSelect.addEventListener('change', (e) => {
                    const customInput = document.getElementById('my-custom-pronoun');
                    customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
            }

            if (partnerPronounSelect) {
                partnerPronounSelect.addEventListener('change', (e) => {
                    const customInput = document.getElementById('partner-custom-pronoun');
                    customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
            }
        });

        // ============ CONSISTENCY TRACKER ============
        function calculateConsistencyMetrics() {
            if (!currentIdentity) return;

            // Get partner's identity (opposite of current)
            const partnerIdentity = currentIdentity === 'me' ? 'you' : 'me';

            // Get partner's name for display
            const nodeAName = localStorage.getItem('myName') || 'Node A';
            const nodeBName = localStorage.getItem('partnerName') || 'Node B';
            const partnerName = partnerIdentity === 'me' ? nodeAName : nodeBName;

            // Update section title with partner's name
            const sectionTitle = document.querySelector('.monitoring-section-title');
            if (sectionTitle) {
                sectionTitle.textContent = `üìà ${partnerName}'s Emotional Consistency Score`;
            }

            // Get all entries for PARTNER, sorted by timestamp
            const partnerHistory = moodHistory
                .filter(h => h.person === partnerIdentity)
                .sort((a, b) => a.timestamp - b.timestamp);

            if (partnerHistory.length < 3) {
                document.getElementById('evidence-list').innerHTML = `<div class="evidence-loading">${partnerName} needs to log 3+ moods to generate consistency analysis...</div>`;
                return;
            }

            // Get last N entries (most recent)
            const lastThree = partnerHistory.slice(-3);
            const lastFive = partnerHistory.slice(-5);
            const lastSeven = partnerHistory.slice(-7);

            // Calculate stability percentages
            const regulated = ['good', 'calm', 'connected', 'playful', 'content', 'reconnect'];
            const dysregulated = ['anxious', 'overwhelmed', 'disconnected', 'shutdown'];

            // Last 3 entries stability
            const threeRegulated = lastThree.filter(m => regulated.includes(m.mood)).length;
            const threeStability = Math.round((threeRegulated / lastThree.length) * 100);

            // Last 5 entries stability
            const fiveRegulated = lastFive.filter(m => regulated.includes(m.mood)).length;
            const fiveStability = lastFive.length >= 5
                ? Math.round((fiveRegulated / lastFive.length) * 100)
                : null;

            // Last 7 entries stability
            const sevenRegulated = lastSeven.filter(m => regulated.includes(m.mood)).length;
            const sevenStability = lastSeven.length >= 7
                ? Math.round((sevenRegulated / lastSeven.length) * 100)
                : null;

            // Helper function to format entries list
            const formatEntries = (entries) => {
                return entries.map(e => {
                    const emoji = moodEmojis[e.mood] || 'üòê';
                    const date = new Date(e.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const isRegulated = regulated.includes(e.mood);
                    const color = isRegulated ? '#10b981' : '#ef4444';
                    return `<span style="color: ${color}; margin-right: 4px;" title="${e.mood} (${date})">${emoji}</span>`;
                }).join('');
            };

            // Update 3-entry metrics (always show if we have 3+)
            document.getElementById('stability-3day').textContent = threeStability + '%';
            document.getElementById('stability-3day-bar').style.width = threeStability + '%';
            document.getElementById('stability-3day-bar').style.background = threeStability >= 60 ? '#10b981' : threeStability >= 40 ? '#f59e0b' : '#ef4444';
            document.getElementById('entries-3day').innerHTML = formatEntries(lastThree);

            // Update 5-entry metrics (need at least 5 entries)
            if (fiveStability !== null) {
                document.getElementById('stability-5day').textContent = fiveStability + '%';
                document.getElementById('stability-5day-bar').style.width = fiveStability + '%';
                document.getElementById('stability-5day-bar').style.background = fiveStability >= 60 ? '#10b981' : fiveStability >= 40 ? '#f59e0b' : '#ef4444';
                document.getElementById('entries-5day').innerHTML = formatEntries(lastFive);
            } else {
                document.getElementById('stability-5day').textContent = 'Need 5+ entries';
                document.getElementById('stability-5day-bar').style.width = '0%';
                document.getElementById('entries-5day').innerHTML = '';
            }

            // Update 7-entry metrics (need at least 7 entries)
            if (sevenStability !== null) {
                document.getElementById('stability-7day').textContent = sevenStability + '%';
                document.getElementById('stability-7day-bar').style.width = sevenStability + '%';
                document.getElementById('stability-7day-bar').style.background = sevenStability >= 60 ? '#10b981' : sevenStability >= 40 ? '#f59e0b' : '#ef4444';
                document.getElementById('entries-7day').innerHTML = formatEntries(lastSeven);
            } else {
                document.getElementById('stability-7day').textContent = 'Need 7+ entries';
                document.getElementById('stability-7day-bar').style.width = '0%';
                document.getElementById('entries-7day').innerHTML = '';
            }

            // Generate evidence list
            const evidence = [];

            // Show stability achievements (only if we have enough data)
            if (sevenStability !== null && sevenStability >= 60) {
                evidence.push(`‚úÖ Last 7 entries: ${sevenStability}% regulated`);
            }

            // Show trend improvements (only if we have enough data for both periods)
            if (fiveStability !== null) {
                if (threeStability > fiveStability) {
                    const improvement = threeStability - fiveStability;
                    evidence.push(`üìà Improving: Last 3 entries ${improvement}% more stable than last 5`);
                }
            }

            // Check for streaks in last 7 entries
            let currentStreak = 0;
            let maxStreak = 0;
            for (let i = lastSeven.length - 1; i >= 0; i--) {
                if (regulated.includes(lastSeven[i].mood)) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }

            if (maxStreak >= 3) {
                evidence.push(`üî• Longest streak: ${maxStreak} consecutive regulated entries`);
            }

            // Check for reduced protest behavior (for anxious partner)
            const partnerAttachment = partnerIdentity === 'me'
                ? localStorage.getItem('myAttachment') || 'anxious'
                : localStorage.getItem('partnerAttachment') || 'avoidant';

            if (partnerAttachment === 'anxious' && sevenStability !== null) {
                const anxiousCount = lastSeven.filter(m => m.mood === 'anxious').length;
                if (anxiousCount <= 2) {
                    evidence.push(`üéØ Low activation: Only ${anxiousCount} anxious entries in last 7`);
                }

                // Check if they're logging when calm (not just when distressed)
                const calmLogs = lastSeven.filter(m => regulated.includes(m.mood)).length;
                if (calmLogs >= lastSeven.length * 0.5) {
                    evidence.push(`üìä Balanced logging: Recording calm states, not just distress (${calmLogs}/${lastSeven.length})`);
                }
            }

            // Show quick wins (3-entry improvements)
            if (threeStability >= 70) {
                evidence.push(`‚ö° Strong recent performance: ${threeStability}% stable in last 3 entries`);
            }

            // Render evidence
            if (evidence.length > 0) {
                const html = evidence.map(e => `<div class="evidence-item">${e}</div>`).join('');
                document.getElementById('evidence-list').innerHTML = html;
            } else {
                document.getElementById('evidence-list').innerHTML = '<div class="evidence-loading">Continue logging to build evidence of progress...</div>';
            }
        }

        // ============ GROWTH CHECKLIST SIDEBAR ============
        function toggleGrowthSidebar() {
            const sidebar = document.getElementById('growth-sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function generateGrowthChecklist() {
            const checklist = document.getElementById('growth-checklist');
            const titleEl = document.getElementById('growth-sidebar-title');
            const subtitleEl = document.getElementById('growth-sidebar-subtitle');

            if (!currentIdentity) {
                titleEl.textContent = 'üéØ Active Growth Tasks';
                subtitleEl.textContent = 'Select your identity to see personalized tasks';
                checklist.innerHTML = '<div class="growth-loading">Select your identity (Node A or Node B) to begin...</div>';
                return;
            }

            if (moodHistory.length < 2) {
                const nodeName = currentIdentity === 'me' ? 'Node A' : 'Node B';
                titleEl.textContent = `üéØ ${nodeName} Growth Tasks`;
                subtitleEl.textContent = 'Log more moods to enable analysis';
                checklist.innerHTML = '<div class="growth-loading">// Log more moods to enable personalized growth tasks</div>';
                return;
            }

            const myAttachment = currentIdentity === 'me'
                ? localStorage.getItem('myAttachment') || 'anxious'
                : localStorage.getItem('partnerAttachment') || 'avoidant';

            const partnerAttachment = currentIdentity === 'me'
                ? localStorage.getItem('partnerAttachment') || 'avoidant'
                : localStorage.getItem('myAttachment') || 'anxious';

            // Update title and subtitle to show which node
            const nodeName = currentIdentity === 'me' ? 'Node A' : 'Node B';
            const attachmentLabel = {
                anxious: 'Connection-Optimized',
                avoidant: 'Autonomy-Optimized',
                secure: 'Balanced',
                fearful: 'Mixed-Mode'
            };
            titleEl.textContent = `üéØ ${nodeName} Growth Tasks`;
            subtitleEl.textContent = `${attachmentLabel[myAttachment]} ‚Ä¢ Auto-updated based on patterns`;

            const tasks = [];

            // Get recent mood data
            const recentHistory = moodHistory.slice(-10);
            const myRecentMoods = recentHistory.filter(h => h.person === currentIdentity);
            const partnerRecentMoods = recentHistory.filter(h => h.person !== currentIdentity);

            const myLatestMood = myRecentMoods[myRecentMoods.length - 1]?.mood;
            const partnerLatestMood = partnerRecentMoods[partnerRecentMoods.length - 1]?.mood;

            // Count patterns in last 7 days
            const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const weekHistory = moodHistory.filter(h => h.timestamp > weekAgo);
            const myWeekMoods = weekHistory.filter(h => h.person === currentIdentity);
            const anxiousCount = myWeekMoods.filter(m => m.mood === 'anxious').length;
            const disconnectedCount = myWeekMoods.filter(m => m.mood === 'disconnected').length;
            const calmCount = myWeekMoods.filter(m => m.mood === 'calm' || m.mood === 'good').length;

            // ATTACHMENT-SPECIFIC GROWTH TASKS
            if (myAttachment === 'anxious') {
                if (anxiousCount >= 3) {
                    tasks.push({
                        text: 'Practice self-soothing before reaching out to partner',
                        priority: 'high',
                        category: 'regulation'
                    });
                }
                if (partnerLatestMood === 'shutdown' || partnerLatestMood === 'withdrawn') {
                    tasks.push({
                        text: 'Resist protest behavior - partner needs buffer time',
                        priority: 'high',
                        category: 'pattern-interrupt'
                    });
                }
                tasks.push({
                    text: 'Trust async processing ‚â† dropped connection',
                    priority: 'medium',
                    category: 'core-belief'
                });
            }

            if (myAttachment === 'avoidant') {
                if (partnerLatestMood === 'anxious' || partnerLatestMood === 'disconnected') {
                    tasks.push({
                        text: 'Send low-pressure connection signal (partner showing anxiety)',
                        priority: 'high',
                        category: 'repair'
                    });
                }
                if (myLatestMood === 'withdrawn' || myLatestMood === 'shutdown') {
                    tasks.push({
                        text: 'Signal buffer time needs ("need 2h, will reconnect")',
                        priority: 'high',
                        category: 'communication'
                    });
                }
                tasks.push({
                    text: 'Connection ‚â† loss of autonomy',
                    priority: 'medium',
                    category: 'core-belief'
                });
            }

            // REPAIR WINDOW DETECTION
            const regulated = ['good', 'calm', 'connected', 'playful', 'content'];
            const bothCalm = regulated.includes(myLatestMood) && regulated.includes(partnerLatestMood);

            if (bothCalm) {
                tasks.push({
                    text: 'Initiate repair conversation (optimal window - both calm)',
                    priority: 'high',
                    category: 'repair'
                });
            }

            // DYSREGULATION TASKS
            const dysregulated = ['anxious', 'overwhelmed', 'disconnected', 'shutdown'];
            if (dysregulated.includes(myLatestMood)) {
                tasks.push({
                    text: 'Regulate nervous system before engaging (breathwork, movement)',
                    priority: 'high',
                    category: 'regulation'
                });
            }

            // PATTERN-BASED TASKS
            if (anxiousCount + disconnectedCount >= 5) {
                tasks.push({
                    text: 'Review what triggers activation - track patterns',
                    priority: 'medium',
                    category: 'awareness'
                });
            }

            if (calmCount >= 3 && partnerRecentMoods.length > 0) {
                tasks.push({
                    text: 'Acknowledge progress - system showing stability',
                    priority: 'low',
                    category: 'celebration'
                });
            }

            // GENERAL GROWTH TASKS
            if (myAttachment === 'anxious' && partnerAttachment === 'avoidant') {
                tasks.push({
                    text: 'Remember: pursuit-distance is expected - not personal',
                    priority: 'medium',
                    category: 'framework'
                });
            }

            // Sort by priority
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            tasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            // Render checklist
            if (tasks.length === 0) {
                checklist.innerHTML = '<div class="growth-loading">‚úÖ System stable - continue current protocols</div>';
                return;
            }

            const html = tasks.map((task, i) => `
                <label class="growth-task ${task.priority}">
                    <input type="checkbox" onclick="markGrowthTask(${i})">
                    <span class="growth-task-text">${task.text}</span>
                    <span class="growth-task-badge">${task.category}</span>
                </label>
            `).join('');

            checklist.innerHTML = html;
        }

        function markGrowthTask(index) {
            // Just visual feedback - no persistence needed
            console.log('Growth task acknowledged:', index);
        }

        // Initialize
        init();
    </script>

    <!-- Footer -->
    <footer style="width: 100%; max-width: 920px; text-align: center; padding: 40px 20px 20px; margin-top: 40px; border-top: 1px solid rgba(0,0,0,0.06);">
        <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">
            Made with üíï for better understanding between partners
        </p>
        <a href="https://github.com/hereshecodes/attachment_workbook.io" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); text-decoration: none; color: #4a4a5a; font-size: 0.8rem; transition: all 0.2s;">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            View on GitHub
        </a>
    </footer>
</body>
</html>